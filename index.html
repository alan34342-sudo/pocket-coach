<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pocket Coach v18.3</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pocket Coach">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#ffffff">

    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%232563EB'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='300' fill='white'%3EğŸ¤–%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%232563EB'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='300' fill='white'%3EğŸ¤–%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å„ªåŒ– AI å›è¦†çš„ Markdown æ¨£å¼ */
        .ai-content h3 { font-weight: 800; margin-top: 0.5em; margin-bottom: 0.2em; color: #1e40af; }
        .ai-content strong { color: #1f2937; font-weight: 700; }
        .ai-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .ai-content li { margin-bottom: 0.2em; }
        .ai-content p { margin-bottom: 0.5em; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        /* éš±è—åŸç”Ÿæª”æ¡ˆè¼¸å…¥æ¡† */
        .hidden-input { display: none; }
    </style>
    <script>
        // --- UI Helpers ---
        const setText = (id, text) => { const el = document.getElementById(id); if(el) el.textContent = text; };
        const setHTML = (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; };
        const setValue = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };

        // --- æœ¬åœ°è³‡æ–™åº« (Local Storage Wrapper) ---
        const DB = {
            get: (key, defaultVal) => {
                const data = localStorage.getItem(`pocket_coach_${key}`);
                return data ? JSON.parse(data) : defaultVal;
            },
            set: (key, val) => {
                localStorage.setItem(`pocket_coach_${key}`, JSON.stringify(val));
            }
        };

        // --- å…¨åŸŸè®Šæ•¸ ---
        let USER_API_KEY = ""; 
        let ACTIVE_MODEL = "gemini-1.5-flash";
        
        const getLocalDate = () => {
            const d = new Date();
            return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        };

        let currentDate = getLocalDate();
        let currentViewMonth = new Date(); 
        let selectedImageBase64 = null; 
        let window_pendingLog = {};

        // Data Models
        let accounts = [];
        let monthlyIncome = { salary: 0, bonus: 0, overtime: 0, oncall: 0 };
        let fixedExpenses = [];
        let investments = []; 
        let dailyLogs = [];
        let userProfile = { height: 172, weight: 69, age: 30, gender: 'male', tdee: 2000, targetKcal: 1500, entRatio: 20 };

        // Defaults
        const defaultAccountsList = ['åœ‹æ³°', 'éƒµå±€', 'BANK', 'åˆåº«', 'ç‰å±±', 'è¯é‚¦'];
        const defaultFixedList = [
            {name: 'é£Ÿç‰©', note: 'åœ‹æ³°', amount: 8000, id: 1}, 
            {name: 'ç”Ÿæ´»ç”¨å“', note: 'åˆåº«', amount: 1000, id: 2},
            {name: 'é›»è©±è²»', note: 'åˆåº«', amount: 500, id: 3},
            {name: 'å£½éšª', note: 'éƒµå±€', amount: 3000, id: 4},
            {name: 'ç­†é›»', note: 'è¯é‚¦', amount: 0, id: 5},
            {name: 'ä¿éšª', note: 'åœ‹æ³°', amount: 0, id: 6},
            {name: 'æ©Ÿè»Š', note: 'åˆåº«', amount: 0, id: 7},
            {name: 'é›»è²»', note: 'bank', amount: 0, id: 8}
        ];
        
        const categoryIcons = {
            'é£Ÿç‰©': 'ğŸ±', 'é¤è²»': 'ğŸ±', 
            'ç”Ÿæ´»ç”¨å“': 'ğŸ§»', 'é›»è©±è²»': 'ğŸ“', 'äº¤é€š': 'ğŸ›µ', 'äº¤é€š/æ©Ÿè»Š': 'ğŸ›µ',
            'å¨›æ¨‚': 'ğŸ¬', 'æŠ•è³‡': 'ğŸ”¥', 'é‹å‹•': 'ğŸ’ª', 'ä¿éšª': 'ğŸ¥', 'ä¿éšª/é†«ç™‚': 'ğŸ¥', 
            'å…¶ä»–': 'ğŸ“', 'é›»è²»': 'âš¡', 'å£½éšª': 'ğŸ¥', 'ç­†é›»': 'ğŸ’»', 'æ©Ÿè»Š': 'ğŸ›µ'
        };

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            switchTab('dashboard');
        });

        const loadData = () => {
            USER_API_KEY = localStorage.getItem('gemini_api_key') || "";
            ACTIVE_MODEL = localStorage.getItem('gemini_model') || "gemini-1.5-flash";
            
            userProfile = DB.get('profile', userProfile);
            if(!userProfile.age) userProfile.age = 30;
            if(!userProfile.gender) userProfile.gender = 'male';

            const savedAcc = DB.get('accounts', null);
            accounts = savedAcc ? savedAcc : defaultAccountsList.map(name => ({name, balance: 0}));
            monthlyIncome = DB.get('income', monthlyIncome);
            const savedFix = DB.get('fixed', null);
            fixedExpenses = savedFix ? savedFix : defaultFixedList;
            investments = DB.get('investments', []);
            dailyLogs = DB.get('logs', []);

            const apiKeyInput = document.getElementById('setting-api-key');
            if (apiKeyInput) apiKeyInput.value = USER_API_KEY;
            
            const modelSelect = document.getElementById('setting-model');
            if (modelSelect) {
                const defaultModels = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-2.0-flash-exp'];
                if (defaultModels.includes(ACTIVE_MODEL)) {
                    modelSelect.value = ACTIVE_MODEL;
                } else {
                    modelSelect.value = 'custom';
                    document.getElementById('setting-model-custom').classList.remove('hidden');
                    document.getElementById('setting-model-custom').value = ACTIVE_MODEL;
                }
            }
            refreshUI(); 
        };

        const saveData = () => {
            DB.set('accounts', accounts);
            DB.set('income', monthlyIncome);
            DB.set('fixed', fixedExpenses);
            DB.set('profile', userProfile);
            DB.set('investments', investments);
            DB.set('logs', dailyLogs);
            refreshUI();
        };

        // --- æ ¸å¿ƒè¨ˆç®— ---
        const calculateTDEE = (w, h, age, gender) => {
            const s = gender === 'male' ? 5 : -161;
            const bmr = (10 * w) + (6.25 * h) - (5 * age) + s;
            const tdee = Math.round(bmr * 1.375); 
            return { tdee, target: tdee - 500 };
        };

        window.updateInvFromEnt = (val) => { let ent = parseInt(val) || 0; if (ent > 100) ent = 100; if (ent < 0) ent = 0; document.getElementById('ratio-inv').value = 100 - ent; };
        window.updateEntFromInv = (val) => { let inv = parseInt(val) || 0; if (inv > 100) inv = 100; if (inv < 0) inv = 0; document.getElementById('ratio-ent').value = 100 - inv; };

        window.updateSettings = () => {
            const h = parseInt(document.getElementById('prof-height').value)||172;
            const w = parseInt(document.getElementById('prof-weight').value)||69;
            const age = parseInt(document.getElementById('prof-age').value)||30;
            const gender = document.getElementById('prof-gender').value;
            const entR = parseInt(document.getElementById('ratio-ent').value)||20;
            
            const res = calculateTDEE(w, h, age, gender);
            userProfile = { ...userProfile, height: h, weight: w, age: age, gender: gender, tdee: res.tdee, targetKcal: res.target, entRatio: entR };
            saveData();
            showToast('è¨­å®šå·²æ›´æ–° (TDEEå·²é‡ç®—)', 'success');
        };

        window.saveSystemConfig = () => {
            const key = document.getElementById('setting-api-key').value.trim();
            const modelSelect = document.getElementById('setting-model');
            const customInput = document.getElementById('setting-model-custom');
            let model = modelSelect.value;
            if (model === 'custom') model = customInput.value.trim();
            USER_API_KEY = key;
            ACTIVE_MODEL = model;
            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('gemini_model', model);
            showToast('è¨­å®šå·²å„²å­˜', 'success');
        };

        window.handleModelChange = (val) => {
            const customInput = document.getElementById('setting-model-custom');
            if(val === 'custom') customInput.classList.remove('hidden');
            else customInput.classList.add('hidden');
        };

        window.exportData = () => {
            const data = { accounts, monthlyIncome, fixedExpenses, investments, dailyLogs, userProfile };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pocket_coach_backup_${currentDate}.json`;
            a.click();
        };

        window.importData = () => {
            const jsonStr = document.getElementById('import-json').value.trim();
            if (!jsonStr) return showToast("è«‹è²¼ä¸Šå‚™ä»½è³‡æ–™", "error");
            
            try {
                const data = JSON.parse(jsonStr);
                
                if (Array.isArray(data)) {
                    if(confirm("âš ï¸ ç³»çµ±åµæ¸¬åˆ°é€™ä¼¼ä¹æ˜¯å–®ç´”çš„ã€è¨˜å¸³ç´€éŒ„é™£åˆ—ã€ã€‚\n\næ˜¯å¦å°‡å…¶ä½œç‚ºã€è¨˜å¸³ç´€éŒ„ã€åŒ¯å…¥ä¸¦è¦†è“‹ç¾æœ‰ç´€éŒ„ï¼Ÿ")) {
                        DB.set('logs', data);
                        alert("ç´€éŒ„åŒ¯å…¥æˆåŠŸï¼é é¢å°‡è‡ªå‹•é‡æ–°æ•´ç†ã€‚");
                        location.reload();
                        return;
                    }
                    return;
                }

                if (!data.accounts && !data.monthlyIncome && !data.fixedExpenses && !data.dailyLogs) {
                    throw new Error("æ ¼å¼ç„¡æ³•è¾¨è­˜ (æ‰¾ä¸åˆ° accounts, dailyLogs ç­‰é—œéµæ¬„ä½)");
                }

                if (confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒè¦†è“‹æ‚¨ç›®å‰ã€æ‰€æœ‰çš„ã€è¨­å®šèˆ‡ç´€éŒ„ï¼\n\nç¢ºå®šè¦åŒ¯å…¥å—ï¼Ÿ")) {
                    if(data.accounts) DB.set('accounts', data.accounts);
                    if(data.monthlyIncome) DB.set('income', data.monthlyIncome);
                    if(data.fixedExpenses) DB.set('fixed', data.fixedExpenses);
                    if(data.investments) DB.set('investments', data.investments);
                    if(data.dailyLogs) DB.set('logs', data.dailyLogs);
                    if(data.userProfile) DB.set('profile', data.userProfile);
                    
                    alert("è³‡æ–™é‚„åŸæˆåŠŸï¼é é¢å°‡è‡ªå‹•é‡æ–°æ•´ç†ã€‚");
                    location.reload();
                }
            } catch (e) {
                alert("åŒ¯å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤ã€‚\nè«‹ç¢ºèªæ‚¨è²¼ä¸Šçš„æ˜¯æ­£ç¢ºçš„ JSON æ ¼å¼ã€‚\néŒ¯èª¤è¨Šæ¯ï¼š" + e.message);
            }
        };
        
        window.fetchGoogleModels = async () => {
            const apiKey = document.getElementById('setting-api-key').value.trim() || USER_API_KEY;
            if (!apiKey) return showToast("è«‹å…ˆè¼¸å…¥ API Key", "error");
            const btn = document.querySelector('button[onclick="fetchGoogleModels()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³'; btn.disabled = true;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (!response.ok) throw new Error("æŠ“å–å¤±æ•—");
                const data = await response.json();
                const chatModels = (data.models || []).filter(m => m.supportedGenerationMethods.includes("generateContent") && m.name.includes("gemini")).map(m => m.name.replace('models/', '')).sort((a, b) => b.localeCompare(a));
                const select = document.getElementById('setting-model');
                select.innerHTML = '';
                chatModels.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; select.appendChild(opt); });
                const customOpt = document.createElement('option'); customOpt.value = 'custom'; customOpt.textContent = 'âœï¸ æ‰‹å‹•è¼¸å…¥...'; select.appendChild(customOpt);
                showToast(`å·²æ›´æ–° ${chatModels.length} å€‹æ¨¡å‹`, "success");
            } catch (e) { showToast(`æ›´æ–°å¤±æ•—: ${e.message}`, "error"); } 
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        };

        const parseMarkdown = (text) => {
            if (!text) return '';
            let html = text.replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/^## (.*$)/gim, '<h3>$1</h3>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/^\* (.*$)/gim, '<ul><li>$1</li></ul>').replace(/^- (.*$)/gim, '<ul><li>$1</li></ul>').replace(/\n/g, '<br>');
            html = html.replace(/<\/ul><br><ul>/g, '');
            return `<div class="ai-content text-gray-700 leading-relaxed">${html}</div>`;
        };
        
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const callAI = async (prompt, imgBase64 = null) => {
            if(!USER_API_KEY) return { error: "è«‹å…ˆåœ¨ [è¨­å®š] è¼¸å…¥ API Key" };
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${ACTIVE_MODEL}:generateContent?key=${USER_API_KEY}`;
            const parts = [{text: prompt}];
            if (imgBase64) parts.push({ inlineData: { mimeType: "image/jpeg", data: imgBase64 } });
            const payload = {contents:[{parts: parts}]};
            let retries = 0; const maxRetries = 2; let delay = 1000;
            while (retries <= maxRetries) {
                try {
                    const r = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    if (r.status === 429 || r.status === 503) { await wait(delay); retries++; delay *= 2; continue; }
                    if (r.status === 404 && ACTIVE_MODEL !== "gemini-1.5-flash") { ACTIVE_MODEL = "gemini-1.5-flash"; return callAI(prompt, imgBase64); }
                    if (!r.ok) throw new Error(`API Error (${r.status})`);
                    const json = await r.json();
                    const txt = json.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!txt) throw new Error("Empty Response");
                    if (prompt.includes('JSON')) { const jsonMatch = txt.match(/\{[\s\S]*\}/); return jsonMatch ? JSON.parse(jsonMatch[0]) : {kcal:0, protein:0, burned:0}; }
                    return txt;
                } catch (e) { if (retries === maxRetries) { const isJson = prompt.includes('JSON'); if(isJson) return { error: e.message }; return `[ç³»çµ±éŒ¯èª¤] ${e.message}`; } await wait(delay); retries++; delay *= 2; }
            }
        };

        // --- Log & Action ---
        window.handleUnifiedLog = async () => {
            const description = document.getElementById('log-description').value;
            const amount = parseInt(document.getElementById('log-amount').value)||0;
            const category = document.getElementById('log-category').value;
            let card = document.getElementById('log-card').value;

            // NEW: å–å¾—æ‰‹å‹•è¼¸å…¥çš„å€¼
            const manualKcal = document.getElementById('log-manual-kcal').value;
            const manualProtein = document.getElementById('log-manual-protein').value;
            
            if(card==='custom') {
                card = document.getElementById('finance-card-custom').value;
                if(!accounts.find(a=>a.name===card)) { accounts.push({name:card, balance:0}); saveData(); }
            }

            if(!description) return showToast('è«‹è¼¸å…¥æè¿°', 'error');
            const btn = document.getElementById('unified-log-btn');
            btn.disabled = true; btn.textContent = 'AI é‹ç®—ä¸­...';

            try {
                if(category === 'é£Ÿç‰©' || category === 'é¤è²»') {
                    // NEW: å¦‚æœæœ‰æ‰‹å‹•è¼¸å…¥ï¼Œç›´æ¥ä½¿ç”¨ï¼Œä¸å‘¼å« AI åˆ†æç‡Ÿé¤Š
                    if (manualKcal || manualProtein) {
                         const manualData = {
                             kcal: parseInt(manualKcal) || 0,
                             protein: parseInt(manualProtein) || 0
                         };
                         commitLog({ description, amount, category, card, type: 'finance_health', ...manualData });
                         showToast('è¨˜å¸³æˆåŠŸ (æ‰‹å‹•ç‡Ÿé¤Š)', 'success');
                         resetLogForm();
                    } else {
                        // åŸæœ¬çš„ AI æµç¨‹
                        const res = await callAI(`åˆ†æé£Ÿç‰©ç‡Ÿé¤Š:${description}ã€‚è«‹åªå›å‚³JSONæ ¼å¼: {"kcal": æ•¸å­—, "protein": æ•¸å­—}ã€‚`, selectedImageBase64);
                        if(res.error) throw new Error(res.error);
                        window.pendingLog = { description, amount, category, card, type: 'finance_health' };
                        setupVerifyModal('food', res);
                    }
                } 
                else if (category === 'é‹å‹•') {
                    // NEW: é‹å‹•ä¹Ÿæœ‰æ‰‹å‹•è¼¸å…¥
                    if (manualKcal) { // é€™è£¡çš„ manualKcal å°æ‡‰åˆ°é‹å‹•æ˜¯ "Burned"
                         const manualData = { burned: parseInt(manualKcal) || 0 };
                         commitLog({ description, amount: 0, category, card: '', type: 'exercise', ...manualData });
                         showToast('ç´€éŒ„æˆåŠŸ (æ‰‹å‹•æ¶ˆè€—)', 'success');
                         resetLogForm();
                    } else {
                        // NEW PROMPT: å¢åŠ é è¨­ 30 åˆ†é˜çš„æŒ‡ç¤º
                        const res = await callAI(`åˆ†æé‹å‹•æ¶ˆè€—:${description}ã€‚ä½¿ç”¨è€…${userProfile.weight}å…¬æ–¤ã€‚è‹¥æœªæŒ‡å®šæ™‚é–“ï¼Œè«‹é è¨­ç‚º30åˆ†é˜ã€‚è«‹åªå›å‚³JSONæ ¼å¼: {"burned": æ•¸å­—}ã€‚`);
                        if(res.error) throw new Error(res.error);
                        window.pendingLog = { description, amount: 0, category, card: '', type: 'exercise' };
                        setupVerifyModal('exercise', res);
                    }
                } 
                else {
                    commitLog({ description, amount, category, card, type: 'finance' });
                    showToast('è¨˜å¸³æˆåŠŸ', 'success');
                    resetLogForm();
                }
            } catch(e) { 
                showToast(`AI éŒ¯èª¤: ${e.message||'æœªçŸ¥'}`, 'error');
                if(category === 'é£Ÿç‰©' || category === 'é¤è²»') { window.pendingLog = { description, amount, category, card, type: 'finance_health' }; setupVerifyModal('food', {kcal:0, protein:0}); }
                else if(category === 'é‹å‹•') { window.pendingLog = { description, amount: 0, category, card: '', type: 'exercise' }; setupVerifyModal('exercise', {burned:0}); }
                else {
                    commitLog({ description, amount, category, card, type: 'finance' });
                    showToast('è¨˜å¸³æˆåŠŸ (é›¢ç·š)', 'success');
                    resetLogForm();
                }
            } 
            finally { btn.disabled=false; btn.textContent = category==='é‹å‹•' ? 'ğŸ”¥ è¨˜éŒ„' : 'ğŸ’° è¨˜éŒ„'; }
        };

        const setupVerifyModal = (mode, data) => {
            const modalTitle = document.getElementById('verify-title');
            const container = document.getElementById('verify-inputs');
            if (mode === 'food') {
                modalTitle.textContent = 'ç¢ºèªç‡Ÿé¤Šæ”å–';
                container.innerHTML = `<div class="flex gap-2 mb-2"><div class="flex-1"><label class="text-xs text-red-500 font-bold">ç†±é‡ (Kcal)</label><input id="verify-kcal" type="number" value="${data.kcal||0}" class="w-full border-2 border-red-100 p-2 rounded text-xl font-black text-center text-red-600"></div><div class="flex-1"><label class="text-xs text-green-500 font-bold">è›‹ç™½è³ª (g)</label><input id="verify-protein" type="number" value="${data.protein||0}" class="w-full border-2 border-green-100 p-2 rounded text-xl font-black text-center text-green-600"></div></div>`;
            } else {
                modalTitle.textContent = 'ç¢ºèªé‹å‹•æ¶ˆè€—';
                container.innerHTML = `<div class="mb-2"><label class="text-xs text-orange-500 font-bold">æ¶ˆè€—ç†±é‡ (Kcal)</label><input id="verify-burned" type="number" value="${data.burned||0}" class="w-full border-2 border-orange-100 p-2 rounded text-xl font-black text-center text-orange-600"></div>`;
            }
            document.getElementById('verify-modal').classList.remove('hidden');
        };

        window.confirmVerifyLog = async () => {
            const mode = window.pendingLog.type;
            let extraData = {};
            if (mode === 'finance_health') { extraData.kcal = parseInt(document.getElementById('verify-kcal').value) || 0; extraData.protein = parseInt(document.getElementById('verify-protein').value) || 0; } 
            else if (mode === 'exercise') { extraData.burned = parseInt(document.getElementById('verify-burned').value) || 0; }
            commitLog({ ...window.pendingLog, ...extraData });
            closeModal('verify');
            showToast('ç´€éŒ„å®Œæˆ', 'success');
            resetLogForm();
        };

        const commitLog = (d) => {
            const logDateStr = currentDate; 
            const logData = { id: Date.now().toString(), timestamp: new Date().toISOString(), dateStr: logDateStr, description: d.description, amount: d.amount, category: d.category, card: d.card, type: d.type, kcal: d.kcal || 0, protein: d.protein || 0, burned: d.burned || 0 };
            dailyLogs.unshift(logData);
            if(d.amount > 0 && d.card) {
                const idx = accounts.findIndex(a=>a.name===d.card);
                if(idx!==-1) accounts[idx].balance -= d.amount;
            }
            saveData();
        };

        window.deleteLog = (id) => {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ\n(é‡‘é¡å°‡è‡ªå‹•é€€å›å¸³æˆ¶)")) return;
            const logIdx = dailyLogs.findIndex(l => l.id === id);
            if(logIdx === -1) return;
            const log = dailyLogs[logIdx];

            if (log.amount > 0 && log.card) {
                const accIdx = accounts.findIndex(a => a.name === log.card);
                if(accIdx !== -1) accounts[accIdx].balance += log.amount;
            }

            dailyLogs.splice(logIdx, 1);
            saveData();
            showToast('ç´€éŒ„å·²åˆªé™¤ä¸¦é€€æ¬¾', 'success');
        }

        const resetLogForm = () => {
            document.getElementById('log-description').value = '';
            document.getElementById('log-amount').value = '';
            // æ¸…ç©ºæ‰‹å‹•è¼¸å…¥
            document.getElementById('log-manual-kcal').value = '';
            document.getElementById('log-manual-protein').value = '';
            
            // æ ¹æ“šç•¶å‰é¡åˆ¥é‡ç½®æ‰‹å‹•è¼¸å…¥å€å¡Š
            const currentCat = document.getElementById('log-category').value;
            changeLogCategory(currentCat);

            setHTML('image-preview', '');
            selectedImageBase64 = null;
        };

        // NEW: å£“ç¸®åœ–ç‰‡åŠŸèƒ½ (é˜²ç•¶æ©Ÿ)
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const maxWidth = 1024; // é™åˆ¶æœ€å¤§å¯¬åº¦
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // è¼¸å‡ºå£“ç¸®å¾Œçš„ Base64 (image/jpeg, quality 0.7)
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(compressedDataUrl);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        window.handleImageUpload = async (e) => {
            const f = e.target.files[0];
            if(f) { 
                showToast("æ­£åœ¨å£“ç¸®åœ–ç‰‡...", "info");
                try {
                    const compressedDataUrl = await compressImage(f);
                    selectedImageBase64 = compressedDataUrl.split(',')[1]; 
                    setHTML('image-preview', `<img src="${compressedDataUrl}" class="h-16 rounded object-cover shadow-sm border border-gray-200">`); 
                    showToast("åœ–ç‰‡å·²è™•ç†", "success");
                    closeModal('camera-choice'); // é—œé–‰é¸æ“‡å½ˆçª—
                } catch(err) {
                    showToast("åœ–ç‰‡è™•ç†å¤±æ•—", "error");
                    console.error(err);
                }
            }
        };

        // NEW: ç›¸æ©Ÿé¸æ“‡é‚è¼¯
        window.openCameraModal = () => {
            document.getElementById('camera-choice-modal').classList.remove('hidden');
        }

        window.triggerCamera = () => {
            document.getElementById('input-camera').click();
        }

        window.triggerGallery = () => {
            document.getElementById('input-gallery').click();
        }
        
        // NEW: åˆ‡æ›æ‰‹å‹•è¼¸å…¥æ¬„ä½ (æ”¹é€²ç‰ˆï¼šæ”¯æ´ 'food' å’Œ 'exercise' æ¨¡å¼)
        window.toggleManualInput = (mode) => {
            const block = document.getElementById('manual-nutrition-block');
            const kcalContainer = document.getElementById('manual-kcal-container');
            const proteinContainer = document.getElementById('manual-protein-container');
            const kcalInput = document.getElementById('log-manual-kcal');
            const kcalLabel = document.getElementById('manual-kcal-label');
            const hint = document.getElementById('manual-hint-text');

            if (mode === 'none') {
                block.classList.add('hidden');
            } else {
                block.classList.remove('hidden');
                if (mode === 'food') {
                    hint.textContent = 'âœï¸ æ‰‹å‹•è¼¸å…¥ç‡Ÿé¤Š (è‹¥å¡«å¯«å°‡ä¸ä½¿ç”¨AIä¼°ç®—)';
                    kcalLabel.textContent = 'ğŸ”¥';
                    kcalInput.placeholder = 'ç†±é‡';
                    kcalContainer.classList.remove('w-full');
                    kcalContainer.classList.add('flex-1'); // æ¢å¾©ä¸€åŠå¯¬åº¦
                    proteinContainer.classList.remove('hidden'); // é¡¯ç¤ºè›‹ç™½
                } else if (mode === 'exercise') {
                    hint.textContent = 'âœï¸ æ‰‹å‹•è¼¸å…¥æ¶ˆè€— (è‹¥å¡«å¯«å°‡ä¸ä½¿ç”¨AIä¼°ç®—)';
                    kcalLabel.textContent = 'ğŸƒ';
                    kcalInput.placeholder = 'æ¶ˆè€—ç†±é‡ (Kcal)';
                    kcalContainer.classList.remove('flex-1'); 
                    kcalContainer.classList.add('w-full'); // ä½”æ»¿æ•´è¡Œ
                    proteinContainer.classList.add('hidden'); // éš±è—è›‹ç™½
                }
            }
        }

        window.sendAIChat = async (contextType) => {
            if(!USER_API_KEY) return showToast("è«‹å…ˆè‡³è¨­å®šé é¢è¼¸å…¥ API Key", "error");
            const inputId = `${contextType}-chat-input`; const containerId = `${contextType}-chat-box`;
            const input = document.getElementById(inputId); const msg = input.value.trim(); if(!msg) return;
            const chatBox = document.getElementById(containerId);
            chatBox.innerHTML += `<div class="flex justify-end mb-2"><div class="bg-blue-600 text-white py-2 px-3 rounded-2xl rounded-tr-none text-sm max-w-[85%]">${msg}</div></div>`;
            input.value = ''; chatBox.scrollTop = chatBox.scrollHeight;
            const loadingId = Date.now();
            chatBox.innerHTML += `<div id="${loadingId}" class="flex justify-start mb-2"><div class="bg-white border border-gray-200 text-gray-500 py-2 px-3 rounded-2xl rounded-tl-none text-xs">AI æ€è€ƒä¸­...</div></div>`;

            const monthStart = currentDate.substring(0, 7);
            const todayLogs = dailyLogs.filter(l=>l.dateStr===currentDate);
            const monthLogs = dailyLogs.filter(l=>l.dateStr.startsWith(monthStart));
            
            let context = "";
            if(contextType === 'health') {
                const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const healthHistory = dailyLogs.filter(l => l.kcal > 0 && new Date(l.dateStr) >= sevenDaysAgo).map(l => `${l.dateStr}: ${l.description} (${l.kcal}kcal)`).join("\n");
                const kcalIn = todayLogs.reduce((a,b)=>a+(b.kcal||0),0);
                const burned = todayLogs.reduce((a,b)=>a+(b.burned||0),0);
                context = `è§’è‰²:ç‡Ÿé¤Šæ•™ç·´ã€‚æ•¸æ“š: èº«é«˜${userProfile.height}cm/é«”é‡${userProfile.weight}kg/å¹´é½¡${userProfile.age}/æ€§åˆ¥${userProfile.gender}, ç›®æ¨™${userProfile.targetKcal}kcalã€‚ä»Šæ—¥æ”å–${kcalIn}, æ¶ˆè€—${burned}, å‰©é¤˜${userProfile.targetKcal+burned-kcalIn}ã€‚è¿‘æœŸç´€éŒ„:${healthHistory}ã€‚è«‹ä»¥æ¢åˆ—å¼æˆ–é‡é»æ•´ç†å›ç­”ç”¨æˆ¶ã€‚`;
            } else if (contextType === 'finance') {
                const incomeTotal = Object.values(monthlyIncome).reduce((a,b)=>a+b,0);
                const fixedTotal = fixedExpenses.reduce((a,b)=>a+b.amount,0);
                const disposable = incomeTotal - fixedTotal;
                const entRatio = userProfile.entRatio || 20;
                const invRatio = 100 - entRatio;
                const entBudget = Math.floor(disposable * (entRatio/100));
                const invBudget = Math.floor(disposable * (invRatio/100));
                const entSpent = monthLogs.filter(l => l.category === 'å¨›æ¨‚').reduce((a,b) => a + (b.amount||0), 0);
                const invSpent = monthLogs.filter(l => l.category === 'æŠ•è³‡').reduce((a,b) => a + (b.amount||0), 0);
                const totalAsset = accounts.reduce((a,b)=>a+b.balance,0);
                const invContext = investments.map(i => `${i.symbol}: ${i.note}`).join(", ");
                const history = monthLogs.map(l => `${l.dateStr}: ${l.description} $${l.amount}`).join("\n");
                context = `è§’è‰²:å…¨èƒ½ç†è²¡é¡§å•ã€‚æœ¬æœˆæ•¸æ“š:ç¸½æ”¶å…¥$${incomeTotal}, å›ºå®šæ”¯å‡º$${fixedTotal}, å¯æ”¯é…$${disposable}ã€‚åˆ†é…:å¨›æ¨‚${entRatio}%/æŠ•è³‡${invRatio}%ã€‚å¨›æ¨‚å‰©é¤˜$${entBudget - entSpent}, æŠ•è³‡å‰©é¤˜$${invBudget - invSpent}, ç¸½è³‡ç”¢$${totalAsset}, æŠ•è³‡çµ„åˆ:[${invContext}]ã€‚æœ¬æœˆæµæ°´å¸³:${history}ã€‚è«‹ä»¥æ¢åˆ—å¼æ¸…æ™°å›ç­”ã€‚`;
            }

            try {
                const res = await callAI(context + " ç”¨æˆ¶å•:" + msg);
                document.getElementById(loadingId).remove();
                const displayNum = typeof res === 'object' ? "AI æ ¼å¼éŒ¯èª¤" : res;
                chatBox.innerHTML += `<div class="flex justify-start mb-4"><div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-2 text-lg flex-shrink-0">ğŸ¤–</div><div class="bg-white text-gray-800 py-3 px-4 rounded-2xl rounded-tl-none text-sm shadow-sm border border-gray-100 max-w-[90%]">${parseMarkdown(displayNum)}</div></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch(e) { document.getElementById(loadingId).remove(); }
        };

        window.addInvestment = async () => {
            const symbol = document.getElementById('inv-symbol').value;
            const note = document.getElementById('inv-note').value;
            if(!symbol || !note) return showToast('è«‹è¼¸å…¥å…§å®¹', 'error');
            const btn = document.getElementById('inv-add-btn'); btn.textContent = 'AI åˆ†æä¸­...'; btn.disabled = true;
            try {
                const prompt = `åˆ†ææŠ•è³‡: ${symbol}ã€‚è§€é»: "${note}"ã€‚é¢¨éšªè©•ä¼°ã€‚è«‹ç°¡çŸ­å›è¦†ã€‚`;
                const aiFeedback = await callAI(prompt); 
                const feedbackText = typeof aiFeedback === 'object' ? `éŒ¯èª¤: ${aiFeedback.error}` : aiFeedback;
                investments.push({ id: Date.now().toString(), symbol, note, feedback: feedbackText, date: new Date().toLocaleDateString() }); 
                saveData();
                document.getElementById('inv-symbol').value = ''; document.getElementById('inv-note').value = '';
                showToast('ç­†è¨˜å·²æ–°å¢', 'success');
            } catch(e) {
                investments.push({ id: Date.now().toString(), symbol, note, feedback: "API Key éŒ¯èª¤", date: new Date().toLocaleDateString() });
                saveData();
            } finally { btn.textContent = 'ï¼‹ æ–°å¢ä¸¦ AI åˆ†æ'; btn.disabled = false; }
        };

        window.removeInvestment = async (idStr) => {
            if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
            investments = investments.filter(i => String(i.id) !== String(idStr));
            await saveData('inv');
        };

        // --- UI Utils ---
        window.openInputModal = (type, id=null) => {
            window.inputType = type; window.inputId = id;
            
            // Default View
            document.getElementById('input-default-container').classList.remove('hidden');
            document.getElementById('input-account-container').classList.add('hidden');
            document.getElementById('input-fixed-acc-container').classList.add('hidden');
            
            setValue('input-value', ''); setValue('input-note', '');
            document.getElementById('input-modal').classList.remove('hidden');
            const title = document.getElementById('input-modal-title');
            const noteContainer = document.getElementById('input-note-container');
            const note = document.getElementById('input-note');

            if(type === 'income') { title.textContent = 'ä¿®æ”¹æ”¶å…¥'; setValue('input-value', monthlyIncome[id]); noteContainer.classList.add('hidden'); } 
            else if(type === 'fixed_add') { 
                title.textContent = 'æ–°å¢å›ºå®šæ”¯å‡º'; 
                noteContainer.classList.remove('hidden'); 
                note.placeholder = 'åç¨±';
                
                // Show Fixed Account Select
                document.getElementById('input-fixed-acc-container').classList.remove('hidden');
                const fixedAccSel = document.getElementById('input-fixed-acc-select');
                fixedAccSel.innerHTML = accounts.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            } 
            else if (type === 'fixed_edit') { 
                title.textContent = 'ä¿®æ”¹å›ºå®šæ”¯å‡º'; 
                const item = fixedExpenses.find(f=>f.id===id);
                setValue('input-value', item.amount); 
                noteContainer.classList.add('hidden'); 
                
                // Show Fixed Account Select & Set Value
                document.getElementById('input-fixed-acc-container').classList.remove('hidden');
                const fixedAccSel = document.getElementById('input-fixed-acc-select');
                fixedAccSel.innerHTML = accounts.map(a => `<option value="${a.name}" ${item.note===a.name?'selected':''}>${a.name}</option>`).join('');
            } 
            else if(type === 'balance') { title.textContent = 'è³‡ç”¢æ ¡æ­£'; if(id===-1) { noteContainer.classList.remove('hidden'); note.placeholder = 'å¸³æˆ¶åç¨±'; } else { setValue('input-value', accounts[id].balance); noteContainer.classList.add('hidden'); } }
            
            else if (type === 'change_account') {
                title.textContent = 'ä¿®æ”¹æ‰£æ¬¾å¸³æˆ¶';
                document.getElementById('input-default-container').classList.add('hidden');
                document.getElementById('input-account-container').classList.remove('hidden');
                
                const sel = document.getElementById('input-account-select');
                sel.innerHTML = accounts.map(a => `<option value="${a.name}">${a.name} ($${a.balance})</option>`).join('');
                
                const currentLog = dailyLogs.find(l => l.id === id);
                if(currentLog && currentLog.card) sel.value = currentLog.card;
            }
        };

        window.submitInputModal = async () => {
            // Logic for Change Account
            if (window.inputType === 'change_account') {
                const newCard = document.getElementById('input-account-select').value;
                const logIdx = dailyLogs.findIndex(l => l.id === window.inputId);
                
                if (logIdx !== -1) {
                    const log = dailyLogs[logIdx];
                    const oldCard = log.card;
                    const amount = log.amount;

                    if (oldCard !== newCard) {
                        const oldAccIdx = accounts.findIndex(a => a.name === oldCard);
                        if (oldAccIdx !== -1) accounts[oldAccIdx].balance += amount;

                        const newAccIdx = accounts.findIndex(a => a.name === newCard);
                        if (newAccIdx !== -1) accounts[newAccIdx].balance -= amount;

                        dailyLogs[logIdx].card = newCard;
                    }
                }
            } else {
                const v = parseInt(document.getElementById('input-value').value)||0;
                const n = document.getElementById('input-note').value;
                
                if(window.inputType === 'income') { monthlyIncome[window.inputId] = v; }
                
                if(window.inputType === 'fixed_add') { 
                    if(!n) return; 
                    const acc = document.getElementById('input-fixed-acc-select').value;
                    fixedExpenses.push({id:Date.now(), name:n, amount:v, note:acc}); 
                }
                
                if(window.inputType === 'fixed_edit') { 
                    const idx = fixedExpenses.findIndex(f=>f.id===window.inputId); 
                    if(idx!==-1) {
                        fixedExpenses[idx].amount = v;
                        fixedExpenses[idx].note = document.getElementById('input-fixed-acc-select').value;
                    }
                }
                
                if(window.inputType === 'balance') { if(window.inputId === -1) { if(!n) return; accounts.push({name:n, balance:v}); } else { accounts[window.inputId].balance = v; } }
            }
            saveData();
            closeModal('input');
        };

        window.openModal = (id) => document.getElementById(`${id}-modal`).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(`${id}-modal`).classList.add('hidden');

        // --- CALENDAR ---
        window.toggleCalendar = () => {
            const cal = document.getElementById('calendar-wrapper');
            if(cal.classList.contains('hidden')) { cal.classList.remove('hidden'); renderCalendar(); }
            else cal.classList.add('hidden');
        };

        const renderCalendar = () => {
            const calContainer = document.getElementById('calendar-grid');
            if(!calContainer) return;
            const monthLabel = document.getElementById('current-month-label');
            const y = currentViewMonth.getFullYear();
            const m = currentViewMonth.getMonth();
            monthLabel.textContent = `${y}å¹´ ${m+1}æœˆ`;

            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            
            let html = '';
            for(let i=0; i<firstDay; i++) html += `<div></div>`;
            
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasLog = dailyLogs.some(l => l.dateStr === dateStr);
                const isSelected = dateStr === currentDate;
                html += `<div onclick="selectDate('${dateStr}')" class="h-8 flex flex-col items-center justify-center rounded-full cursor-pointer relative ${isSelected ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}"><span class="text-xs font-bold">${d}</span>${hasLog ? `<span class="w-1 h-1 rounded-full ${isSelected ? 'bg-white' : 'bg-green-500'} absolute bottom-1"></span>` : ''}</div>`;
            }
            calContainer.innerHTML = html;
        };

        window.prevMonth = () => { currentViewMonth.setMonth(currentViewMonth.getMonth()-1); renderCalendar(); };
        window.nextMonth = () => { currentViewMonth.setMonth(currentViewMonth.getMonth()+1); renderCalendar(); };
        window.selectDate = (d) => { currentDate = d; refreshUI(); window.toggleCalendar(); };
        window.jumpToToday = () => { currentDate = getLocalDate(); currentViewMonth = new Date(); refreshUI(); };

        // é‡æ–°è£œä¸Šå®Œæ•´çš„ refreshUI å‡½å¼
        const refreshUI = () => {
            const todayLogs = dailyLogs.filter(l=>l.dateStr===currentDate);
            const monthLogs = dailyLogs.filter(l=>l.dateStr.startsWith(currentDate.substring(0,7)));

            // Dashboard Stats
            const kcalIn = todayLogs.reduce((a,b)=>a+(b.kcal||0),0);
            const kcalBurn = todayLogs.reduce((a,b)=>a+(b.burned||0),0);
            const todayTotalSpend = todayLogs.filter(l=>l.type.includes('finance')).reduce((a,b)=>a+(b.amount||0),0);
            
            setText('today-record-sum', `(ç¸½æ”¯å‡º: $${todayTotalSpend})`);
            setText('dash-food', `$${todayTotalSpend}`);
            setText('dash-in', kcalIn);
            setText('dash-burn', kcalBurn);
            setText('dash-remain', userProfile.targetKcal + kcalBurn - kcalIn);
            setText('current-date-display', currentDate);

            updateCategoryDropdown();

            // Log List
            const logListHtml = todayLogs.length ? todayLogs.map(l=>{
                const icon = categoryIcons[l.category] || 'ğŸ“';
                const cardDisplay = l.card ? `<span onclick="openInputModal('change_account', '${l.id}')" class="cursor-pointer text-blue-500 hover:text-blue-700 hover:underline decoration-dotted" title="é»æ“Šä¿®æ”¹å¸³æˆ¶">${l.card}</span>` : 'ç„¡';
                
                return `
                <div class="flex justify-between p-3 border-b border-gray-100 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${icon}</span>
                        <div>
                            <div class="font-bold text-gray-700">${l.description}</div>
                            <div class="text-[10px] text-gray-400">${l.category} Â· ${cardDisplay}</div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end text-right">
                        <div class="flex items-center gap-2">
                            ${l.amount > 0 ? `<div class="font-bold">-$${l.amount}</div>` : ''}
                            <button onclick="deleteLog('${l.id}')" class="text-gray-300 hover:text-red-500 px-1 font-bold text-lg leading-none">Ã—</button>
                        </div>
                        ${l.kcal ? `<div class="text-[10px] text-green-500">æ” ${l.kcal}</div>` : ''}
                        ${l.burned ? `<div class="text-[10px] text-orange-500">æ¶ˆ ${l.burned}</div>` : ''}
                    </div>
                </div>`;
            }).join('') : '<div class="text-center text-gray-400 py-4">æœ¬æ—¥ç„¡ç´€éŒ„</div>';
            setHTML('log-list', logListHtml);

            // Fixed List Rendering & Calculation
            let totalFixedRemaining = 0;
            const fixedListHtml = fixedExpenses.map(f => {
                const spentThisMonth = monthLogs.filter(l => l.category === f.name || l.description.includes(f.name)).reduce((a,b) => a + (b.amount||0), 0);
                const remaining = f.amount - spentThisMonth;
                const isPaid = spentThisMonth > 0;
                
                totalFixedRemaining += remaining;

                return `
                <div class="flex justify-between p-2 text-sm border-b items-center">
                    <div class="flex items-center gap-2">
                        ${isPaid ? '<span class="text-green-500 text-xs">ğŸŸ¢</span>' : '<span class="text-gray-200 text-xs">âšª</span>'}
                        <div>
                            <div class="font-medium">${f.name}</div>
                            <div class="text-xs text-gray-400">å‰©é¤˜: $${remaining} Â· ç¶å®š: ${f.note}</div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold cursor-pointer hover:bg-gray-100 px-1 rounded ${remaining < 0 ? 'text-red-500' : 'text-gray-800'}" onclick="openInputModal('fixed_edit', ${f.id})">$${f.amount}</span>
                        <button onclick="removeFixed(${f.id})" class="text-red-400 ml-2">Ã—</button>
                    </div>
                </div>`;
            }).join('');
            setHTML('dash-fixed-list', fixedListHtml);
            
            // Update Total Fixed Remaining Text
            const fixedTotalEl = document.getElementById('fixed-total-remaining');
            if(fixedTotalEl) {
                fixedTotalEl.textContent = `$${totalFixedRemaining}`;
                fixedTotalEl.className = `font-bold ${totalFixedRemaining < 0 ? 'text-red-600' : 'text-green-600'}`;
            }

            // --- æ ¸å¿ƒä¿®æ­£å€å¡Šé–‹å§‹ ---
            const incomeTotal = Object.values(monthlyIncome).reduce((a,b)=>a+b,0);
            const fixedTotal = fixedExpenses.reduce((a,b)=>a+b.amount,0); // å›ºå®šæ”¯å‡ºã€Œé ç®—ã€ç¸½å’Œ

            // 1. å…ˆç®—å‡ºæœ¬æœˆæ‰€æœ‰æµæ°´å¸³çš„ç¸½æ”¯å‡º
            const totalLogSpent = monthLogs.filter(l=>l.type.includes('finance')).reduce((a,b)=>a+(b.amount||0),0);
            
            // 2. æ‰¾å‡ºå±¬æ–¼ã€Œå›ºå®šæ”¯å‡ºé¡åˆ¥ã€çš„å¯¦éš›èŠ±è²» (ç‚ºäº†å¾ç¸½æ”¯å‡ºä¸­æ‰£é™¤ï¼Œé¿å…é‡è¤‡è¨ˆç®—)
            const fixedCatNames = fixedExpenses.map(f => f.name);
            const spentOnFixedLogs = monthLogs
                .filter(l => fixedCatNames.includes(l.category) && l.type.includes('finance'))
                .reduce((a,b) => a + (b.amount||0), 0);

            // 3. è¨ˆç®—ã€ŒçœŸæ­£çš„è®Šå‹•æ”¯å‡ºã€ = ç¸½æ”¯å‡º - å›ºå®šé¡åˆ¥æ”¯å‡º
            const realVariableSpent = totalLogSpent - spentOnFixedLogs;

            const entSpent = monthLogs.filter(l => l.category === 'å¨›æ¨‚').reduce((a,b) => a + (b.amount||0), 0);
            const invSpent = monthLogs.filter(l => l.category === 'æŠ•è³‡').reduce((a,b) => a + (b.amount||0), 0);

            const disposableIncome = incomeTotal - fixedTotal; // å¯æ”¯é… = æ”¶å…¥ - å›ºå®šé ç®—
            const monthlyRemaining = disposableIncome - realVariableSpent; // æœ€çµ‚é¤˜é¡ = å¯æ”¯é… - è®Šå‹•æ”¯å‡º(å·²æ’é™¤å›ºå®šé …ç›®èŠ±è²»)
            // --- æ ¸å¿ƒä¿®æ­£å€å¡ŠçµæŸ ---

            setText('dash-month-remain', `$${monthlyRemaining.toLocaleString()}`);

            const entRatio = userProfile.entRatio || 20;
            const invRatio = 100 - entRatio;
            
            const entBudget = Math.floor(disposableIncome * (entRatio / 100));
            const invBudget = Math.floor(disposableIncome * (invRatio / 100));

            ['salary','bonus','overtime','oncall'].forEach(k => { const el=document.getElementById(`inc-${k}`); if(el) el.value=monthlyIncome[k]; });
            
            setText('rep-total-inc', `$${incomeTotal.toLocaleString()}`);
            setText('rep-disposable', `$${disposableIncome.toLocaleString()}`);
            setText('rep-final', `$${monthlyRemaining.toLocaleString()}`);
            
            setText('rep-ent-val', `$${(entBudget - entSpent).toLocaleString()}`);
            setText('rep-ent-label', `å¨›æ¨‚ ${entRatio}% (é ç®—$${entBudget})`);
            
            setText('rep-inv-val', `$${(invBudget - invSpent).toLocaleString()}`);
            setText('rep-inv-label', `æŠ•è³‡ ${invRatio}% (é ç®—$${invBudget})`);

            setText('rep-total-fix', `-$${fixedTotal.toLocaleString()}`);
            
            setHTML('rep-acc-list', accounts.map((a,i)=>`<div class="flex justify-between p-2 text-sm border-b"><span>${a.name}</span><div><span class="font-bold ${a.balance<0?'text-red-500':'text-blue-600'}">$${a.balance}</span> <button onclick="openInputModal('balance',${i})" class="text-gray-400 ml-2">âœ</button></div></div>`).join(''));
            
            setHTML('inv-list', investments.map(i=>`
                <div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-100">
                    <div class="flex justify-between items-start mb-2"><div><span class="bg-blue-100 text-blue-700 font-bold px-2 py-1 rounded text-xs">${i.symbol}</span><span class="text-xs text-gray-400 ml-2">${i.date}</span></div>
                    <button onclick="removeInvestment('${i.id}')" class="text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-gray-200">ğŸ—‘ï¸</button></div>
                    <div class="text-sm font-medium text-gray-800 mb-2">"${i.note}"</div>
                    <div class="text-xs bg-white p-2 rounded border border-indigo-100 text-gray-600 leading-relaxed"><strong class="text-indigo-600 block mb-1">ğŸ¤– AI åˆ†æï¼š</strong>${parseMarkdown(i.feedback)}</div>
                </div>`).join(''));

            setValue('prof-height', userProfile.height);
            setValue('prof-weight', userProfile.weight);
            setValue('prof-age', userProfile.age || 30);
            setValue('prof-gender', userProfile.gender || 'male');
            
            setValue('ratio-ent', userProfile.entRatio || 20);
            setValue('ratio-inv', 100 - (userProfile.entRatio || 20));
            
            renderCalendar();
            
            const currCat = document.getElementById('log-category').value;
            changeLogCategory(currCat);
        };

        window.removeFixed = async (id) => { fixedExpenses = fixedExpenses.filter(f=>f.id!==id); await saveData('fix'); };
        window.switchTab = (t) => {
            document.querySelectorAll('.tab-view').forEach(e=>e.classList.add('hidden'));
            document.getElementById(`${t}-view`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('text-blue-600'));
            document.getElementById(`nav-${t}`).classList.add('text-blue-600');
            refreshUI();
        };
        window.changeDate = (e) => { currentDate = e.target.value; refreshUI(); };
        window.showToast = (m,t) => { const el=document.getElementById('toast'); el.textContent=m; el.className=`fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full text-white ${t==='error'?'bg-red-500': t==='info'?'bg-blue-500':'bg-black'} z-50`; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),2000); };
        
        const updateCategoryDropdown = () => {
            const select = document.getElementById('log-category');
            const currentVal = select.value;
            let fixedNames = fixedExpenses.map(f => f.name);
            fixedNames = fixedNames.filter(n => n !== 'é£Ÿç‰©');
            const hasFood = fixedExpenses.some(f => f.name === 'é£Ÿç‰©');
            let finalCats = [];
            if (hasFood) finalCats.push('é£Ÿç‰©');
            finalCats.push('å¨›æ¨‚', 'æŠ•è³‡', 'é‹å‹•'); // é€™è£¡ç¢ºä¿åŠ å…¥ 'é‹å‹•'
            finalCats = [...finalCats, ...fixedNames];
            finalCats = [...new Set(finalCats)];

            select.innerHTML = finalCats.map(c => {
                const icon = categoryIcons[c] || 'ğŸ“'; 
                return `<option value="${c}">${icon} ${c}</option>`;
            }).join('');
            
            if(finalCats.includes(currentVal)) select.value = currentVal;
            else if(finalCats.length > 0) select.value = finalCats[0];
        };

        window.changeLogCategory = (v) => {
            const cardSel = document.getElementById('log-card'); 
            const amtInput = document.getElementById('log-amount'); 
            const btn = document.getElementById('unified-log-btn');
            
            if (v === 'é‹å‹•') { 
                cardSel.disabled = true; 
                cardSel.innerHTML = '<option>ç„¡</option>';
                amtInput.placeholder = 'ç„¡'; 
                amtInput.value = 0; 
                amtInput.disabled = true; 
                btn.textContent = 'ğŸ”¥ è¨˜éŒ„'; 
                
                // NEW: é‹å‹•æ¨¡å¼é¡¯ç¤ºæ‰‹å‹•è¼¸å…¥æ¶ˆè€—
                toggleManualInput('exercise');
            } else { 
                cardSel.disabled = false; 
                amtInput.placeholder = '$'; 
                amtInput.disabled = false; 
                btn.textContent = 'ğŸ’° è¨˜éŒ„';
                
                // é£Ÿç‰©é¡åˆ¥é¡¯ç¤ºæ‰‹å‹•ç‡Ÿé¤Šï¼Œå…¶ä»–éš±è—
                if(v === 'é£Ÿç‰©' || v === 'é¤è²»') toggleManualInput('food');
                else toggleManualInput('none');
                
                let targetSelectAccount = '';
                let budgetInfo = '';
                const fixedItem = fixedExpenses.find(f => f.name === v);

                if (v === 'å¨›æ¨‚' || v === 'æŠ•è³‡') {
                    const incomeTotal = Object.values(monthlyIncome).reduce((a,b)=>a+b,0);
                    const fixedTotal = fixedExpenses.reduce((a,b)=>a+b.amount,0);
                    const disposable = incomeTotal - fixedTotal;
                    const ratio = v === 'å¨›æ¨‚' ? (userProfile.entRatio || 20) : (100 - (userProfile.entRatio || 20));
                    const totalBudget = Math.floor(disposable * (ratio / 100));
                    
                    const monthStart = currentDate.substring(0, 7);
                    const monthLogs = dailyLogs.filter(l => l.dateStr.startsWith(monthStart));
                    const spent = monthLogs.filter(l => l.category === v).reduce((a, b) => a + (b.amount || 0), 0);
                    const remaining = totalBudget - spent;
                    
                    budgetInfo = ` (é ç®—å‰©: $${remaining})`;
                }
                else if (fixedItem) {
                    const monthStart = currentDate.substring(0, 7);
                    const monthLogs = dailyLogs.filter(l => l.dateStr.startsWith(monthStart));
                    const spent = monthLogs.filter(l => l.category === v).reduce((a, b) => a + (b.amount || 0), 0);
                    const remaining = fixedItem.amount - spent;
                    budgetInfo = ` (é ç®—å‰©: $${remaining})`;
                    targetSelectAccount = fixedItem.note; 
                }

                const optionsHtml = accounts.map(a => {
                    let label = `${a.name} ($${a.balance})`; 
                    if (fixedItem && a.name === targetSelectAccount) {
                        label = `âœ” ${a.name}${budgetInfo}`; 
                    }
                    const isSelected = (a.name === targetSelectAccount);
                    return `<option value="${a.name}" ${isSelected ? 'selected' : ''}>${label}</option>`;
                }).join('') + '<option value="custom">â• è‡ªè¨‚...</option>';

                cardSel.innerHTML = optionsHtml;
                
                if (v === 'å¨›æ¨‚' || v === 'æŠ•è³‡') {
                    Array.from(cardSel.options).forEach(opt => {
                        if (opt.value !== 'custom') {
                            opt.text = `${opt.text.split('(')[0]} ${budgetInfo}`;
                        }
                    });
                }
            }
        };

        window.onload = initApp; // Safety check
        function initApp() { /* Init handled by DOMContentLoaded */ }
    </script>
</head>
<body class="bg-gray-50 pb-20 select-none text-gray-800">
    <div id="toast" class="hidden"></div>

    <!-- NEW: Camera Choice Modal -->
    <div id="camera-choice-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="closeModal('camera-choice')">
        <div class="bg-white w-full max-w-xs rounded-xl p-5 shadow-xl text-center" onclick="event.stopPropagation()">
            <h3 class="font-bold mb-4 text-lg">é¸æ“‡åœ–ç‰‡ä¾†æº</h3>
            <div class="flex flex-col gap-3">
                <button onclick="triggerCamera()" class="bg-blue-50 text-blue-600 py-3 rounded-lg font-bold border border-blue-100 hover:bg-blue-100 flex items-center justify-center gap-2">ğŸ“· æ‹ç…§ (Camera)</button>
                <button onclick="triggerGallery()" class="bg-gray-50 text-gray-600 py-3 rounded-lg font-bold border border-gray-200 hover:bg-gray-100 flex items-center justify-center gap-2">ğŸ–¼ï¸ ç›¸ç°¿ (Album)</button>
                <button onclick="closeModal('camera-choice')" class="mt-2 text-gray-400 text-sm">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden Inputs for Dual Logic -->
    <input type="file" id="input-camera" accept="image/*" capture="environment" onchange="handleImageUpload(event)" class="hidden-input">
    <input type="file" id="input-gallery" accept="image/*" onchange="handleImageUpload(event)" class="hidden-input">

    <div id="verify-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-xl">
            <h3 id="verify-title" class="font-bold mb-4 text-lg">ç¢ºèª</h3>
            <div id="verify-inputs"></div>
            <div class="flex gap-2 mt-4"><button onclick="closeModal('verify')" class="flex-1 bg-gray-100 py-2 rounded font-bold text-gray-500">å–æ¶ˆ</button><button onclick="confirmVerifyLog()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold shadow-lg">ç¢ºèªå­˜æª”</button></div>
        </div>
    </div>
    
    <div id="input-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-xl">
            <h3 id="input-modal-title" class="font-bold mb-4 text-lg">è¼¸å…¥è³‡æ–™</h3>
            
            <div id="input-default-container" class="mb-3">
                <div id="input-note-container"><input id="input-note" type="text" class="w-full border p-2 rounded mb-2" placeholder="åç¨±"></div>
                <label id="input-label" class="text-xs text-gray-500">æ•¸å€¼</label>
                <input id="input-value" type="number" class="w-full border p-2 rounded font-bold text-lg">
            </div>

            <div id="input-account-container" class="mb-3 hidden">
                <label class="text-xs text-gray-500 block mb-2">é¸æ“‡æ–°æ‰£æ¬¾å¸³æˆ¶</label>
                <select id="input-account-select" class="w-full border p-3 rounded font-bold bg-white"></select>
            </div>

            <div id="input-fixed-acc-container" class="mb-3 hidden">
                <label class="text-xs text-gray-500 block mb-2">ç¶å®šæ‰£æ¬¾å¸³æˆ¶</label>
                <select id="input-fixed-acc-select" class="w-full border p-3 rounded font-bold bg-white"></select>
            </div>

            <div class="flex gap-2"><button onclick="closeModal('input')" class="flex-1 bg-gray-100 py-2 rounded">å–æ¶ˆ</button><button onclick="submitInputModal()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">ç¢ºå®š</button></div>
        </div>
    </div>

    <div class="bg-white p-3 shadow-sm sticky top-0 z-20">
        <div class="flex justify-between items-center">
            <div class="font-black text-lg">Pocket Coach <span class="text-xs bg-indigo-100 text-indigo-600 px-1 rounded">V18.3</span></div>
            <div class="flex items-center gap-2">
                <span id="current-date-display" class="font-bold text-lg text-gray-700"></span>
                <button onclick="toggleCalendar()" class="bg-gray-100 p-2 rounded-lg text-xs font-bold text-gray-600 flex items-center gap-1">ğŸ“… å±•é–‹æœˆæ›†</button>
            </div>
        </div>
        <div id="calendar-wrapper" class="hidden mt-3 border-t pt-2">
            <div class="flex justify-between items-center mb-2 px-2">
                <button onclick="prevMonth()" class="text-gray-400 hover:text-black font-bold">â—€</button>
                <span id="current-month-label" class="text-sm font-bold w-20 text-center">...</span>
                <button onclick="nextMonth()" class="text-gray-400 hover:text-black font-bold">â–¶</button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-400 mb-1"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
            <div class="text-center mt-2"><button onclick="jumpToToday()" class="text-xs text-blue-600 font-bold border border-blue-200 px-2 py-1 rounded">è·³å›ä»Šå¤©</button></div>
        </div>
    </div>

    <main class="max-w-md mx-auto p-3">
        
        <div id="dashboard-view" class="tab-view">
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="bg-white p-2 rounded-xl border border-blue-100 text-center shadow-sm">
                    <div class="text-[10px] text-gray-400">ä»Šæ—¥æ”¯å‡º</div>
                    <div id="dash-food" class="text-lg font-black text-blue-600">$0</div>
                </div>
                <div class="bg-white p-2 rounded-xl border border-yellow-100 text-center shadow-sm">
                    <div class="text-[10px] text-gray-400">æœ¬æœˆå‰©é¤˜é ç®—</div>
                    <div id="dash-month-remain" class="text-lg font-black text-yellow-600">$0</div>
                </div>
                <div class="bg-gray-800 p-2 rounded-xl text-center text-white shadow-sm">
                    <div class="text-[10px] opacity-70">å‰©é¤˜ç†±é‡</div>
                    <div id="dash-remain" class="text-lg font-black">1500</div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-md mb-4 border border-gray-200">
                <div class="flex gap-2 mb-2">
                    <select id="log-category" onchange="changeLogCategory(this.value)" class="bg-gray-50 border p-2 rounded text-sm w-1/3">
                        </select>
                    <select id="log-card" onchange="if(this.value==='custom') document.getElementById('finance-card-custom').classList.remove('hidden'); else document.getElementById('finance-card-custom').classList.add('hidden')" class="bg-gray-50 border p-2 rounded text-sm w-2/3"></select>
                </div>
                <input id="finance-card-custom" type="text" placeholder="è¼¸å…¥å¸³æˆ¶åç¨±" class="w-full border p-2 rounded text-sm mb-2 hidden">
                <div class="flex items-center gap-2 mb-2">
                     <button onclick="openCameraModal()" class="bg-gray-50 border border-gray-200 rounded-lg p-2 cursor-pointer flex items-center justify-center w-12 hover:bg-gray-100 text-xl">ğŸ“·</button>
                    <input id="log-description" placeholder="æè¿° (å¦‚: é›è…¿ä¾¿ç•¶)" class="flex-grow border border-gray-200 p-2 rounded text-sm h-10">
                    <input id="log-amount" type="number" placeholder="$" class="w-16 border border-gray-200 p-2 rounded text-center font-bold text-sm h-10">
                </div>
                
                <!-- NEW: æ‰‹å‹•è¼¸å…¥ç‡Ÿé¤Šå€å¡Š (å‹•æ…‹åˆ‡æ›) -->
                <div id="manual-nutrition-block" class="bg-gray-50 p-2 rounded mb-2 border border-dashed border-gray-300 hidden">
                    <div id="manual-hint-text" class="text-[10px] text-gray-400 mb-1">âœï¸ æ‰‹å‹•è¼¸å…¥ç‡Ÿé¤Š</div>
                    <div class="flex gap-2">
                        <div id="manual-kcal-container" class="flex-1 relative h-10">
                            <input id="log-manual-kcal" type="number" placeholder="ç†±é‡" class="w-full h-full border p-1 rounded text-sm text-center pl-4 appearance-none">
                            <span id="manual-kcal-label" class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400">ğŸ”¥</span>
                        </div>
                        <div id="manual-protein-container" class="flex-1 relative h-10">
                            <input id="log-manual-protein" type="number" placeholder="è›‹ç™½" class="w-full h-full border p-1 rounded text-sm text-center pl-4 appearance-none">
                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400">ğŸ¥š</span>
                        </div>
                    </div>
                </div>

                <div id="image-preview" class="mb-2 flex justify-start"></div>
                <button id="unified-log-btn" onclick="handleUnifiedLog()" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold shadow-lg">ğŸ’° è¨˜éŒ„</button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-green-200 p-4 mb-4">
                <h3 class="font-bold text-green-700 text-sm mb-3 flex items-center border-b border-green-100 pb-2"><span class="text-lg mr-2">ğŸ¥—</span> AI ç‡Ÿé¤Šæ•™ç·´</h3>
                <div id="health-chat-box" class="h-40 overflow-y-auto mb-3 text-sm space-y-2 pr-1"><div class="text-center text-gray-300 text-xs py-2">æœ‰ä»€éº¼é£²é£Ÿå•é¡Œæƒ³å•æˆ‘å—ï¼Ÿ</div></div>
                <div class="flex gap-2"><input id="health-chat-input" type="text" placeholder="å•æ•™ç·´..." class="flex-grow bg-gray-50 border rounded-lg px-3 py-2 text-sm outline-none"><button onclick="sendAIChat('health')" class="bg-green-600 text-white px-4 rounded-lg font-bold text-sm shadow-sm active:scale-95">ç™¼é€</button></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-3 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-gray-400">ä»Šæ—¥ç´€éŒ„</h3>
                    <span id="today-record-sum" class="text-xs font-bold text-blue-600"></span>
                </div>
                <div id="log-list"></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-4 border border-red-100">
                <div class="flex justify-between items-center mb-2 border-b pb-2">
                    <div>
                        <h3 class="font-bold text-red-800 text-sm">ğŸ”’ æ¯æœˆå›ºå®šæ”¯å‡º</h3>
                        <div class="text-[10px] text-gray-400 mt-1">ç¸½å‰©é¤˜: <span id="fixed-total-remaining" class="font-bold text-green-600">$0</span></div>
                    </div>
                    <button onclick="openInputModal('fixed_add')" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">ï¼‹ æ–°å¢</button>
                </div>
                <div id="dash-fixed-list"></div>
            </div>
        </div>

        <div id="finance-view" class="tab-view hidden">
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 mb-4 text-center">
                <div class="text-sm text-gray-500">å¯æ”¯é…æ‰€å¾— (æ”¶å…¥-å›ºå®š)</div>
                <div id="rep-disposable" class="text-2xl font-black text-blue-600 mb-2">$0</div>
                <div class="flex gap-2 text-xs mb-3">
                    <div class="flex-1 bg-yellow-50 p-1 rounded text-yellow-700"><span id="rep-ent-label">å¨›æ¨‚å‰©é¤˜</span> <span id="rep-ent-val" class="font-bold block text-lg">$0</span></div>
                    <div class="flex-1 bg-green-50 p-1 rounded text-green-700"><span id="rep-inv-label">æŠ•è³‡å‰©é¤˜</span> <span id="rep-inv-val" class="font-bold block text-lg">$0</span></div>
                </div>
                <div class="bg-gray-900 text-white p-3 rounded-lg"><div class="text-xs opacity-70">æœ€çµ‚é¤˜é¡ (å¯æ”¯é… - è®Šå‹•æ”¯å‡º)</div><div class="text-lg font-bold"> <span id="rep-final" class="text-xl">$0</span></div></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-bold border-b pb-2 mb-2">æ”¶å…¥</h3>
                <div class="grid grid-cols-2 gap-4 text-sm mb-2">
                    <div><span class="text-xs text-gray-400">è–ªæ°´</span> <input id="inc-salary" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','salary')" readonly></div>
                    <div><span class="text-xs text-gray-400">çé‡‘</span> <input id="inc-bonus" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','bonus')" readonly></div>
                    <div><span class="text-xs text-gray-400">åŠ ç­</span> <input id="inc-overtime" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','overtime')" readonly></div>
                    <div><span class="text-xs text-gray-400">OnCall</span> <input id="inc-oncall" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','oncall')" readonly></div>
                </div>
                <div class="flex justify-between font-bold text-green-600 bg-green-50 p-2 rounded"><span>ç¸½è¨ˆ</span><span id="rep-total-inc">$0</span></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-blue-100">
                <div class="flex justify-between border-b pb-2 mb-2"><h3 class="font-bold text-blue-800 text-sm">ğŸ¦ è³‡ç”¢åº«å­˜</h3><button onclick="openInputModal('balance', -1)" class="text-xs text-blue-600">ï¼‹ å¸³æˆ¶</button></div>
                <div id="rep-acc-list"></div>
            </div>
        </div>

        <div id="investment-view" class="tab-view hidden">
            <div class="bg-white rounded-xl shadow-sm border border-indigo-200 p-4 mb-4">
                <h3 class="font-bold text-indigo-700 text-sm mb-3 flex items-center border-b border-indigo-100 pb-2"><span class="text-lg mr-2">ğŸ“ˆ</span> æŠ•è³‡é¡§å• (å…¨çŸ¥æ¨¡å¼)</h3>
                <div id="finance-chat-box" class="h-64 overflow-y-auto mb-3 text-sm space-y-2 pr-1"><div class="text-center text-gray-300 text-xs py-2">æˆ‘å¯ä»¥åˆ†ææ‚¨çš„æŒè‚¡ç‹€æ³...</div></div>
                <div class="flex gap-2"><input id="finance-chat-input" type="text" placeholder="å•é¡§å•: æˆ‘é‚„èƒ½æŠ•è³‡å—..." class="flex-grow bg-gray-50 border rounded-lg px-3 py-2 text-sm outline-none"><button onclick="sendAIChat('finance')" class="bg-indigo-600 text-white px-4 rounded-lg font-bold text-sm shadow-sm active:scale-95">ç™¼é€</button></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">æˆ‘çš„æŠ•è³‡ç­†è¨˜</h3>
                <div class="bg-gray-50 p-3 rounded-xl mb-3">
                    <div class="flex gap-2 mb-2"><input id="inv-symbol" type="text" placeholder="ä»£è™Ÿ (å¦‚: 2330)" class="w-1/3 p-2 rounded border border-gray-200 text-sm"><input id="inv-note" type="text" placeholder="è§€é» (å¦‚: çœ‹å¥½AI)" class="w-2/3 p-2 rounded border border-gray-200 text-sm"></div>
                    <button id="inv-add-btn" onclick="addInvestment()" class="w-full bg-gray-800 text-white py-2 rounded-lg text-sm font-bold shadow hover:bg-gray-700">ï¼‹ æ–°å¢ä¸¦ AI åˆ†æ</button>
                </div>
                <div id="inv-list"></div>
            </div>
        </div>

        <div id="settings-view" class="tab-view hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">ğŸ‘¤ é«”æ…‹è¨­å®š (TDEE - 500)</h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-xs text-gray-500">èº«é«˜ (cm)</label>
                        <input id="prof-height" type="number" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">é«”é‡ (kg)</label>
                        <input id="prof-weight" type="number" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">å¹´é½¡ (Age)</label>
                        <input id="prof-age" type="number" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">æ€§åˆ¥</label>
                        <select id="prof-gender" class="w-full border p-2 rounded bg-white">
                            <option value="male">ç”·</option>
                            <option value="female">å¥³</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">âš–ï¸ ç†è²¡åˆ†é…è¨­å®š</h3>
                <div class="flex items-center gap-4 mb-3">
                    <div class="flex-1">
                        <label class="text-xs text-yellow-600 block mb-1">å¨›æ¨‚ä½”æ¯” (%)</label>
                        <input id="ratio-ent" type="number" oninput="updateInvFromEnt(this.value)" class="w-full border p-2 rounded font-bold text-center text-yellow-700">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-green-600 block mb-1">æŠ•è³‡ä½”æ¯” (%)</label>
                        <input id="ratio-inv" type="number" oninput="updateEntFromInv(this.value)" class="w-full border p-2 rounded font-bold text-center text-green-700">
                    </div>
                </div>
                <button onclick="updateSettings()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold text-sm">å„²å­˜è¨­å®š (é«”æ…‹èˆ‡æ¯”ä¾‹)</button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">ğŸ¤– AI æ¨¡å‹è¨­å®š</h3>
                <div class="mb-3">
                    <label class="text-xs text-gray-500">Gemini Model</label>
                    <div class="flex gap-2 mb-2">
                        <select id="setting-model" onchange="handleModelChange(this.value)" class="flex-grow border p-2 rounded bg-white text-sm">
                            <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (New!)</option>
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                            <option value="custom">è‡ªè¨‚ Model ID</option>
                        </select>
                        <button onclick="fetchGoogleModels()" class="bg-gray-100 px-3 rounded border border-gray-300 text-lg hover:bg-gray-200">ğŸ”„</button>
                    </div>
                    <input id="setting-model-custom" type="text" placeholder="è¼¸å…¥ Model ID" class="w-full border p-2 rounded bg-gray-50 text-sm mb-2 hidden">
                    
                    <label class="text-xs text-gray-500">Gemini API Key</label>
                    <input id="setting-api-key" type="password" placeholder="è²¼ä¸Šæ‚¨çš„ API Key" class="w-full border p-2 rounded bg-gray-50 text-sm">
                </div>
                <button onclick="saveSystemConfig()" class="w-full bg-gray-800 text-white py-2 rounded-lg font-bold text-sm">å„²å­˜ Key èˆ‡æ¨¡å‹</button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">ğŸ“¦ è³‡æ–™å‚™ä»½</h3>
                <button onclick="exportData()" class="w-full bg-gray-100 text-gray-600 py-2 rounded-lg font-bold text-sm hover:bg-gray-200">åŒ¯å‡ºè³‡æ–™ (JSON)</button>
                
                <div class="mt-4 border-t pt-4">
                    <label class="text-xs text-gray-500 block mb-2">ğŸ“¥ è³‡æ–™æ•‘æ´èˆ‡åŒ¯å…¥</label>
                    <textarea id="import-json" class="w-full border p-2 rounded text-xs h-32 mb-2" placeholder="åœ¨æ­¤è²¼ä¸Šå‚™ä»½æ–‡å­—..."></textarea>
                    <button onclick="importData()" class="w-full bg-red-50 text-red-600 border border-red-200 py-2 rounded-lg font-bold text-sm hover:bg-red-100">ç¢ºèªåŒ¯å…¥</button>
                </div>
            </div>
            
            <div class="text-center mt-8 text-xs text-gray-300">Pocket Coach v18.3<br>(Added Exercise to Menu)</div>
        </div>
    </main>

    <div class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 z-30 pb-6 safe-area-pb">
        <button id="nav-dashboard" onclick="switchTab('dashboard')" class="nav-btn text-blue-600 font-bold text-xs flex flex-col items-center w-1/4"><span class="text-xl">ğŸ </span>é§•é§›è‰™</button>
        <button id="nav-finance" onclick="switchTab('finance')" class="nav-btn text-gray-400 font-bold text-xs flex flex-col items-center w-1/4"><span class="text-xl">ğŸ“Š</span>å ±è¡¨</button>
        <button id="nav-investment" onclick="switchTab('investment')" class="nav-btn text-gray-400 font-bold text-xs flex flex-col items-center w-1/4"><span class="text-xl">ğŸ“ˆ</span>æŠ•è³‡</button>
        <button id="nav-settings" onclick="switchTab('settings')" class="nav-btn text-gray-400 font-bold text-xs flex flex-col items-center w-1/4"><span class="text-xl">âš™ï¸</span>è¨­å®š</button>
    </div>
</body>
</html>
