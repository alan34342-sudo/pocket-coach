// é‡æ–°è£œä¸Šå®Œæ•´çš„ refreshUI å‡½å¼
        const refreshUI = () => {
            const todayLogs = dailyLogs.filter(l=>l.dateStr===currentDate);
            const monthLogs = dailyLogs.filter(l=>l.dateStr.startsWith(currentDate.substring(0,7)));

            // Dashboard Stats
            const kcalIn = todayLogs.reduce((a,b)=>a+(b.kcal||0),0);
            const kcalBurn = todayLogs.reduce((a,b)=>a+(b.burned||0),0);
            const todayTotalSpend = todayLogs.filter(l=>l.type.includes('finance')).reduce((a,b)=>a+(b.amount||0),0);
            
            setText('today-record-sum', `(ç¸½æ”¯å‡º: $${todayTotalSpend})`);
            setText('dash-food', `$${todayTotalSpend}`);
            setText('dash-in', kcalIn);
            setText('dash-burn', kcalBurn);
            setText('dash-remain', userProfile.targetKcal + kcalBurn - kcalIn);
            setText('current-date-display', currentDate);

            updateCategoryDropdown();

            // Log List (çœç•¥ UI æ¸²æŸ“éƒ¨åˆ†ï¼Œä¿æŒåŸæ¨£)
            const logListHtml = todayLogs.length ? todayLogs.map(l=>{
                const icon = categoryIcons[l.category] || 'ğŸ“';
                const cardDisplay = l.card ? `<span onclick="openInputModal('change_account', '${l.id}')" class="cursor-pointer text-blue-500 hover:text-blue-700 hover:underline decoration-dotted" title="é»æ“Šä¿®æ”¹å¸³æˆ¶">${l.card}</span>` : 'ç„¡';
                
                return `
                <div class="flex justify-between p-3 border-b border-gray-100 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">${icon}</span>
                        <div>
                            <div class="font-bold text-gray-700">${l.description}</div>
                            <div class="text-[10px] text-gray-400">${l.category} Â· ${cardDisplay}</div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end text-right">
                        <div class="flex items-center gap-2">
                            ${l.amount > 0 ? `<div class="font-bold">-$${l.amount}</div>` : ''}
                            <button onclick="deleteLog('${l.id}')" class="text-gray-300 hover:text-red-500 px-1 font-bold text-lg leading-none">Ã—</button>
                        </div>
                        ${l.kcal ? `<div class="text-[10px] text-green-500">æ” ${l.kcal}</div>` : ''}
                        ${l.burned ? `<div class="text-[10px] text-orange-500">æ¶ˆ ${l.burned}</div>` : ''}
                    </div>
                </div>`;
            }).join('') : '<div class="text-center text-gray-400 py-4">æœ¬æ—¥ç„¡ç´€éŒ„</div>';
            setHTML('log-list', logListHtml);

            // Fixed List Rendering (çœç•¥ UI æ¸²æŸ“éƒ¨åˆ†ï¼Œä¿æŒåŸæ¨£)
            setHTML('dash-fixed-list', fixedExpenses.map(f => {
                const spentThisMonth = monthLogs.filter(l => l.category === f.name || l.description.includes(f.name)).reduce((a,b) => a + (b.amount||0), 0);
                const remaining = f.amount - spentThisMonth;
                const isPaid = spentThisMonth > 0;
                
                return `
                <div class="flex justify-between p-2 text-sm border-b items-center">
                    <div class="flex items-center gap-2">
                        ${isPaid ? '<span class="text-green-500 text-xs">ğŸŸ¢</span>' : '<span class="text-gray-200 text-xs">âšª</span>'}
                        <div>
                            <div class="font-medium">${f.name}</div>
                            <div class="text-xs text-gray-400">å‰©é¤˜: $${remaining} Â· ç¶å®š: ${f.note}</div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold cursor-pointer hover:bg-gray-100 px-1 rounded ${remaining < 0 ? 'text-red-500' : 'text-gray-800'}" onclick="openInputModal('fixed_edit', ${f.id})">$${f.amount}</span>
                        <button onclick="removeFixed(${f.id})" class="text-red-400 ml-2">Ã—</button>
                    </div>
                </div>`;
            }).join(''));

            // --- æ ¸å¿ƒä¿®æ­£å€å¡Šé–‹å§‹ ---
            const incomeTotal = Object.values(monthlyIncome).reduce((a,b)=>a+b,0);
            const fixedTotal = fixedExpenses.reduce((a,b)=>a+b.amount,0); // å›ºå®šæ”¯å‡ºã€Œé ç®—ã€ç¸½å’Œ

            // 1. å…ˆç®—å‡ºæœ¬æœˆæ‰€æœ‰æµæ°´å¸³çš„ç¸½æ”¯å‡º
            const totalLogSpent = monthLogs.filter(l=>l.type.includes('finance')).reduce((a,b)=>a+(b.amount||0),0);
            
            // 2. æ‰¾å‡ºæµæ°´å¸³ä¸­ï¼Œå±¬æ–¼ã€Œå›ºå®šæ”¯å‡ºé¡åˆ¥ã€çš„å¯¦éš›èŠ±è²» (ä¾‹å¦‚: å¯¦éš›åƒäº†å¤šå°‘é£¯éŒ¢ã€ä»˜äº†å¤šå°‘æˆ¿ç§Ÿ)
            const fixedCatNames = fixedExpenses.map(f => f.name);
            const spentOnFixedLogs = monthLogs
                .filter(l => fixedCatNames.includes(l.category) && l.type.includes('finance'))
                .reduce((a,b) => a + (b.amount||0), 0);

            // 3. è¨ˆç®—ã€ŒçœŸæ­£çš„è®Šå‹•æ”¯å‡ºã€ (ç¸½æµæ°´å¸³ - å›ºå®šé¡åˆ¥æµæ°´å¸³)
            // é€™æ¨£å‰©ä¸‹çš„å°±æ˜¯ï¼šå¨›æ¨‚ã€æŠ•è³‡ã€ä»¥åŠå…¶ä»–éå›ºå®šé …ç›®çš„èŠ±è²»
            const realVariableSpent = totalLogSpent - spentOnFixedLogs;

            const entSpent = monthLogs.filter(l => l.category === 'å¨›æ¨‚').reduce((a,b) => a + (b.amount||0), 0);
            const invSpent = monthLogs.filter(l => l.category === 'æŠ•è³‡').reduce((a,b) => a + (b.amount||0), 0);

            const disposableIncome = incomeTotal - fixedTotal; // å¯æ”¯é… = æ”¶å…¥ - å›ºå®šé ç®—
            const monthlyRemaining = disposableIncome - realVariableSpent; // é¤˜é¡ = å¯æ”¯é… - è®Šå‹•æ”¯å‡º(ä¸å«å›ºå®š)
            // --- æ ¸å¿ƒä¿®æ­£å€å¡ŠçµæŸ ---

            setText('dash-month-remain', `$${monthlyRemaining.toLocaleString()}`);

            const entRatio = userProfile.entRatio || 20;
            const invRatio = 100 - entRatio;
            
            const entBudget = Math.floor(disposableIncome * (entRatio / 100));
            const invBudget = Math.floor(disposableIncome * (invRatio / 100));

            ['salary','bonus','overtime','oncall'].forEach(k => { const el=document.getElementById(`inc-${k}`); if(el) el.value=monthlyIncome[k]; });
            
            setText('rep-total-inc', `$${incomeTotal.toLocaleString()}`);
            setText('rep-disposable', `$${disposableIncome.toLocaleString()}`);
            setText('rep-final', `$${monthlyRemaining.toLocaleString()}`); // æ›´æ–°æœ€çµ‚é¡¯ç¤º
            
            setText('rep-ent-val', `$${(entBudget - entSpent).toLocaleString()}`);
            setText('rep-ent-label', `å¨›æ¨‚ ${entRatio}% (é ç®—$${entBudget})`);
            
            setText('rep-inv-val', `$${(invBudget - invSpent).toLocaleString()}`);
            setText('rep-inv-label', `æŠ•è³‡ ${invRatio}% (é ç®—$${invBudget})`);

            setText('rep-total-fix', `-$${fixedTotal.toLocaleString()}`);
            
            setHTML('rep-acc-list', accounts.map((a,i)=>`<div class="flex justify-between p-2 text-sm border-b"><span>${a.name}</span><div><span class="font-bold ${a.balance<0?'text-red-500':'text-blue-600'}">$${a.balance}</span> <button onclick="openInputModal('balance',${i})" class="text-gray-400 ml-2">âœ</button></div></div>`).join(''));
            
            setHTML('inv-list', investments.map(i=>`
                <div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-100">
                    <div class="flex justify-between items-start mb-2"><div><span class="bg-blue-100 text-blue-700 font-bold px-2 py-1 rounded text-xs">${i.symbol}</span><span class="text-xs text-gray-400 ml-2">${i.date}</span></div>
                    <button onclick="removeInvestment('${i.id}')" class="text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-gray-200">ğŸ—‘ï¸</button></div>
                    <div class="text-sm font-medium text-gray-800 mb-2">"${i.note}"</div>
                    <div class="text-xs bg-white p-2 rounded border border-indigo-100 text-gray-600 leading-relaxed"><strong class="text-indigo-600 block mb-1">ğŸ¤– AI åˆ†æï¼š</strong>${parseMarkdown(i.feedback)}</div>
                </div>`).join(''));

            setValue('prof-height', userProfile.height);
            setValue('prof-weight', userProfile.weight);
            setValue('prof-age', userProfile.age || 30);
            setValue('prof-gender', userProfile.gender || 'male');
            
            setValue('ratio-ent', userProfile.entRatio || 20);
            setValue('ratio-inv', 100 - (userProfile.entRatio || 20));
            
            renderCalendar();
            
            const currCat = document.getElementById('log-category').value;
            changeLogCategory(currCat);
        };
