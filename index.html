<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pocket Coach v18.19</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pocket Coach">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#ffffff">

    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%232563EB'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='300' fill='white'%3EğŸ¤–%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%232563EB'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='300' fill='white'%3EğŸ¤–%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .ai-content h3 { font-weight: 800; margin-top: 0.5em; margin-bottom: 0.2em; color: #1e40af; }
        .ai-content strong { color: #1f2937; font-weight: 700; }
        .ai-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .ai-content li { margin-bottom: 0.2em; }
        .ai-content p { margin-bottom: 0.5em; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        .hidden-input { display: none; }
        .shield-green { color: #10b981; }
        .shield-yellow { color: #f59e0b; }
        .shield-red { color: #ef4444; }
    </style>
    <script>
        // --- UI Helpers ---
        const setText = (id, text) => { const el = document.getElementById(id); if(el) el.textContent = text; };
        const setHTML = (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; };
        const setValue = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
        
        window.showToast = (m,t) => { 
            const el=document.getElementById('toast'); 
            if(!el) return;
            el.textContent=m; 
            el.className=`fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full text-white ${t==='error'?'bg-red-500': t==='info'?'bg-blue-500':'bg-black'} z-50`; 
            el.classList.remove('hidden'); 
            setTimeout(()=>el.classList.add('hidden'),2000); 
        };

        // --- Local Storage Wrapper ---
        const DB = {
            get: (key, defaultVal) => {
                const data = localStorage.getItem(`pocket_coach_${key}`);
                return data ? JSON.parse(data) : defaultVal;
            },
            set: (key, val) => {
                localStorage.setItem(`pocket_coach_${key}`, JSON.stringify(val));
            }
        };

        // --- Globals ---
        let USER_API_KEY = ""; 
        let ACTIVE_MODEL = "gemini-1.5-flash";
        
        const getLocalDate = () => {
            const d = new Date();
            return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        };

        let currentDate = getLocalDate();
        let currentViewMonth = new Date(); 
        let selectedImageBase64 = null; 
        let window_pendingLog = {};
        let uploadContext = 'log'; // 'log' or 'policy'
        
        // Portfolio Management Vars
        let currentEditingSymbol = '';
        let currentEditingAmount = 0;
        let currentInputMode = ''; 
        let currentInputId = null;

        // Chat Memory
        let chatSessionMemory = { health: [], finance: [], insurance: [] };

        // Data Models
        let accounts = [];
        let monthlyIncome = { salary: 0, bonus: 0, overtime: 0, oncall: 0 };
        let fixedExpenses = [];
        let investments = []; 
        let insurancePolicies = []; 
        let insuranceNotes = [];    
        let dailyLogs = [];
        let userProfile = { height: 172, weight: 69, age: 30, gender: 'male', tdee: 2000, targetKcal: 1500, entRatio: 20 };

        // Defaults
        const defaultAccountsList = ['åœ‹æ³°', 'éƒµå±€', 'BANK', 'åˆåº«', 'ç‰å±±', 'è¯é‚¦'];
        const defaultFixedList = [
            {name: 'é£Ÿç‰©', note: 'åœ‹æ³°', amount: 8000, id: 1}, 
            {name: 'ç”Ÿæ´»ç”¨å“', note: 'åˆåº«', amount: 1000, id: 2},
            {name: 'é›»è©±è²»', note: 'åˆåº«', amount: 500, id: 3},
            {name: 'å£½éšª', note: 'éƒµå±€', amount: 3000, id: 4},
            {name: 'ç­†é›»', note: 'è¯é‚¦', amount: 0, id: 5},
            {name: 'ä¿éšª', note: 'åœ‹æ³°', amount: 0, id: 6},
            {name: 'æ©Ÿè»Š', note: 'åˆåº«', amount: 0, id: 7},
            {name: 'é›»è²»', note: 'bank', amount: 0, id: 8}
        ];
        
        const categoryIcons = {
            'é£Ÿç‰©': 'ğŸ±', 'é¤è²»': 'ğŸ±', 
            'ç”Ÿæ´»ç”¨å“': 'ğŸ§»', 'é›»è©±è²»': 'ğŸ“', 'äº¤é€š': 'ğŸ›µ', 'äº¤é€š/æ©Ÿè»Š': 'ğŸ›µ',
            'å¨›æ¨‚': 'ğŸ¬', 'æŠ•è³‡': 'ğŸ”¥', 'é‹å‹•': 'ğŸ’ª', 'ä¿éšª': 'ğŸ¥', 'ä¿éšª/é†«ç™‚': 'ğŸ¥', 
            'å…¶ä»–': 'ğŸ“', 'é›»è²»': 'âš¡', 'å£½éšª': 'ğŸ¥', 'ç­†é›»': 'ğŸ’»', 'æ©Ÿè»Š': 'ğŸ›µ'
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            switchTab('dashboard');
        });

        const loadData = () => {
            USER_API_KEY = localStorage.getItem('gemini_api_key') || "";
            ACTIVE_MODEL = localStorage.getItem('gemini_model') || "gemini-1.5-flash";
            
            userProfile = DB.get('profile', userProfile);
            if(!userProfile.age) userProfile.age = 30;
            if(!userProfile.gender) userProfile.gender = 'male';

            const savedAcc = DB.get('accounts', null);
            accounts = savedAcc ? savedAcc : defaultAccountsList.map(name => ({name, balance: 0}));
            monthlyIncome = DB.get('income', monthlyIncome);
            const savedFix = DB.get('fixed', null);
            fixedExpenses = savedFix ? savedFix : defaultFixedList;
            investments = DB.get('investments', []);
            insurancePolicies = DB.get('insurance_policies', []); 
            insuranceNotes = DB.get('insurance_notes', []);       
            dailyLogs = DB.get('logs', []);

            const apiKeyInput = document.getElementById('setting-api-key');
            if (apiKeyInput) apiKeyInput.value = USER_API_KEY;
            
            // Model Selector Init
            const modelSelect = document.getElementById('setting-model');
            if (modelSelect) {
                const defaultModels = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-2.0-flash-exp'];
                if (defaultModels.includes(ACTIVE_MODEL)) {
                    modelSelect.value = ACTIVE_MODEL;
                } else {
                    modelSelect.value = 'custom';
                    document.getElementById('setting-model-custom').classList.remove('hidden');
                    document.getElementById('setting-model-custom').value = ACTIVE_MODEL;
                }
            }
            refreshUI(); 
        };

        const saveData = () => {
            DB.set('accounts', accounts);
            DB.set('income', monthlyIncome);
            DB.set('fixed', fixedExpenses);
            DB.set('profile', userProfile);
            DB.set('investments', investments);
            DB.set('insurance_policies', insurancePolicies); 
            DB.set('insurance_notes', insuranceNotes);       
            DB.set('logs', dailyLogs);
            refreshUI();
        };

        // --- Helper Functions ---
        
        window.closeModal = (id) => {
            document.getElementById(`${id}-modal`).classList.add('hidden');
        };

        window.toggleCalendar = () => {
            document.getElementById('calendar-wrapper').classList.toggle('hidden');
        };
        window.prevMonth = () => { currentViewMonth.setMonth(currentViewMonth.getMonth()-1); renderCalendar(); };
        window.nextMonth = () => { currentViewMonth.setMonth(currentViewMonth.getMonth()+1); renderCalendar(); };
        window.jumpToToday = () => { currentViewMonth = new Date(); renderCalendar(); };
        window.selectDate = (d) => { currentDate = d; renderCalendar(); refreshUI(); };

        window.openInputModal = (mode, id=null) => {
            currentInputMode = mode;
            currentInputId = id;
            const modal = document.getElementById('input-modal');
            const title = document.getElementById('input-modal-title');
            const noteC = document.getElementById('input-note-container');
            const valC = document.getElementById('input-default-container');
            const accC = document.getElementById('input-account-container');
            const fixC = document.getElementById('input-fixed-acc-container');
            const valInput = document.getElementById('input-value');
            const noteInput = document.getElementById('input-note');
            const lbl = document.getElementById('input-label');

            // Reset UI
            modal.classList.remove('hidden');
            noteC.classList.add('hidden');
            valC.classList.remove('hidden');
            accC.classList.add('hidden');
            fixC.classList.add('hidden');
            valInput.value = '';
            noteInput.value = '';
            valInput.placeholder = '';
            lbl.textContent = 'æ•¸å€¼';

            if(mode === 'fixed_add') {
                title.textContent = 'æ–°å¢å›ºå®šæ”¯å‡º';
                noteC.classList.remove('hidden');
                fixC.classList.remove('hidden');
                const sel = document.getElementById('input-fixed-acc-select');
                sel.innerHTML = accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
            }
            else if(mode === 'fixed_edit') {
                title.textContent = 'ç·¨è¼¯é‡‘é¡';
                const item = fixedExpenses.find(f=>f.id===id);
                if(item) valInput.value = item.amount;
            }
            else if(mode === 'balance') {
                title.textContent = id === -1 ? 'æ–°å¢å¸³æˆ¶' : 'èª¿æ•´é¤˜é¡';
                if(id === -1) {
                    noteC.classList.remove('hidden'); 
                    valInput.placeholder = 'åˆå§‹é¤˜é¡';
                } else {
                    valInput.value = accounts[id].balance;
                }
            }
            else if(mode === 'income') {
                title.textContent = 'è¨­å®šæ”¶å…¥';
                valInput.value = monthlyIncome[id]; 
            }
            else if(mode === 'investment_add') {
                 title.textContent = 'æ–°å¢æŒå€‰ (è²·å…¥)';
                 noteC.classList.remove('hidden');
                 noteInput.placeholder = 'ä»£è™Ÿ (e.g., 2330)';
                 accC.classList.remove('hidden');
                 lbl.textContent = 'ç¸½æŠ•å…¥é‡‘é¡';
                 const sel = document.getElementById('input-account-select');
                 sel.innerHTML = `<option value="none">ä¸æ‰£æ¬¾ (ç´”è¨˜å¸³)</option>` + accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
            }
            else if(mode === 'change_account') {
                title.textContent = 'è®Šæ›´æ‰£æ¬¾å¸³æˆ¶';
                valC.classList.add('hidden'); 
                accC.classList.remove('hidden');
                const sel = document.getElementById('input-account-select');
                sel.innerHTML = accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
            }
            else if(mode === 'insurance_add') {
                title.textContent = 'æ–°å¢ä¿å–®';
                noteC.classList.remove('hidden');
                noteInput.placeholder = 'ä¿å–®åç¨±';
                valC.classList.remove('hidden');
                lbl.textContent = 'å¹´ç¹³é‡‘é¡';
            }
        };

        window.submitInputModal = () => {
            const val = parseInt(document.getElementById('input-value').value) || 0;
            const note = document.getElementById('input-note').value;

            if(currentInputMode === 'fixed_add') {
                 const acc = document.getElementById('input-fixed-acc-select').value;
                 if(!note) return showToast('è«‹è¼¸å…¥åç¨±','error');
                 fixedExpenses.push({id: Date.now(), name: note, amount: val, note: acc});
            }
            else if(currentInputMode === 'fixed_edit') {
                const idx = fixedExpenses.findIndex(f=>f.id===currentInputId);
                if(idx!==-1) fixedExpenses[idx].amount = val;
            }
            else if(currentInputMode === 'balance') {
                if(currentInputId === -1) {
                    if(!note) return showToast('è«‹è¼¸å…¥å¸³æˆ¶åç¨±','error');
                    accounts.push({name: note, balance: val});
                } else {
                    accounts[currentInputId].balance = val;
                }
            }
            else if(currentInputMode === 'income') {
                monthlyIncome[currentInputId] = val;
            }
            else if(currentInputMode === 'investment_add') {
                if(!note) return showToast('è«‹è¼¸å…¥ä»£è™Ÿ','error');
                const acc = document.getElementById('input-account-select').value;
                const card = acc === 'none' ? null : acc;
                commitLog({ description: note, amount: val, category: 'æŠ•è³‡', card: card, type: 'finance' });
            }
            else if(currentInputMode === 'change_account') {
                const acc = document.getElementById('input-account-select').value;
                const idx = dailyLogs.findIndex(l=>l.id===currentInputId);
                if(idx!==-1) dailyLogs[idx].card = acc;
            }
            else if(currentInputMode === 'insurance_add') {
                if(!note) return showToast('è«‹è¼¸å…¥ä¿å–®åç¨±','error');
                insurancePolicies.push({ id: Date.now(), name: note, amount: val, date: currentDate, features: "æ‰‹å‹•è¼¸å…¥" });
            }

            saveData();
            closeModal('input');
            refreshUI();
            showToast('æ›´æ–°æˆåŠŸ', 'success');
        };

        window.addInvestment = async () => {
            const s = document.getElementById('inv-symbol').value;
            const n = document.getElementById('inv-note').value;
            if(!s || !n) return showToast("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™", "error");

            const btn = document.getElementById('inv-add-btn');
            const originalText = btn.textContent;
            btn.textContent = "AI åˆ†æä¸­..."; btn.disabled = true;

            let feedback = "";
            try {
                feedback = await callAI(`åˆ†ææŠ•è³‡è§€é»: ${s} - ${n}ã€‚è«‹çµ¦äºˆç°¡çŸ­é¢¨éšªè©•ä¼°èˆ‡å»ºè­° (50å­—å…§)ã€‚`);
                if(feedback.error) feedback = "AI ç„¡æ³•å›æ‡‰";
            } catch(e) { feedback = "æš«ç„¡åˆ†æ"; }

            investments.unshift({ id: Date.now().toString(), date: currentDate, symbol: s, note: n, feedback: feedback });
            saveData();
            document.getElementById('inv-symbol').value = '';
            document.getElementById('inv-note').value = '';
            btn.textContent = originalText; btn.disabled = false;
        };

        // New Insurance Functions
        window.addInsuranceNote = async () => {
            const n = document.getElementById('ins-note-input').value;
            if(!n) return showToast("è«‹è¼¸å…¥ç­†è¨˜", "error");

            const btn = document.getElementById('ins-add-btn');
            const originalText = btn.textContent;
            btn.textContent = "AI åˆ†æä¸­..."; btn.disabled = true;

            let feedback = "";
            try {
                feedback = await callAI(`è§’è‰²:å°ˆæ¥­ä¿éšªé¡§å•ã€‚åˆ†æç”¨æˆ¶ä¿éšªç­†è¨˜: "${n}"ã€‚è«‹çµ¦äºˆç°¡çŸ­ã€å°ˆæ¥­çš„å»ºè­°æˆ–ç›²é»æé†’ (50å­—å…§)ã€‚`);
                if(feedback.error) feedback = "AI ç„¡æ³•å›æ‡‰";
            } catch(e) { feedback = "æš«ç„¡åˆ†æ"; }

            insuranceNotes.unshift({ id: Date.now().toString(), date: currentDate, note: n, feedback: feedback });
            saveData();
            document.getElementById('ins-note-input').value = '';
            btn.textContent = originalText; btn.disabled = false;
        };

        window.runInsuranceScenario = async (type) => {
            const chatBox = document.getElementById('insurance-chat-box');
            chatBox.innerHTML += `<div class="flex justify-end mb-2"><div class="bg-cyan-600 text-white py-2 px-3 rounded-2xl rounded-tr-none text-sm">ğŸš¨ æ¨¡æ“¬æƒ…å¢ƒï¼š${type}</div></div>`;
            const loadingId = Date.now();
            chatBox.innerHTML += `<div id="${loadingId}" class="flex justify-start mb-2"><div class="bg-white border border-gray-200 text-gray-500 py-2 px-3 rounded-2xl rounded-tl-none text-xs">AI æ­£åœ¨è¨ˆç®—ç†è³ ...</div></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            const policiesStr = insurancePolicies.map(p => `${p.name} (é¡åº¦/ä¿è²»: $${p.amount}, ç‰¹è‰²: ${p.features})`).join(', ');
            const prompt = `è§’è‰²:å°ˆæ¥­ä¿éšªç†è³ å°ˆå®¶ã€‚ç”¨æˆ¶ç¾æœ‰ä¿å–®: [${policiesStr}]ã€‚
            æƒ…å¢ƒ: ç”¨æˆ¶ç™¼ç”Ÿã€Œ${type}ã€ã€‚
            ä»»å‹™:
            1. ç›¤é»å“ªäº›ä¿å–®å¯èƒ½å•Ÿå‹•ç†è³ ã€‚
            2. ç²—ä¼°å¯èƒ½çš„ç†è³ ç¯„åœ (è‹¥ç„¡è³‡æ–™è«‹çµ¦å‡ºä¸€èˆ¬æ€§å»ºè­°)ã€‚
            3. æé†’éœ€è¦æº–å‚™çš„æ–‡ä»¶æˆ–æ³¨æ„äº‹é …ã€‚
            è«‹ç”¨æ¢åˆ—å¼ã€ç™½è©±æ–‡å›ç­”ã€‚`;

            try {
                const res = await callAI(prompt);
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="flex justify-start mb-4"><div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-2 text-lg flex-shrink-0">ğŸ¤–</div><div class="bg-white text-gray-800 py-3 px-4 rounded-2xl rounded-tl-none text-sm shadow-sm border border-gray-100 max-w-[90%]">${parseMarkdown(res)}</div></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
                
                chatSessionMemory['insurance'].push({role: 'user', text: `æ¨¡æ“¬æƒ…å¢ƒï¼š${type}`});
                chatSessionMemory['insurance'].push({role: 'model', text: res});
            } catch(e) {
                document.getElementById(loadingId).remove();
                showToast("æ¨¡æ“¬å¤±æ•—", "error");
            }
        };

        window.removeInsuranceNote = (id) => {
            if(!confirm('åˆªé™¤æ­¤ç­†è¨˜ï¼Ÿ')) return;
            insuranceNotes = insuranceNotes.filter(i=>i.id!==id);
            saveData();
        };

        window.removePolicy = (id) => {
            if(!confirm('åˆªé™¤æ­¤ä¿å–®ï¼Ÿ')) return;
            insurancePolicies = insurancePolicies.filter(p=>p.id!==id);
            saveData();
        };

        window.removeInvestment = (id) => {
            if(!confirm('åˆªé™¤æ­¤ç­†è¨˜ï¼Ÿ')) return;
            investments = investments.filter(i=>i.id!==id);
            saveData();
        };

        window.toggleManualInput = (mode) => {
            const block = document.getElementById('manual-nutrition-block');
            if(!block) return;
            if (mode === 'none') { block.classList.add('hidden'); } 
            else {
                block.classList.remove('hidden');
                const kcalC = document.getElementById('manual-kcal-container');
                const protC = document.getElementById('manual-protein-container');
                if (mode === 'food') {
                    document.getElementById('manual-hint-text').textContent = 'âœï¸ æ‰‹å‹•è¼¸å…¥ç‡Ÿé¤Š (è‹¥å¡«å¯«å°‡ä¸ä½¿ç”¨AIä¼°ç®—)';
                    document.getElementById('manual-kcal-label').textContent = 'ğŸ”¥';
                    kcalC.classList.remove('w-full'); kcalC.classList.add('flex-1');
                    protC.classList.remove('hidden');
                } else {
                    document.getElementById('manual-hint-text').textContent = 'âœï¸ æ‰‹å‹•è¼¸å…¥æ¶ˆè€—';
                    document.getElementById('manual-kcal-label').textContent = 'ğŸƒ';
                    kcalC.classList.remove('flex-1'); kcalC.classList.add('w-full');
                    protC.classList.add('hidden');
                }
            }
        };

        window.changeLogCategory = (v) => {
            const cardSel = document.getElementById('log-card'); 
            const amtInput = document.getElementById('log-amount'); 
            const btn = document.getElementById('unified-log-btn');
            
            if(!cardSel || !amtInput || !btn) return;

            if (v === 'é‹å‹•') { 
                cardSel.disabled = true; 
                cardSel.innerHTML = '<option>ç„¡</option>';
                amtInput.placeholder = 'ç„¡'; 
                amtInput.value = 0; 
                amtInput.disabled = true; 
                btn.textContent = 'ğŸ”¥ è¨˜éŒ„'; 
                
                toggleManualInput('exercise');
            } else { 
                cardSel.disabled = false; 
                amtInput.placeholder = '$'; 
                amtInput.disabled = false; 
                btn.textContent = 'ğŸ’° è¨˜éŒ„';
                
                if(v === 'é£Ÿç‰©' || v === 'é¤è²»') toggleManualInput('food');
                else toggleManualInput('none');
                
                let targetSelectAccount = '';
                let budgetInfo = '';
                const fixedItem = fixedExpenses.find(f => f.name === v);

                if (v === 'å¨›æ¨‚' || v === 'æŠ•è³‡') {
                    const incomeTotal = Object.values(monthlyIncome).reduce((a,b)=>a+b,0);
                    const fixedTotal = fixedExpenses.reduce((a,b)=>a+b.amount,0);
                    const disposable = incomeTotal - fixedTotal;
                    const ratio = v === 'å¨›æ¨‚' ? (userProfile.entRatio || 20) : (100 - (userProfile.entRatio || 20));
                    const totalBudget = Math.floor(disposable * (ratio / 100));
                    
                    const monthStart = currentDate.substring(0, 7);
                    const monthLogs = dailyLogs.filter(l => l.dateStr.startsWith(monthStart));
                    const spent = monthLogs.filter(l => l.category === v && !l.isAdjustment).reduce((a, b) => a + (b.amount || 0), 0);
                    const remaining = totalBudget - spent;
                    
                    budgetInfo = ` (é ç®—å‰©: $${remaining})`;
                }
                else if (fixedItem) {
                    const monthStart = currentDate.substring(0, 7);
                    const monthLogs = dailyLogs.filter(l => l.dateStr.startsWith(monthStart));
                    const spent = monthLogs.filter(l => l.category === v && !l.isAdjustment).reduce((a, b) => a + (b.amount || 0), 0);
                    const remaining = fixedItem.amount - spent;
                    budgetInfo = ` (é ç®—å‰©: $${remaining})`;
                    targetSelectAccount = fixedItem.note; 
                }

                const optionsHtml = accounts.map(a => {
                    let label = `${a.name} ($${a.balance})`; 
                    if (fixedItem && a.name === targetSelectAccount) {
                        label = `âœ” ${a.name}${budgetInfo}`; 
                    }
                    const isSelected = (a.name === targetSelectAccount);
                    return `<option value="${a.name}" ${isSelected ? 'selected' : ''}>${label}</option>`;
                }).join('') + '<option value="custom">â• è‡ªè¨‚...</option>';

                cardSel.innerHTML = optionsHtml;
                
                if (v === 'å¨›æ¨‚' || v === 'æŠ•è³‡') {
                    Array.from(cardSel.options).forEach(opt => {
                        if (opt.value !== 'custom') {
                            opt.text = `${opt.text} ${budgetInfo}`;
                        }
                    });
                }
            }
        };

        const updateCategoryDropdown = () => {
            const select = document.getElementById('log-category');
            if(!select) return;
            const currentVal = select.value;
            let fixedNames = fixedExpenses.map(f => f.name);
            fixedNames = fixedNames.filter(n => n !== 'é£Ÿç‰©');
            const hasFood = fixedExpenses.some(f => f.name === 'é£Ÿç‰©');
            let finalCats = [];
            if (hasFood) finalCats.push('é£Ÿç‰©');
            finalCats.push('å¨›æ¨‚', 'æŠ•è³‡', 'é‹å‹•');
            finalCats = [...finalCats, ...fixedNames];
            finalCats = [...new Set(finalCats)];

            select.innerHTML = finalCats.map(c => {
                const icon = categoryIcons[c] || 'ğŸ“'; 
                return `<option value="${c}">${icon} ${c}</option>`;
            }).join('');
            
            if(finalCats.includes(currentVal)) select.value = currentVal;
            else if(finalCats.length > 0) select.value = finalCats[0];
        };

        const renderCalendar = () => {
            const calContainer = document.getElementById('calendar-grid');
            if(!calContainer) return;
            const monthLabel = document.getElementById('current-month-label');
            const y = currentViewMonth.getFullYear();
            const m = currentViewMonth.getMonth();
            monthLabel.textContent = `${y}å¹´ ${m+1}æœˆ`;

            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            
            let html = '';
            for(let i=0; i<firstDay; i++) html += `<div></div>`;
            
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasLog = dailyLogs.some(l => l.dateStr === dateStr);
                const isSelected = dateStr === currentDate;
                html += `<div onclick="selectDate('${dateStr}')" class="h-8 flex flex-col items-center justify-center rounded-full cursor-pointer relative ${isSelected ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}"><span class="text-xs font-bold">${d}</span>${hasLog ? `<span class="w-1 h-1 rounded-full ${isSelected ? 'bg-white' : 'bg-green-500'} absolute bottom-1"></span>` : ''}</div>`;
            }
            calContainer.innerHTML = html;
        };

        // --- Core Calc ---
        const calculateTDEE = (w, h, age, gender) => { const s = gender === 'male' ? 5 : -161; const bmr = (10 * w) + (6.25 * h) - (5 * age) + s; const tdee = Math.round(bmr * 1.375); return { tdee, target: tdee - 500 }; };

        window.updateInvFromEnt = (val) => { let ent = parseInt(val) || 0; if (ent > 100) ent = 100; if (ent < 0) ent = 0; document.getElementById('ratio-inv').value = 100 - ent; };
        window.updateEntFromInv = (val) => { let inv = parseInt(val) || 0; if (inv > 100) inv = 100; if (inv < 0) inv = 0; document.getElementById('ratio-ent').value = 100 - inv; };

        window.updateSettings = () => {
            const h = parseInt(document.getElementById('prof-height').value)||172;
            const w = parseInt(document.getElementById('prof-weight').value)||69;
            const age = parseInt(document.getElementById('prof-age').value)||30;
            const gender = document.getElementById('prof-gender').value;
            const entR = parseInt(document.getElementById('ratio-ent').value)||20;
            
            const res = calculateTDEE(w, h, age, gender);
            userProfile = { ...userProfile, height: h, weight: w, age: age, gender: gender, tdee: res.tdee, targetKcal: res.target, entRatio: entR };
            saveData();
            showToast('è¨­å®šå·²æ›´æ–° (TDEEå·²é‡ç®—)', 'success');
        };

        window.saveSystemConfig = () => {
            const key = document.getElementById('setting-api-key').value.trim();
            const modelSelect = document.getElementById('setting-model');
            const customInput = document.getElementById('setting-model-custom');
            let model = modelSelect.value;
            if (model === 'custom') model = customInput.value.trim();
            USER_API_KEY = key;
            ACTIVE_MODEL = model;
            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('gemini_model', model);
            showToast('è¨­å®šå·²å„²å­˜', 'success');
        };

        window.handleModelChange = (val) => {
            const customInput = document.getElementById('setting-model-custom');
            if(val === 'custom') customInput.classList.remove('hidden');
            else customInput.classList.add('hidden');
        };

        // --- Data Import/Export ---
        window.exportData = () => {
            const data = { accounts, monthlyIncome, fixedExpenses, investments, insurancePolicies, insuranceNotes, dailyLogs, userProfile };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pocket_coach_backup_${currentDate}.json`;
            a.click();
        };

        window.importData = () => {
            const jsonStr = document.getElementById('import-json').value.trim();
            if (!jsonStr) return showToast("è«‹è²¼ä¸Šå‚™ä»½è³‡æ–™", "error");
            try {
                const data = JSON.parse(jsonStr);
                if (Array.isArray(data)) {
                    if(confirm("âš ï¸ åµæ¸¬åˆ°ç´”è¨˜å¸³ç´€éŒ„ã€‚\næ˜¯å¦åŒ¯å…¥ä¸¦è¦†è“‹ç¾æœ‰ç´€éŒ„ï¼Ÿ")) { DB.set('logs', data); location.reload(); }
                    return;
                }
                if (confirm("âš ï¸ é€™å°‡è¦†è“‹æ‰€æœ‰è¨­å®šèˆ‡ç´€éŒ„ï¼\nç¢ºå®šè¦åŒ¯å…¥å—ï¼Ÿ")) {
                    if(data.accounts) DB.set('accounts', data.accounts);
                    if(data.monthlyIncome) DB.set('income', data.monthlyIncome);
                    if(data.fixedExpenses) DB.set('fixed', data.fixedExpenses);
                    if(data.investments) DB.set('investments', data.investments);
                    if(data.insurancePolicies) DB.set('insurance_policies', data.insurancePolicies); // Import Insurance
                    if(data.insuranceNotes) DB.set('insurance_notes', data.insuranceNotes);       // Import Insurance Notes
                    if(data.dailyLogs) DB.set('logs', data.dailyLogs);
                    if(data.userProfile) DB.set('profile', data.userProfile);
                    location.reload();
                }
            } catch (e) { alert("åŒ¯å…¥å¤±æ•—: " + e.message); }
        };
        
        window.fetchGoogleModels = async () => {
            const apiKey = document.getElementById('setting-api-key').value.trim() || USER_API_KEY;
            if (!apiKey) return showToast("è«‹è¼¸å…¥ API Key", "error");
            const btn = document.querySelector('button[onclick="fetchGoogleModels()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³'; btn.disabled = true;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (!response.ok) throw new Error("æŠ“å–å¤±æ•—");
                const data = await response.json();
                const chatModels = (data.models || []).filter(m => m.supportedGenerationMethods.includes("generateContent") && m.name.includes("gemini")).map(m => m.name.replace('models/', '')).sort((a, b) => b.localeCompare(a));
                const select = document.getElementById('setting-model');
                select.innerHTML = '';
                chatModels.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; select.appendChild(opt); });
                const customOpt = document.createElement('option'); customOpt.value = 'custom'; customOpt.textContent = 'âœï¸ æ‰‹å‹•è¼¸å…¥...'; select.appendChild(customOpt);
                showToast(`å·²æ›´æ–° ${chatModels.length} å€‹æ¨¡å‹`, "success");
            } catch (e) { showToast(`æ›´æ–°å¤±æ•—: ${e.message}`, "error"); } 
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        };

        // --- AI Core ---
        const parseMarkdown = (text) => {
            if (!text) return '';
            let html = text.replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/^## (.*$)/gim, '<h3>$1</h3>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/^\* (.*$)/gim, '<ul><li>$1</li></ul>').replace(/^- (.*$)/gim, '<ul><li>$1</li></ul>').replace(/\n/g, '<br>');
            html = html.replace(/<\/ul><br><ul>/g, '');
            return `<div class="ai-content text-gray-700 leading-relaxed">${html}</div>`;
        };
        
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const callAI = async (prompt, imgBase64 = null) => {
            if(!USER_API_KEY) return { error: "è«‹å…ˆåœ¨ [è¨­å®š] è¼¸å…¥ API Key" };
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${ACTIVE_MODEL}:generateContent?key=${USER_API_KEY}`;
            const parts = [{text: prompt}];
            if (imgBase64) parts.push({ inlineData: { mimeType: "image/jpeg", data: imgBase64 } });
            const payload = {contents:[{parts: parts}]};
            let retries = 0; const maxRetries = 2; let delay = 1000;
            while (retries <= maxRetries) {
                try {
                    const r = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    if (r.status === 429 || r.status === 503) { await wait(delay); retries++; delay *= 2; continue; }
                    if (r.status === 404 && ACTIVE_MODEL !== "gemini-1.5-flash") { ACTIVE_MODEL = "gemini-1.5-flash"; return callAI(prompt, imgBase64); }
                    if (!r.ok) throw new Error(`API Error (${r.status})`);
                    const json = await r.json();
                    const txt = json.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!txt) throw new Error("Empty Response");
                    if (prompt.includes('JSON')) { const jsonMatch = txt.match(/\{[\s\S]*\}/); return jsonMatch ? JSON.parse(jsonMatch[0]) : {kcal:0, protein:0, burned:0}; }
                    return txt;
                } catch (e) { if (retries === maxRetries) { const isJson = prompt.includes('JSON'); if(isJson) return { error: e.message }; return `[ç³»çµ±éŒ¯èª¤] ${e.message}`; } await wait(delay); retries++; delay *= 2; }
            }
        };

        window.sendAIChat = async (contextType) => {
            if(!USER_API_KEY) return showToast("è«‹å…ˆè‡³è¨­å®šé é¢è¼¸å…¥ API Key", "error");
            const inputId = `${contextType}-chat-input`; const containerId = `${contextType}-chat-box`;
            const input = document.getElementById(inputId); const msg = input.value.trim(); if(!msg) return;
            const chatBox = document.getElementById(containerId);
            chatBox.innerHTML += `<div class="flex justify-end mb-2"><div class="bg-blue-600 text-white py-2 px-3 rounded-2xl rounded-tr-none text-sm max-w-[85%]">${msg}</div></div>`;
            input.value = ''; chatBox.scrollTop = chatBox.scrollHeight;
            const loadingId = Date.now();
            chatBox.innerHTML += `<div id="${loadingId}" class="flex justify-start mb-2"><div class="bg-white border border-gray-200 text-gray-500 py-2 px-3 rounded-2xl rounded-tl-none text-xs">AI æ€è€ƒä¸­...</div></div>`;

            try {
                // Prepare Context
                const monthStart = currentDate.substring(0, 7);
                const todayLogs = dailyLogs.filter(l=>l.dateStr===currentDate);
                const monthLogs = dailyLogs.filter(l=>l.dateStr.startsWith(monthStart));
                
                // Get History
                const history = chatSessionMemory[contextType] || [];
                const historyStr = history.slice(-10).map(h => `${h.role === 'user' ? 'ç”¨æˆ¶' : 'AI'}: ${h.text}`).join('\n'); // Limit to last 10 turns

                let context = "";
                if(contextType === 'health') {
                    const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const healthHistory = dailyLogs.filter(l => l.kcal > 0 && new Date(l.dateStr) >= sevenDaysAgo).map(l => `${l.dateStr}: ${l.description} (${l.kcal}kcal)`).join("\n");
                    const kcalIn = todayLogs.reduce((a,b)=>a+(b.kcal||0),0);
                    const burned = todayLogs.reduce((a,b)=>a+(b.burned||0),0);
                    context = `è§’è‰²:ç‡Ÿé¤Šæ•™ç·´ã€‚æ•¸æ“š: èº«é«˜${userProfile.height}cm/é«”é‡${userProfile.weight}kg, ç›®æ¨™${userProfile.targetKcal}kcalã€‚ä»Šæ—¥æ”${kcalIn}/æ¶ˆ${burned}ã€‚è¿‘æœŸç´€éŒ„:${healthHistory}ã€‚è«‹ç°¡çŸ­å›ç­”ã€‚è«‹è¨˜ä½å°è©±ä¸Šä¸‹æ–‡ã€‚`;
                } else if (contextType === 'finance') {
                    const incomeTotal = Object.values(monthlyIncome).reduce((a,b)=>a+b,0);
                    const fixedTotal = fixedExpenses.reduce((a,b)=>a+b.amount,0);
                    const disposable = incomeTotal - fixedTotal;
                    const entRatio = userProfile.entRatio || 20;
                    const entBudget = Math.round(disposable * (entRatio/100));
                    const entSpent = monthLogs.filter(l => l.category === 'å¨›æ¨‚').reduce((a,b) => a + (b.amount||0), 0);
                    const totalAsset = accounts.reduce((a,b)=>a+b.balance,0);
                    const invContext = investments.map(i => `${i.symbol}: ${i.note}`).join(", ");
                    
                    // Cross-reference Insurance
                    const insTotal = insurancePolicies.reduce((a,b)=>a+(b.amount||0),0);
                    const insContext = `ä¿éšªå¹´ç¹³:$${insTotal}ã€‚`;

                    const portfolio = {};
                    dailyLogs.filter(l => l.category === 'æŠ•è³‡').forEach(l => { portfolio[l.description.trim()] = (portfolio[l.description.trim()] || 0) + (l.amount || 0); });
                    const portStr = Object.entries(portfolio).map(([k,v]) => `${k}:$${v}`).join(", ");

                    context = `è§’è‰²:ç†è²¡é¡§å•ã€‚æœˆæ”¶${incomeTotal}, å›ºå®šæ”¯${fixedTotal}, å¯æ”¯é…${disposable}ã€‚å¨›æ¨‚å‰©${entBudget - entSpent}ã€‚ç¸½è³‡ç”¢${totalAsset}ã€‚æŒå€‰:[${portStr}]ã€‚${insContext} è§€é»:[${invContext}]ã€‚è«‹ç°¡çŸ­å›ç­”ã€‚è«‹è¨˜ä½å°è©±ä¸Šä¸‹æ–‡ã€‚`;
                } else if (contextType === 'insurance') {
                    const totalPremium = insurancePolicies.reduce((a,b)=>a+(b.amount||0),0);
                    const policiesStr = insurancePolicies.map(p => `${p.name}($${p.amount})`).join(', ');
                    
                    // Cross-reference Finance
                    const totalAsset = accounts.reduce((a,b)=>a+b.balance,0);
                    const finContext = `ç›®å‰ç¸½è³‡ç”¢:$${totalAsset}ã€‚`;

                    context = `è§’è‰²:ä¿éšªé¡§å•ã€‚ç”¨æˆ¶: ${userProfile.age}æ­², ${userProfile.gender==='male'?'ç”·':'å¥³'}ã€‚${finContext} ç¾æœ‰ä¿å–®: [${policiesStr}]ã€‚å¹´ç¹³ç¸½ä¿è²»: $${totalPremium}ã€‚è«‹ç°¡çŸ­å›ç­”ç”¨æˆ¶å•é¡Œã€‚è«‹è¨˜ä½å°è©±ä¸Šä¸‹æ–‡ã€‚`;
                }

                // Construct full prompt with history
                const fullPrompt = `${context}\n\n[å°è©±æ­·å²]\n${historyStr}\n\nç”¨æˆ¶å•: ${msg}`;

                const res = await callAI(fullPrompt);
                
                // Save to Memory
                chatSessionMemory[contextType].push({ role: 'user', text: msg });
                const displayNum = typeof res === 'object' ? `AI Error: ${res.error}` : res; 
                chatSessionMemory[contextType].push({ role: 'model', text: displayNum });

                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="flex justify-start mb-4"><div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-2 text-lg flex-shrink-0">ğŸ¤–</div><div class="bg-white text-gray-800 py-3 px-4 rounded-2xl rounded-tl-none text-sm shadow-sm border border-gray-100 max-w-[90%]">${parseMarkdown(displayNum)}</div></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch(e) { 
                document.getElementById(loadingId).remove();
                showToast(`AI å¤±æ•—: ${e.message}`, "error"); 
                chatBox.innerHTML += `<div class="flex justify-start mb-4"><div class="text-red-500 text-xs">ç™¼é€å¤±æ•—: ${e.message}</div></div>`;
            }
        };

        // --- Standard Features ---
        window.handleUnifiedLog = async () => {
            const description = document.getElementById('log-description').value;
            const amount = parseInt(document.getElementById('log-amount').value)||0;
            const category = document.getElementById('log-category').value;
            let card = document.getElementById('log-card').value;
            const manualKcal = document.getElementById('log-manual-kcal').value;
            const manualProtein = document.getElementById('log-manual-protein').value;
            
            if(card==='custom') {
                card = document.getElementById('finance-card-custom').value;
                if(!accounts.find(a=>a.name===card)) { accounts.push({name:card, balance:0}); saveData(); }
            }

            if(!description) return showToast('è«‹è¼¸å…¥æè¿°', 'error');
            const btn = document.getElementById('unified-log-btn');
            btn.disabled = true; btn.textContent = 'AI é‹ç®—ä¸­...';

            try {
                if(category === 'é£Ÿç‰©' || category === 'é¤è²»') {
                    if (manualKcal || manualProtein) {
                          commitLog({ description, amount, category, card, type: 'finance_health', kcal: parseInt(manualKcal)||0, protein: parseInt(manualProtein)||0 });
                          showToast('è¨˜å¸³æˆåŠŸ', 'success');
                          setTimeout(resetLogForm, 50); // Delay clear
                    } else {
                        const res = await callAI(`åˆ†æé£Ÿç‰©ç‡Ÿé¤Š:${description}ã€‚è«‹åªå›å‚³JSONæ ¼å¼: {"kcal": æ•¸å­—, "protein": æ•¸å­—}ã€‚`, selectedImageBase64);
                        if(res.error) throw new Error(res.error);
                        window.pendingLog = { description, amount, category, card, type: 'finance_health' };
                        setupVerifyModal('food', res);
                    }
                } 
                else if (category === 'é‹å‹•') {
                    if (manualKcal) {
                          commitLog({ description, amount: 0, category, card: '', type: 'exercise', burned: parseInt(manualKcal)||0 });
                          showToast('ç´€éŒ„æˆåŠŸ', 'success');
                          setTimeout(resetLogForm, 50);
                    } else {
                        const res = await callAI(`åˆ†æé‹å‹•æ¶ˆè€—:${description}ã€‚ä½¿ç”¨è€…${userProfile.weight}å…¬æ–¤ã€‚é è¨­30åˆ†ã€‚åªå›å‚³JSON: {"burned": æ•¸å­—}ã€‚`);
                        if(res.error) throw new Error(res.error);
                        window.pendingLog = { description, amount: 0, category, card: '', type: 'exercise' };
                        setupVerifyModal('exercise', res);
                    }
                } 
                else {
                    commitLog({ description, amount, category, card, type: 'finance' });
                    showToast('è¨˜å¸³æˆåŠŸ', 'success');
                    setTimeout(resetLogForm, 50);
                }
            } catch(e) { 
                showToast(`AI éŒ¯èª¤: ${e.message}`, 'error');
                if(category === 'é£Ÿç‰©' || category === 'é¤è²»') { window.pendingLog = { description, amount, category, card, type: 'finance_health' }; setupVerifyModal('food', {kcal:0, protein:0}); }
                else if(category === 'é‹å‹•') { window.pendingLog = { description, amount: 0, category, card: '', type: 'exercise' }; setupVerifyModal('exercise', {burned:0}); }
                else { commitLog({ description, amount, category, card, type: 'finance' }); setTimeout(resetLogForm, 50); }
            } 
            finally { btn.disabled=false; btn.textContent = category==='é‹å‹•' ? 'ğŸ”¥ è¨˜éŒ„' : 'ğŸ’° è¨˜éŒ„'; }
        };

        const setupVerifyModal = (mode, data) => {
            const container = document.getElementById('verify-inputs');
            document.getElementById('verify-title').textContent = mode === 'food' ? 'ç¢ºèªç‡Ÿé¤Š' : 'ç¢ºèªæ¶ˆè€—';
            if (mode === 'food') {
                container.innerHTML = `<div class="flex gap-2 mb-2"><div class="flex-1"><label class="text-xs text-red-500 font-bold">ç†±é‡</label><input id="verify-kcal" type="number" value="${data.kcal||0}" class="w-full border-2 border-red-100 p-2 rounded text-xl text-center"></div><div class="flex-1"><label class="text-xs text-green-500 font-bold">è›‹ç™½</label><input id="verify-protein" type="number" value="${data.protein||0}" class="w-full border-2 border-green-100 p-2 rounded text-xl text-center"></div></div>`;
            } else {
                container.innerHTML = `<div class="mb-2"><label class="text-xs text-orange-500 font-bold">æ¶ˆè€—</label><input id="verify-burned" type="number" value="${data.burned||0}" class="w-full border-2 border-orange-100 p-2 rounded text-xl text-center"></div>`;
            }
            document.getElementById('verify-modal').classList.remove('hidden');
        };

        window.confirmVerifyLog = () => {
            try {
                const mode = window.pendingLog.type;
                let extra = {};
                if (mode === 'finance_health') { extra.kcal = parseInt(document.getElementById('verify-kcal').value)||0; extra.protein = parseInt(document.getElementById('verify-protein').value)||0; } 
                else if (mode === 'exercise') { extra.burned = parseInt(document.getElementById('verify-burned').value)||0; }
                commitLog({ ...window.pendingLog, ...extra });
                showToast('ç´€éŒ„å®Œæˆ', 'success');
            } catch(e) { console.error(e); }
            finally {
                closeModal('verify');
                setTimeout(resetLogForm, 50); // Robust clear
            }
        };

        const commitLog = (d) => {
            const logData = { id: Date.now().toString(), timestamp: new Date().toISOString(), dateStr: currentDate, ...d };
            dailyLogs.unshift(logData);
            if(d.amount !== 0 && d.card) { 
                const idx = accounts.findIndex(a=>a.name===d.card);
                if(idx!==-1) accounts[idx].balance -= d.amount;
            }
            try {
                saveData();
            } catch(e) {
                console.error(e);
                showToast("è³‡æ–™å·²å„²å­˜ä½†ç•«é¢æ›´æ–°å¤±æ•—", "error");
            }
        };

        window.deleteLog = (id) => {
            if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ(é‡‘é¡å°‡é€€å›)")) return;
            const idx = dailyLogs.findIndex(l => l.id === id);
            if(idx === -1) return;
            const log = dailyLogs[idx];
            if (log.amount !== 0 && log.card) {
                const accIdx = accounts.findIndex(a => a.name === log.card);
                if(accIdx !== -1) accounts[accIdx].balance += log.amount; 
            }
            dailyLogs.splice(idx, 1);
            saveData();
            showToast('å·²åˆªé™¤', 'success');
        }

        const resetLogForm = () => {
            try {
                const desc = document.getElementById('log-description');
                const amt = document.getElementById('log-amount');
                const mk = document.getElementById('log-manual-kcal');
                const mp = document.getElementById('log-manual-protein');
                const cat = document.getElementById('log-category');
                
                if(desc) desc.value = '';
                if(amt) amt.value = '';
                if(mk) mk.value = '';
                if(mp) mp.value = '';
                
                if(cat) changeLogCategory(cat.value);
                setHTML('image-preview', '');
                selectedImageBase64 = null;
            } catch(e) { console.error("Reset Error", e); }
        };

        // --- Portfolio Manager Logic (Improved) ---
        window.openPortfolioModal = (symbol, currentAmt) => {
            currentEditingSymbol = symbol;
            currentEditingAmount = currentAmt;
            
            setText('port-modal-title', `ç®¡ç†æŒå€‰: ${symbol}`);
            setValue('port-current', currentAmt);
            setValue('port-target', currentAmt); 
            
            document.getElementById('portfolio-action-modal').classList.remove('hidden');
        };

        window.submitPortfolioUpdate = () => {
            const target = parseInt(document.getElementById('port-target').value) || 0;
            const diff = target - currentEditingAmount;
            
            if (diff === 0) { closeModal('portfolio-action'); return; }
            
            const desc = currentEditingSymbol; 
            const card = null; // å¼·åˆ¶ä¸é€£å‹•å¸³æˆ¶
            
            // åŠ å…¥ isAdjustment æ¨™è¨˜ï¼Œé¿å…è¨ˆå…¥ã€Œä»Šæ—¥æ”¯å‡ºã€
            commitLog({ description: desc, amount: diff, category: 'æŠ•è³‡', card: card, type: 'finance', isAdjustment: true });
            
            showToast('æŒå€‰å·²æ›´æ–° (ä¸å½±éŸ¿æ”¯å‡º/é¤˜é¡)', 'success');
            closeModal('portfolio-action');
        };

        window.deletePortfolioSymbol = () => {
            try {
                if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${currentEditingSymbol}ã€çš„æ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿ\n\n(æ³¨æ„ï¼šè‹¥ç•¶åˆæœ‰ç¶å®šæ‰£æ¬¾å¸³æˆ¶ï¼Œé‡‘é¡å°‡æœƒé€€å›)`)) return;
                
                const targetSym = String(currentEditingSymbol).trim();
                const logsToRemove = dailyLogs.filter(l => l.category === 'æŠ•è³‡' && String(l.description).trim() === targetSym);
                
                if (logsToRemove.length === 0) { showToast("æ‰¾ä¸åˆ°ç´€éŒ„", "error"); return; }

                logsToRemove.forEach(log => {
                    if (log.amount !== 0 && log.card) {
                        const accIdx = accounts.findIndex(a => a.name === log.card);
                        if(accIdx !== -1) accounts[accIdx].balance += log.amount;
                    }
                });
                
                dailyLogs = dailyLogs.filter(l => !(l.category === 'æŠ•è³‡' && String(l.description).trim() === targetSym));
                saveData();
                showToast('å·²æ¸…ç©ºæ­¤æ¨™çš„', 'success');
            } catch(e) {
                console.error(e);
                showToast("åˆªé™¤å¤±æ•—: " + e.message, "error");
            } finally {
                closeModal('portfolio-action');
            }
        };

        // --- Other Utils ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const maxWidth = 1024; 
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        window.handleImageUpload = async (e) => {
            const f = e.target.files[0];
            if(f) { 
                showToast("è™•ç†åœ–ç‰‡ä¸­...", "info");
                try {
                    const url = await compressImage(f);
                    if(uploadContext === 'policy') {
                        await analyzePolicyImage(url);
                        closeModal('camera-choice');
                    } else {
                        selectedImageBase64 = url.split(',')[1]; 
                        setHTML('image-preview', `<img src="${url}" class="h-16 rounded shadow-sm border">`); 
                        closeModal('camera-choice');
                    }
                } catch(err) { showToast("åœ–ç‰‡å¤±æ•—", "error"); }
            }
        };

        window.analyzePolicyImage = async (url) => {
            showToast("AI æ­£åœ¨è¾¨è­˜ä¿å–®...", "info");
            try {
                const base64 = url.split(',')[1];
                const res = await callAI(`è«‹è¾¨è­˜é€™å¼µä¿å–®åœ–ç‰‡ã€‚å›å‚³ JSON æ ¼å¼: {"name": "ä¿å–®åç¨±", "amount": å¹´ç¹³ä¿è²»æ•¸å­—, "features": "ä¿å–®ç‰¹è‰²(å¦‚:å¯¦æ”¯å¯¦ä»˜, å£½éšª)"}ã€‚`, base64);
                
                if (res.name) {
                    insurancePolicies.push({ id: Date.now(), name: res.name, amount: res.amount || 0, date: currentDate, features: res.features || 'AI è¾¨è­˜' });
                    saveData();
                    showToast("ä¿å–®åŒ¯å…¥æˆåŠŸï¼", "success");
                } else {
                    throw new Error("ç„¡æ³•è¾¨è­˜");
                }
            } catch(e) {
                showToast("è¾¨è­˜å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥", "error");
                openInputModal('insurance_add');
            }
        };

        window.openCameraModal = (ctx='log') => {
            uploadContext = ctx;
            document.getElementById('camera-choice-modal').classList.remove('hidden');
        };
        window.triggerCamera = () => document.getElementById('input-camera').click();
        window.triggerGallery = () => document.getElementById('input-gallery').click();
        
        window.removeFixed = async (id) => { fixedExpenses = fixedExpenses.filter(f=>f.id!==id); saveData(); };
        
        window.switchTab = (t) => {
            document.querySelectorAll('.tab-view').forEach(e=>e.classList.add('hidden'));
            document.getElementById(`${t}-view`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('text-blue-600'));
            const btn = document.getElementById(`nav-${t}`);
            if(btn) btn.classList.add('text-blue-600');
            refreshUI();
        };

        // --- Render UI ---
        window.refreshUI = () => {
            const monthStart = currentDate.substring(0, 7);
            const monthLogs = dailyLogs.filter(l=>l.dateStr.startsWith(monthStart));
            
            // FIXED: CRITICAL! Define a subset of logs that EXCLUDES adjustments for ALL budget calculations
            const validMonthLogs = monthLogs.filter(l => !l.isAdjustment);

            // Dash Stats
            const todayLogs = dailyLogs.filter(l=>l.dateStr===currentDate && !l.isAdjustment);
            const kcalIn = todayLogs.reduce((a,b)=>a+(b.kcal||0),0);
            const burned = todayLogs.reduce((a,b)=>a+(b.burned||0),0);
            const spent = todayLogs.filter(l=>l.type.includes('finance')).reduce((a,b)=>a+(b.amount||0),0);
            
            setText('today-record-sum', `(ç¸½æ”¯å‡º: $${spent})`);
            setText('dash-food', `$${spent}`);
            setText('dash-in', kcalIn);
            setText('dash-burn', burned);
            setText('dash-remain', userProfile.targetKcal + burned - kcalIn);
            setText('current-date-display', currentDate);

            updateCategoryDropdown();

            // Log List
            setHTML('log-list', todayLogs.length ? todayLogs.map(l=>`
                <div class="flex justify-between p-3 border-b border-gray-100 text-sm">
                    <div class="flex items-center gap-2"><span class="text-lg">${categoryIcons[l.category]||'ğŸ“'}</span><div><div class="font-bold text-gray-700">${l.description}</div><div class="text-[10px] text-gray-400">${l.category} Â· ${l.card?`<span onclick="openInputModal('change_account','${l.id}')" class="text-blue-500 cursor-pointer underline decoration-dotted">${l.card}</span>`:'ç„¡'}</div></div></div>
                    <div class="text-right"><div><span class="font-bold">-$${l.amount}</span> <button onclick="deleteLog('${l.id}')" class="text-gray-300 hover:text-red-500 px-1">Ã—</button></div><div class="text-[10px] text-gray-400">${l.kcal?`ğŸ”¥${l.kcal} ` : ''}${l.protein?`ğŸ¥š${l.protein} ` : ''}${l.burned?`ğŸƒ${l.burned}` : ''}</div></div>
                </div>`).join('') : '<div class="text-center text-gray-400 py-4">æœ¬æ—¥ç„¡ç´€éŒ„</div>');

            // Fixed Expenses & Budgets
            let fixedRemTotal = 0;
            setHTML('dash-fixed-list', fixedExpenses.map(f => {
                // FIXED: Use validMonthLogs to ensure adjustments are ignored here too
                const used = validMonthLogs.filter(l => l.category === f.name || l.description.includes(f.name)).reduce((a,b) => a + (b.amount||0), 0);
                const rem = f.amount - used;
                fixedRemTotal += rem;
                return `<div class="flex justify-between p-2 text-sm border-b items-center"><div class="flex items-center gap-2">${used>0?'<span class="text-green-500 text-xs">ğŸŸ¢</span>':'<span class="text-gray-200 text-xs">âšª</span>'}<div><div class="font-medium">${f.name}</div><div class="text-xs text-gray-400">å‰©: $${rem} Â· ç¶å®š: ${f.note}</div></div></div><div class="flex items-center"><span class="font-bold px-1 rounded ${rem<0?'text-red-500':'text-gray-800'}" onclick="openInputModal('fixed_edit',${f.id})">$${f.amount}</span><button onclick="removeFixed(${f.id})" class="text-red-400 ml-2">Ã—</button></div></div>`;
            }).join(''));
            if(document.getElementById('fixed-total-remaining')) {
                const el = document.getElementById('fixed-total-remaining');
                el.textContent = `$${fixedRemTotal}`;
                el.className = `font-bold ${fixedRemTotal<0?'text-red-600':'text-green-600'}`;
            }

            // Financial Report
            const incomeTotal = Object.values(monthlyIncome).reduce((a,b)=>a+b,0);
            const fixedTotal = fixedExpenses.reduce((a,b)=>a+b.amount,0);
            const disposable = incomeTotal - fixedTotal;
            
            const entRatio = userProfile.entRatio || 20;
            const invRatio = 100 - entRatio;
            const entBudget = Math.round(disposable * (entRatio/100));
            const invBudget = disposable - entBudget;
            
            // FIXED: Use validMonthLogs here
            const entSpent = validMonthLogs.filter(l => l.category === 'å¨›æ¨‚').reduce((a,b) => a + (b.amount||0), 0);
            const invSpent = validMonthLogs.filter(l => l.category === 'æŠ•è³‡').reduce((a,b) => a + (b.amount||0), 0);
            
            const entRem = entBudget - entSpent;
            const invRem = invBudget - invSpent;
            const finalRem = fixedRemTotal + entRem + invRem;

            setText('dash-month-remain', `$${finalRem.toLocaleString()}`);
            setText('rep-total-inc', `$${incomeTotal.toLocaleString()}`);
            setText('rep-disposable', `$${disposable.toLocaleString()}`);
            setText('rep-final', `$${finalRem.toLocaleString()}`);
            setText('rep-ent-val', `$${entRem.toLocaleString()}`);
            setText('rep-inv-val', `$${invRem.toLocaleString()}`);
            setText('rep-total-fix', `-$${fixedTotal.toLocaleString()}`);
            
            ['salary','bonus','overtime','oncall'].forEach(k => { const el=document.getElementById(`inc-${k}`); if(el) el.value=monthlyIncome[k]; });
            setHTML('rep-acc-list', accounts.map((a,i)=>`<div class="flex justify-between p-2 text-sm border-b"><span>${a.name}</span><div><span class="font-bold ${a.balance<0?'text-red-500':'text-blue-600'}">$${a.balance}</span> <button onclick="openInputModal('balance',${i})" class="text-gray-400 ml-2">âœ</button></div></div>`).join(''));

            // Portfolio (Must Include Adjustments to be correct, so we use dailyLogs, NOT validMonthLogs)
            const portfolio = {};
            dailyLogs.filter(l => l.category === 'æŠ•è³‡').forEach(l => {
                const s = String(l.description).trim(); 
                if(s) portfolio[s] = (portfolio[s] || 0) + (l.amount || 0);
            });
            setHTML('portfolio-list', Object.keys(portfolio).length ? Object.entries(portfolio).map(([s,a]) => `
                <div class="flex justify-between items-center p-2 border-b border-gray-100 last:border-0">
                    <div class="font-medium text-gray-700">${s}</div>
                    <div class="flex items-center gap-2"><div class="font-bold text-gray-900">$${a.toLocaleString()}</div><button onclick="openPortfolioModal('${s.replace(/'/g, "\\'")}', ${a})" class="text-gray-400 hover:text-blue-600 p-1">âš™ï¸</button></div>
                </div>`).join('') : '<div class="text-center text-gray-400 text-xs py-2">å°šç„¡æŒå€‰ç´€éŒ„</div>');

            setHTML('inv-list', investments.map(i=>`<div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-100"><div class="flex justify-between items-start mb-2"><div><span class="bg-blue-100 text-blue-700 font-bold px-2 py-1 rounded text-xs">${i.symbol}</span><span class="text-xs text-gray-400 ml-2">${i.date}</span></div><button onclick="removeInvestment('${i.id}')" class="text-gray-400 hover:text-red-600 p-1">ğŸ—‘ï¸</button></div><div class="text-sm font-medium text-gray-800 mb-2">"${i.note}"</div><div class="text-xs bg-white p-2 rounded border border-indigo-100 text-gray-600 leading-relaxed">${parseMarkdown(i.feedback)}</div></div>`).join(''));

            // NEW: Insurance List with Cards and Shield
            const totalInsPremium = insurancePolicies.reduce((a,b)=>a+(b.amount||0),0);
            const totalIncome = Object.values(monthlyIncome).reduce((a,b)=>a+b,0) * 12;
            const shieldStatus = totalInsPremium === 0 ? 'shield-red' : (totalInsPremium > (totalIncome * 0.15) ? 'shield-yellow' : 'shield-green');
            
            setText('ins-total-premium', `$${totalInsPremium.toLocaleString()}`);
            document.getElementById('ins-shield-icon').className = `text-4xl mb-1 ${shieldStatus}`;
            
            setHTML('policy-list', insurancePolicies.length ? insurancePolicies.map(p=>`
                <div class="bg-gradient-to-br from-teal-50 to-white p-3 rounded-xl border border-teal-100 shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs text-teal-600 font-bold mb-1">ğŸ›¡ï¸ ä¿å–®</div>
                            <div class="font-bold text-gray-800 text-lg">${p.name}</div>
                            <div class="text-xs text-gray-500 mt-1">${p.features || 'ä¸€èˆ¬ä¿éšª'}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black text-teal-700 text-xl">$${p.amount.toLocaleString()}</div>
                            <div class="text-[10px] text-gray-400">/å¹´</div>
                        </div>
                    </div>
                    <button onclick="removePolicy('${p.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">Ã—</button>
                </div>
            `).join('') : '<div class="text-center text-gray-400 text-xs py-4">å°šæœªæ–°å¢ä¿å–®</div>');

            setHTML('insurance-note-list', insuranceNotes.map(i=>`<div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-100"><div class="flex justify-between items-start mb-2"><div><span class="text-xs text-gray-400">${i.date}</span></div><button onclick="removeInsuranceNote('${i.id}')" class="text-gray-400 hover:text-red-600 p-1">ğŸ—‘ï¸</button></div><div class="text-sm font-medium text-gray-800 mb-2">"${i.note}"</div><div class="text-xs bg-white p-2 rounded border border-cyan-100 text-gray-600 leading-relaxed">${parseMarkdown(i.feedback)}</div></div>`).join(''));

            setValue('prof-height', userProfile.height);
            setValue('prof-weight', userProfile.weight);
            setValue('prof-age', userProfile.age);
            setValue('ratio-ent', userProfile.entRatio);
            setValue('ratio-inv', 100 - userProfile.entRatio);
            renderCalendar();
            
            const currCat = document.getElementById('log-category').value;
            changeLogCategory(currCat);
        };
    </script>
</head>
<body class="bg-gray-50 pb-20 select-none text-gray-800">
    <div id="toast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full text-white bg-black z-50"></div>

    <!-- Portfolio Manager Modal -->
    <div id="portfolio-action-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="closeModal('portfolio-action')">
        <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-xl" onclick="event.stopPropagation()">
            <h3 id="port-modal-title" class="font-bold mb-4 text-lg border-b pb-2">ç®¡ç†æŒå€‰</h3>
            
            <div class="mb-4">
                <label class="text-xs text-gray-500 block mb-1">ç›®å‰ç¸½æŠ•å…¥é‡‘é¡</label>
                <input id="port-current" type="number" class="w-full bg-gray-100 border p-2 rounded text-gray-500 font-bold mb-2" disabled>
                
                <label class="text-xs text-blue-600 block mb-1 font-bold">è‡ªè¡Œèª¿æ•´ç¸½æŠ•å…¥é‡‘é¡ (ç›®æ¨™å€¼)</label>
                <input id="port-target" type="number" class="w-full border-2 border-blue-100 p-2 rounded text-lg font-black text-blue-800 focus:outline-none focus:border-blue-500" placeholder="è¼¸å…¥ä¿®æ­£å¾Œçš„ç¸½é‡‘é¡">
            </div>

            <div class="mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                <div class="text-xs text-yellow-700 font-bold">âš ï¸ æ­¤èª¿æ•´åƒ…æ›´æ–°æŒå€‰ç´€éŒ„</div>
                <div class="text-[10px] text-yellow-600 mt-1">ä¸æœƒæ‰£é™¤æˆ–é€€å›ä»»ä½•éŠ€è¡Œå¸³æˆ¶é¤˜é¡ã€‚è‹¥éœ€è¨˜å¸³æ‰£æ¬¾ï¼Œè«‹ä½¿ç”¨ã€Œ+ è²·å…¥ã€åŠŸèƒ½ã€‚</div>
            </div>

            <div class="flex flex-col gap-2">
                <button onclick="submitPortfolioUpdate()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow hover:bg-blue-700">ç¢ºèªèª¿æ•´</button>
                <button onclick="deletePortfolioSymbol()" class="w-full bg-red-50 text-red-600 py-2 rounded-lg font-bold border border-red-100 hover:bg-red-100 text-sm">åˆªé™¤æ­¤æ¨™çš„ (å…¨æ•¸é€€æ¬¾)</button>
                <button onclick="closeModal('portfolio-action')" class="w-full text-gray-400 text-sm py-1">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-choice-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="closeModal('camera-choice')">
        <div class="bg-white w-full max-w-xs rounded-xl p-5 shadow-xl text-center" onclick="event.stopPropagation()">
            <h3 class="font-bold mb-4 text-lg">é¸æ“‡åœ–ç‰‡</h3>
            <div class="flex flex-col gap-3">
                <button onclick="triggerCamera()" class="bg-blue-50 text-blue-600 py-3 rounded-lg font-bold border border-blue-100">ğŸ“· æ‹ç…§</button>
                <button onclick="triggerGallery()" class="bg-gray-50 text-gray-600 py-3 rounded-lg font-bold border border-gray-200">ğŸ–¼ï¸ ç›¸ç°¿</button>
                <button onclick="closeModal('camera-choice')" class="mt-2 text-gray-400 text-sm">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="input-camera" accept="image/*" capture="environment" onchange="handleImageUpload(event)" class="hidden-input">
    <input type="file" id="input-gallery" accept="image/*" onchange="handleImageUpload(event)" class="hidden-input">

    <!-- Verify Modal -->
    <div id="verify-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-xl">
            <h3 id="verify-title" class="font-bold mb-4 text-lg">ç¢ºèª</h3>
            <div id="verify-inputs"></div>
            <div class="flex gap-2 mt-4"><button onclick="closeModal('verify')" class="flex-1 bg-gray-100 py-2 rounded font-bold text-gray-500">å–æ¶ˆ</button><button onclick="confirmVerifyLog()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold shadow-lg">ç¢ºèª</button></div>
        </div>
    </div>
    
    <!-- Input Modal -->
    <div id="input-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-xl">
            <h3 id="input-modal-title" class="font-bold mb-4 text-lg">è¼¸å…¥</h3>
            <div id="input-default-container" class="mb-3">
                <div id="input-note-container"><input id="input-note" type="text" class="w-full border p-2 rounded mb-2" placeholder="åç¨±"></div>
                <label id="input-label" class="text-xs text-gray-500">æ•¸å€¼</label>
                <input id="input-value" type="number" class="w-full border p-2 rounded font-bold text-lg">
            </div>
            <div id="input-account-container" class="mb-3 hidden">
                <label class="text-xs text-gray-500 block mb-2">é¸æ“‡å¸³æˆ¶</label>
                <select id="input-account-select" class="w-full border p-3 rounded font-bold bg-white"></select>
            </div>
            <div id="input-fixed-acc-container" class="mb-3 hidden">
                <label class="text-xs text-gray-500 block mb-2">ç¶å®šå¸³æˆ¶</label>
                <select id="input-fixed-acc-select" class="w-full border p-3 rounded font-bold bg-white"></select>
            </div>
            <div class="flex gap-2"><button onclick="closeModal('input')" class="flex-1 bg-gray-100 py-2 rounded">å–æ¶ˆ</button><button onclick="submitInputModal()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">ç¢ºå®š</button></div>
        </div>
    </div>

    <!-- Header -->
    <div class="bg-white p-3 shadow-sm sticky top-0 z-20">
        <div class="flex justify-between items-center">
            <div class="font-black text-lg">Pocket Coach <span class="text-xs bg-indigo-100 text-indigo-600 px-1 rounded">V18.19</span></div>
            <div class="flex items-center gap-2">
                <span id="current-date-display" class="font-bold text-lg text-gray-700"></span>
                <button onclick="toggleCalendar()" class="bg-gray-100 p-2 rounded-lg text-xs font-bold text-gray-600 flex items-center gap-1">ğŸ“…</button>
            </div>
        </div>
        <div id="calendar-wrapper" class="hidden mt-3 border-t pt-2">
            <div class="flex justify-between items-center mb-2 px-2">
                <button onclick="prevMonth()" class="text-gray-400 font-bold">â—€</button><span id="current-month-label" class="text-sm font-bold">...</span><button onclick="nextMonth()" class="text-gray-400 font-bold">â–¶</button>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
            <div class="text-center mt-2"><button onclick="jumpToToday()" class="text-xs text-blue-600 border px-2 py-1 rounded">Today</button></div>
        </div>
    </div>

    <main class="max-w-md mx-auto p-3">
        <!-- Dashboard -->
        <div id="dashboard-view" class="tab-view">
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="bg-white p-2 rounded-xl border border-blue-100 text-center shadow-sm">
                    <div class="text-[10px] text-gray-400">ä»Šæ—¥æ”¯å‡º</div><div id="dash-food" class="text-lg font-black text-blue-600">$0</div>
                </div>
                <div class="bg-white p-2 rounded-xl border border-yellow-100 text-center shadow-sm">
                    <div class="text-[10px] text-gray-400">æœ¬æœˆå‰©é¤˜é ç®—</div><div id="dash-month-remain" class="text-lg font-black text-yellow-600">$0</div>
                </div>
                <div class="bg-gray-800 p-2 rounded-xl text-center text-white shadow-sm">
                    <div class="text-[10px] opacity-70">å‰©é¤˜ç†±é‡</div><div id="dash-remain" class="text-lg font-black">1500</div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-md mb-4 border border-gray-200">
                <div class="flex gap-2 mb-2">
                    <select id="log-category" onchange="changeLogCategory(this.value)" class="bg-gray-50 border p-2 rounded text-sm w-1/3"></select>
                    <select id="log-card" onchange="if(this.value==='custom') document.getElementById('finance-card-custom').classList.remove('hidden'); else document.getElementById('finance-card-custom').classList.add('hidden')" class="bg-gray-50 border p-2 rounded text-sm w-2/3"></select>
                </div>
                <input id="finance-card-custom" type="text" placeholder="è¼¸å…¥å¸³æˆ¶åç¨±" class="w-full border p-2 rounded text-sm mb-2 hidden">
                <div class="flex items-center gap-2 mb-2">
                     <button onclick="openCameraModal('log')" class="bg-gray-50 border border-gray-200 rounded-lg p-2 w-12 hover:bg-gray-100 text-xl">ğŸ“·</button>
                    <input id="log-description" placeholder="æè¿°" class="flex-grow border border-gray-200 p-2 rounded text-sm h-10">
                    <input id="log-amount" type="number" placeholder="$" class="w-16 border border-gray-200 p-2 rounded text-center font-bold text-sm h-10">
                </div>
                <div id="manual-nutrition-block" class="bg-gray-50 p-2 rounded mb-2 border border-dashed border-gray-300 hidden">
                    <div id="manual-hint-text" class="text-[10px] text-gray-400 mb-1">âœï¸ æ‰‹å‹•è¼¸å…¥</div>
                    <div class="flex gap-2">
                        <div id="manual-kcal-container" class="flex-1 relative h-10"><input id="log-manual-kcal" type="number" class="w-full h-full border p-1 rounded text-sm text-center pl-4"><span id="manual-kcal-label" class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400">ğŸ”¥</span></div>
                        <div id="manual-protein-container" class="flex-1 relative h-10"><input id="log-manual-protein" type="number" class="w-full h-full border p-1 rounded text-sm text-center pl-4"><span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400">ğŸ¥š</span></div>
                    </div>
                </div>
                <div id="image-preview" class="mb-2 flex justify-start"></div>
                <button id="unified-log-btn" onclick="handleUnifiedLog()" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold shadow-lg">ğŸ’° è¨˜éŒ„</button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-green-200 p-4 mb-4">
                <h3 class="font-bold text-green-700 text-sm mb-3 flex items-center border-b border-green-100 pb-2"><span class="text-lg mr-2">ğŸ¥—</span> AI ç‡Ÿé¤Šæ•™ç·´</h3>
                <div id="health-chat-box" class="h-40 overflow-y-auto mb-3 text-sm space-y-2 pr-1"><div class="text-center text-gray-300 text-xs py-2">æœ‰ä»€éº¼é£²é£Ÿå•é¡Œæƒ³å•æˆ‘å—ï¼Ÿ</div></div>
                <div class="flex gap-2"><input id="health-chat-input" type="text" placeholder="å•æ•™ç·´..." class="flex-grow bg-gray-50 border rounded-lg px-3 py-2 text-sm"><button onclick="sendAIChat('health')" class="bg-green-600 text-white px-4 rounded-lg font-bold text-sm shadow-sm active:scale-95">ç™¼é€</button></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-3 mb-4">
                <div class="flex justify-between items-center mb-2"><h3 class="text-xs font-bold text-gray-400">ä»Šæ—¥ç´€éŒ„</h3><span id="today-record-sum" class="text-xs font-bold text-blue-600"></span></div>
                <div id="log-list"></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-4 border border-red-100">
                <div class="flex justify-between items-center mb-2 border-b pb-2">
                    <div><h3 class="font-bold text-red-800 text-sm">ğŸ”’ æ¯æœˆå›ºå®šæ”¯å‡º</h3><div class="text-[10px] text-gray-400 mt-1">ç¸½å‰©é¤˜: <span id="fixed-total-remaining" class="font-bold text-green-600">$0</span></div></div>
                    <button onclick="openInputModal('fixed_add')" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">ï¼‹ æ–°å¢</button>
                </div>
                <div id="dash-fixed-list"></div>
            </div>
        </div>

        <!-- Finance Report -->
        <div id="finance-view" class="tab-view hidden">
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 mb-4 text-center">
                <div class="text-sm text-gray-500">å¯æ”¯é…æ‰€å¾— (æ”¶å…¥-å›ºå®š)</div>
                <div id="rep-disposable" class="text-2xl font-black text-blue-600 mb-2">$0</div>
                <div class="flex gap-2 text-xs mb-3">
                    <div class="flex-1 bg-yellow-50 p-1 rounded text-yellow-700"><span id="rep-ent-label">å¨›æ¨‚å‰©é¤˜</span> <span id="rep-ent-val" class="font-bold block text-lg">$0</span></div>
                    <div class="flex-1 bg-green-50 p-1 rounded text-green-700"><span id="rep-inv-label">æŠ•è³‡å‰©é¤˜</span> <span id="rep-inv-val" class="font-bold block text-lg">$0</span></div>
                </div>
                <div class="bg-gray-900 text-white p-3 rounded-lg"><div class="text-xs opacity-70">æœ€çµ‚é¤˜é¡ (å¯æ”¯é… - è®Šå‹•æ”¯å‡º)</div><div class="text-lg font-bold"> <span id="rep-final" class="text-xl">$0</span></div></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-bold border-b pb-2 mb-2">æ”¶å…¥</h3>
                <div class="grid grid-cols-2 gap-4 text-sm mb-2">
                    <div><span class="text-xs text-gray-400">è–ªæ°´</span> <input id="inc-salary" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','salary')" readonly></div>
                    <div><span class="text-xs text-gray-400">çé‡‘</span> <input id="inc-bonus" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','bonus')" readonly></div>
                    <div><span class="text-xs text-gray-400">åŠ ç­</span> <input id="inc-overtime" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','overtime')" readonly></div>
                    <div><span class="text-xs text-gray-400">OnCall</span> <input id="inc-oncall" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','oncall')" readonly></div>
                </div>
                <div class="flex justify-between font-bold text-green-600 bg-green-50 p-2 rounded"><span>ç¸½è¨ˆ</span><span id="rep-total-inc">$0</span></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-blue-100">
                <div class="flex justify-between border-b pb-2 mb-2"><h3 class="font-bold text-blue-800 text-sm">ğŸ¦ è³‡ç”¢åº«å­˜</h3><button onclick="openInputModal('balance', -1)" class="text-xs text-blue-600">ï¼‹ å¸³æˆ¶</button></div>
                <div id="rep-acc-list"></div>
            </div>
        </div>

        <!-- Investment -->
        <div id="investment-view" class="tab-view hidden">
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-blue-200">
                <div class="flex justify-between items-center mb-3 border-b border-blue-100 pb-2">
                    <h3 class="font-bold text-blue-800 text-sm flex items-center gap-1">ğŸ’° æˆ‘çš„æŒå€‰ (ç´¯ç©æŠ•å…¥)</h3>
                    <button onclick="openInputModal('investment_add')" class="bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-lg shadow hover:bg-blue-700 active:scale-95">ï¼‹ è²·å…¥</button>
                </div>
                <div id="portfolio-list" class="space-y-1"></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-indigo-200 p-4 mb-4">
                <h3 class="font-bold text-indigo-700 text-sm mb-3 flex items-center border-b border-indigo-100 pb-2"><span class="text-lg mr-2">ğŸ“ˆ</span> æŠ•è³‡é¡§å• (å…¨çŸ¥æ¨¡å¼)</h3>
                <div id="finance-chat-box" class="h-64 overflow-y-auto mb-3 text-sm space-y-2 pr-1"><div class="text-center text-gray-300 text-xs py-2">æˆ‘å¯ä»¥åˆ†ææ‚¨çš„æŒè‚¡ç‹€æ³...</div></div>
                <div class="flex gap-2"><input id="finance-chat-input" type="text" placeholder="å•é¡§å•..." class="flex-grow bg-gray-50 border rounded-lg px-3 py-2 text-sm"><button onclick="sendAIChat('finance')" class="bg-indigo-600 text-white px-4 rounded-lg font-bold text-sm shadow-sm active:scale-95">ç™¼é€</button></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">æˆ‘çš„æŠ•è³‡ç­†è¨˜</h3>
                <div class="bg-gray-50 p-3 rounded-xl mb-3">
                    <div class="flex gap-2 mb-2"><input id="inv-symbol" type="text" placeholder="ä»£è™Ÿ" class="w-1/3 p-2 rounded border border-gray-200 text-sm"><input id="inv-note" type="text" placeholder="è§€é»" class="w-2/3 p-2 rounded border border-gray-200 text-sm"></div>
                    <button id="inv-add-btn" onclick="addInvestment()" class="w-full bg-gray-800 text-white py-2 rounded-lg text-sm font-bold shadow hover:bg-gray-700">ï¼‹ æ–°å¢ä¸¦ AI åˆ†æ</button>
                </div>
                <div id="inv-list"></div>
            </div>
        </div>

        <!-- Insurance -->
        <div id="insurance-view" class="tab-view hidden">
            <!-- Shield Dashboard -->
            <div class="bg-white rounded-xl shadow-md p-4 mb-4 text-center border border-gray-100">
                <div id="ins-shield-icon" class="text-4xl mb-1 shield-green">ğŸ›¡ï¸</div>
                <div class="text-sm font-bold text-gray-800">ä¿éšœé˜²è­·ç¶²</div>
                <div class="text-xs text-gray-400 mt-1">ç›®å‰å¹´ç¹³ç¸½ä¿è²»: <span id="ins-total-premium" class="font-bold text-teal-600">$0</span></div>
            </div>

            <!-- Scenario Analysis -->
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="runInsuranceScenario('ä½é™¢æ‰‹è¡“')" class="bg-red-50 p-3 rounded-xl text-center border border-red-100 active:scale-95 transition-transform">
                    <div class="text-xl mb-1">ğŸ¥</div>
                    <div class="text-xs font-bold text-red-700">ç”Ÿç—…ä½é™¢</div>
                </button>
                <button onclick="runInsuranceScenario('ç™Œç—‡æ²»ç™‚')" class="bg-orange-50 p-3 rounded-xl text-center border border-orange-100 active:scale-95 transition-transform">
                    <div class="text-xl mb-1">ğŸ¦€</div>
                    <div class="text-xs font-bold text-orange-700">ç½¹æ‚£ç™Œç—‡</div>
                </button>
                <button onclick="runInsuranceScenario('æ„å¤–è»Šç¦')" class="bg-blue-50 p-3 rounded-xl text-center border border-blue-100 active:scale-95 transition-transform">
                    <div class="text-xl mb-1">ğŸš—</div>
                    <div class="text-xs font-bold text-blue-700">ç™¼ç”Ÿæ„å¤–</div>
                </button>
            </div>

            <!-- Policy List -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-teal-200">
                <div class="flex justify-between items-center mb-3 border-b border-teal-100 pb-2">
                    <h3 class="font-bold text-teal-800 text-sm flex items-center gap-1">æˆ‘çš„ä¿éšªéŒ¢åŒ…</h3>
                    <div class="flex gap-2">
                        <button onclick="openCameraModal('policy')" class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded border hover:bg-gray-200">ğŸ“· æƒæ</button>
                        <button onclick="openInputModal('insurance_add')" class="bg-teal-600 text-white text-xs font-bold px-3 py-1 rounded-lg shadow hover:bg-teal-700 active:scale-95">ï¼‹ æ–°å¢</button>
                    </div>
                </div>
                <div id="policy-list" class="space-y-2"></div>
            </div>

            <!-- Advisor Section -->
            <div class="bg-white rounded-xl shadow-sm border border-cyan-200 p-4 mb-4">
                <h3 class="font-bold text-cyan-700 text-sm mb-3 flex items-center border-b border-cyan-100 pb-2"><span class="text-lg mr-2">ğŸ§</span> ä¿éšªé¡§å•</h3>
                <div id="insurance-chat-box" class="h-64 overflow-y-auto mb-3 text-sm space-y-2 pr-1"><div class="text-center text-gray-300 text-xs py-2">æˆ‘å¯ä»¥è©•ä¼°æ‚¨çš„é¢¨éšªç¼ºå£...</div></div>
                <div class="flex gap-2"><input id="insurance-chat-input" type="text" placeholder="å•é¡§å•..." class="flex-grow bg-gray-50 border rounded-lg px-3 py-2 text-sm"><button onclick="sendAIChat('insurance')" class="bg-cyan-600 text-white px-4 rounded-lg font-bold text-sm shadow-sm active:scale-95">ç™¼é€</button></div>
            </div>

            <!-- Notes Section -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">æˆ‘çš„ä¿éšªç­†è¨˜</h3>
                <div class="bg-gray-50 p-3 rounded-xl mb-3">
                    <div class="flex gap-2 mb-2"><input id="ins-note-input" type="text" placeholder="è¨˜éŒ„æƒ³æ³• (e.g. è€ƒæ…®å¢åŠ é†«ç™‚éšª)" class="w-full p-2 rounded border border-gray-200 text-sm"></div>
                    <button id="ins-add-btn" onclick="addInsuranceNote()" class="w-full bg-gray-800 text-white py-2 rounded-lg text-sm font-bold shadow hover:bg-gray-700">ï¼‹ æ–°å¢ä¸¦ AI åˆ†æ</button>
                </div>
                <div id="insurance-note-list"></div>
            </div>
        </div>

        <!-- Settings -->
        <div id="settings-view" class="tab-view hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">ğŸ‘¤ é«”æ…‹è¨­å®š</h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="text-xs text-gray-500">èº«é«˜</label><input id="prof-height" type="number" class="w-full border p-2 rounded"></div>
                    <div><label class="text-xs text-gray-500">é«”é‡</label><input id="prof-weight" type="number" class="w-full border p-2 rounded"></div>
                    <div><label class="text-xs text-gray-500">å¹´é½¡</label><input id="prof-age" type="number" class="w-full border p-2 rounded"></div>
                    <div><label class="text-xs text-gray-500">æ€§åˆ¥</label><select id="prof-gender" class="w-full border p-2 rounded bg-white"><option value="male">ç”·</option><option value="female">å¥³</option></select></div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">âš–ï¸ ç†è²¡åˆ†é…</h3>
                <div class="flex items-center gap-4 mb-3">
                    <div class="flex-1"><label class="text-xs text-yellow-600 block mb-1">å¨›æ¨‚ (%)</label><input id="ratio-ent" type="number" oninput="updateInvFromEnt(this.value)" class="w-full border p-2 rounded font-bold text-center text-yellow-700"></div>
                    <div class="flex-1"><label class="text-xs text-green-600 block mb-1">æŠ•è³‡ (%)</label><input id="ratio-inv" type="number" oninput="updateEntFromInv(this.value)" class="w-full border p-2 rounded font-bold text-center text-green-700"></div>
                </div>
                <button onclick="updateSettings()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold text-sm">å„²å­˜è¨­å®š</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">ğŸ¤– AI è¨­å®š</h3>
                <div class="mb-3">
                    <label class="text-xs text-gray-500">Model</label>
                    <div class="flex gap-2 mb-2">
                        <select id="setting-model" onchange="handleModelChange(this.value)" class="flex-grow border p-2 rounded bg-white text-sm"><option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option><option value="gemini-1.5-flash">Gemini 1.5 Flash</option><option value="custom">è‡ªè¨‚...</option></select>
                        <button onclick="fetchGoogleModels()" class="bg-gray-100 px-3 rounded border">ğŸ”„</button>
                    </div>
                    <input id="setting-model-custom" type="text" placeholder="Model ID" class="w-full border p-2 rounded bg-gray-50 text-sm mb-2 hidden">
                    <label class="text-xs text-gray-500">API Key</label>
                    <input id="setting-api-key" type="password" class="w-full border p-2 rounded bg-gray-50 text-sm">
                </div>
                <button onclick="saveSystemConfig()" class="w-full bg-gray-800 text-white py-2 rounded-lg font-bold text-sm">å„²å­˜ Key</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">ğŸ“¦ è³‡æ–™å‚™ä»½</h3>
                <button onclick="exportData()" class="w-full bg-gray-100 text-gray-600 py-2 rounded-lg font-bold text-sm hover:bg-gray-200">åŒ¯å‡º JSON</button>
                <div class="mt-4 border-t pt-4">
                    <label class="text-xs text-gray-500 block mb-2">ğŸ“¥ åŒ¯å…¥</label>
                    <textarea id="import-json" class="w-full border p-2 rounded text-xs h-32 mb-2"></textarea>
                    <button onclick="importData()" class="w-full bg-red-50 text-red-600 border border-red-200 py-2 rounded-lg font-bold text-sm hover:bg-red-100">åŒ¯å…¥</button>
                </div>
            </div>
            <div class="text-center mt-8 text-xs text-gray-300">Pocket Coach v18.19</div>
        </div>
    </main>

    <div class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 z-30 pb-6 safe-area-pb">
        <button onclick="switchTab('dashboard')" class="nav-btn text-blue-600 font-bold text-xs flex flex-col items-center w-1/5" id="nav-dashboard"><span class="text-xl">ğŸ </span>é§•é§›è‰™</button>
        <button onclick="switchTab('finance')" class="nav-btn text-gray-400 font-bold text-xs flex flex-col items-center w-1/5" id="nav-finance"><span class="text-xl">ğŸ“Š</span>å ±è¡¨</button>
        <button onclick="switchTab('investment')" class="nav-btn text-gray-400 font-bold text-xs flex flex-col items-center w-1/5" id="nav-investment"><span class="text-xl">ğŸ“ˆ</span>æŠ•è³‡</button>
        <button onclick="switchTab('insurance')" class="nav-btn text-gray-400 font-bold text-xs flex flex-col items-center w-1/5" id="nav-insurance"><span class="text-xl">ğŸ›¡ï¸</span>ä¿éšª</button>
        <button onclick="switchTab('settings')" class="nav-btn text-gray-400 font-bold text-xs flex flex-col items-center w-1/5" id="nav-settings"><span class="text-xl">âš™ï¸</span>è¨­å®š</button>
    </div>
</body>
</html>
