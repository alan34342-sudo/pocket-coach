<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pocket Coach</title>
    
    <!-- PWA & Mobile Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pocket Coach">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#ffffff">

    <!-- App Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%232563EB'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='300' fill='white'%3EğŸ¤–%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%232563EB'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='300' fill='white'%3EğŸ¤–%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // --- UI Helpers (Fixed: Added missing functions) ---
        const setText = (id, text) => { const el = document.getElementById(id); if(el) el.textContent = text; };
        const setHTML = (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; };
        const setValue = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };

        // --- æœ¬åœ°è³‡æ–™åº«æ¨¡æ“¬ (Local Storage Wrapper) ---
        const DB = {
            get: (key, defaultVal) => {
                const data = localStorage.getItem(`pocket_coach_${key}`);
                return data ? JSON.parse(data) : defaultVal;
            },
            set: (key, val) => {
                localStorage.setItem(`pocket_coach_${key}`, JSON.stringify(val));
            }
        };

        // --- å…¨åŸŸè®Šæ•¸ ---
        let USER_API_KEY = ""; 
        let ACTIVE_MODEL = "gemini-1.5-flash";
        
        // ä¿®æ­£æ™‚å€
        const getLocalDate = () => {
            const d = new Date();
            return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        };

        let currentDate = getLocalDate();
        let currentViewMonth = new Date(); 
        let selectedImageBase64 = null; 

        // Data Models (å¾ LocalStorage è¼‰å…¥)
        let accounts = [];
        let monthlyIncome = { salary: 0, bonus: 0, overtime: 0, oncall: 0 };
        let fixedExpenses = [];
        let investments = []; 
        let dailyLogs = [];
        let userProfile = { height: 172, weight: 69, tdee: 2000, targetKcal: 1600, entRatio: 20 };

        // Defaults
        const defaultAccountsList = ['åœ‹æ³°', 'éƒµå±€', 'BANK', 'åˆåº«', 'ç‰å±±', 'è¯é‚¦'];
        const defaultFixedList = [
            {name: 'é¤è²»', note: 'æœˆé ç®—', amount: 0, id: 1},
            {name: 'ç”Ÿæ´»ç”¨å“', note: 'åˆåº«', amount: 0, id: 2},
            {name: 'é›»è©±è²»', note: 'åˆåº«', amount: 0, id: 3},
            {name: 'å£½éšª', note: 'éƒµå±€', amount: 0, id: 4},
            {name: 'ç­†é›»', note: 'è¯é‚¦', amount: 0, id: 5},
            {name: 'ä¿éšª', note: 'åœ‹æ³°', amount: 0, id: 6},
            {name: 'æ©Ÿè»Š', note: 'åˆåº«', amount: 0, id: 7},
            {name: 'é›»è²»', note: 'bank', amount: 0, id: 8}
        ];

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            switchTab('dashboard');
        });

        const loadData = () => {
            // Load Settings
            USER_API_KEY = localStorage.getItem('gemini_api_key') || "";
            ACTIVE_MODEL = localStorage.getItem('gemini_model') || "gemini-1.5-flash";
            
            // Load Data
            userProfile = DB.get('profile', userProfile);
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè¼‰å…¥é è¨­å€¼
            const savedAcc = DB.get('accounts', null);
            accounts = savedAcc ? savedAcc : defaultAccountsList.map(name => ({name, balance: 0}));
            
            monthlyIncome = DB.get('income', monthlyIncome);
            
            const savedFix = DB.get('fixed', null);
            fixedExpenses = savedFix ? savedFix : defaultFixedList;
            
            investments = DB.get('investments', []);
            dailyLogs = DB.get('logs', []);

            // UI Init
            const apiKeyInput = document.getElementById('setting-api-key');
            if (apiKeyInput) apiKeyInput.value = USER_API_KEY;
            
            const modelSelect = document.getElementById('setting-model');
            if (modelSelect) {
                if (['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-2.0-flash', 'gemini-2.5-flash-preview-09-2025'].includes(ACTIVE_MODEL)) {
                    modelSelect.value = ACTIVE_MODEL;
                } else {
                    modelSelect.value = 'custom';
                    document.getElementById('setting-model-custom').classList.remove('hidden');
                    document.getElementById('setting-model-custom').value = ACTIVE_MODEL;
                }
            }
            
            refreshUI();
        };

        const saveData = () => {
            DB.set('accounts', accounts);
            DB.set('income', monthlyIncome);
            DB.set('fixed', fixedExpenses);
            DB.set('profile', userProfile);
            DB.set('investments', investments);
            DB.set('logs', dailyLogs);
            refreshUI();
        };

        // --- æ ¸å¿ƒè¨ˆç®—èˆ‡é‚è¼¯ ---
        const calculateTDEE = (w, h) => {
            const bmr = (10 * w) + (6.25 * h) - (5 * 30) + 5;
            const tdee = Math.round(bmr * 1.375);
            return { tdee, target: tdee - 400 };
        };

        // Settings
        window.updateSettings = () => {
            const h = parseInt(document.getElementById('prof-height').value)||172;
            const w = parseInt(document.getElementById('prof-weight').value)||69;
            const entR = parseInt(document.getElementById('ratio-ent').value)||20;
            const res = calculateTDEE(w, h);
            userProfile = { ...userProfile, height: h, weight: w, tdee: res.tdee, targetKcal: res.target, entRatio: entR };
            saveData();
            showToast('è¨­å®šå·²æ›´æ–°', 'success');
        };

        window.saveSystemConfig = () => {
            const key = document.getElementById('setting-api-key').value.trim();
            const modelSelect = document.getElementById('setting-model');
            const customInput = document.getElementById('setting-model-custom');
            let model = modelSelect.value;
            if (model === 'custom') model = customInput.value.trim();

            USER_API_KEY = key;
            ACTIVE_MODEL = model;
            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('gemini_model', model);
            
            showToast('è¨­å®šå·²å„²å­˜', 'success');
        };

        window.handleModelChange = (val) => {
            const customInput = document.getElementById('setting-model-custom');
            if(val === 'custom') customInput.classList.remove('hidden');
            else customInput.classList.add('hidden');
        };

        window.exportData = () => {
            const data = { accounts, monthlyIncome, fixedExpenses, investments, dailyLogs, userProfile };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pocket_coach_backup_${currentDate}.json`;
            a.click();
        };
        
        window.fetchGoogleModels = async () => {
            const apiKey = document.getElementById('setting-api-key').value.trim() || USER_API_KEY;
            if (!apiKey) return showToast("è«‹å…ˆè¼¸å…¥ API Key", "error");
            
            const btn = document.querySelector('button[onclick="fetchGoogleModels()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³'; btn.disabled = true;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (!response.ok) throw new Error("æŠ“å–å¤±æ•—");
                const data = await response.json();
                const chatModels = (data.models || [])
                    .filter(m => m.supportedGenerationMethods.includes("generateContent") && m.name.includes("gemini"))
                    .map(m => m.name.replace('models/', ''))
                    .sort((a, b) => b.localeCompare(a));

                const select = document.getElementById('setting-model');
                select.innerHTML = '';
                chatModels.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m; opt.textContent = m; select.appendChild(opt);
                });
                const customOpt = document.createElement('option');
                customOpt.value = 'custom'; customOpt.textContent = 'âœï¸ æ‰‹å‹•è¼¸å…¥...';
                select.appendChild(customOpt);
                
                showToast(`å·²æ›´æ–° ${chatModels.length} å€‹æ¨¡å‹`, "success");
            } catch (e) { showToast(`æ›´æ–°å¤±æ•—: ${e.message}`, "error"); } 
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        };

        // --- AI Logic ---
        const parseMarkdown = (text) => text ? text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>').replace(/- (.*?)(<br>|$)/g, 'â€¢ $1<br>') : '';
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const callAI = async (prompt, imgBase64 = null) => {
            if(!USER_API_KEY) return { error: "è«‹å…ˆåœ¨ [è¨­å®š] è¼¸å…¥ API Key" };
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${ACTIVE_MODEL}:generateContent?key=${USER_API_KEY}`;
            const parts = [{text: prompt}];
            if (imgBase64) parts.push({ inlineData: { mimeType: "image/jpeg", data: imgBase64 } });
            const payload = {contents:[{parts: parts}]};

            let retries = 0;
            const maxRetries = 3;
            let delay = 1000;

            while (retries < maxRetries) {
                try {
                    const r = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    if (r.status === 429 || r.status === 503) { await wait(delay); retries++; delay *= 2; continue; }
                    
                    // Fallback logic
                    if (r.status === 404 && ACTIVE_MODEL !== "gemini-1.5-flash") {
                        ACTIVE_MODEL = "gemini-1.5-flash"; // Auto fallback
                        return callAI(prompt, imgBase64); // Retry
                    }

                    if (!r.ok) {
                         const errBody = await r.json().catch(()=>({}));
                         throw new Error(`API Error (${r.status}): ${errBody.error?.message || r.statusText}`);
                    }
                    const json = await r.json();
                    const txt = json.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!txt) throw new Error("Empty Response");
                    if (prompt.includes('JSON')) {
                        const jsonMatch = txt.match(/\{[\s\S]*\}/);
                        return jsonMatch ? JSON.parse(jsonMatch[0]) : {kcal:0, protein:0, burned:0};
                    }
                    return txt;
                } catch (e) {
                     if (e.message && e.message.includes && e.message.includes('429')) { await wait(delay); retries++; delay *= 2; continue; }
                     const isJson = prompt.includes('JSON');
                     if(isJson) return { error: e.message };
                     return `[ç³»çµ±éŒ¯èª¤] ${e.message}`; 
                }
            }
            return prompt.includes('JSON') ? { error: "è«‹æ±‚éé »" } : "ç³»çµ±å¿™ç¢Œä¸­";
        };

        // --- Log & Action ---
        window.handleUnifiedLog = async () => {
            const description = document.getElementById('log-description').value;
            const amount = parseInt(document.getElementById('log-amount').value)||0;
            const category = document.getElementById('log-category').value;
            let card = document.getElementById('log-card').value;
            
            if(card==='custom') {
                card = document.getElementById('finance-card-custom').value;
                if(!accounts.find(a=>a.name===card)) { accounts.push({name:card, balance:0}); saveData(); }
            }

            if(!description) return showToast('è«‹è¼¸å…¥æè¿°', 'error');
            
            const btn = document.getElementById('unified-log-btn');
            btn.disabled = true; btn.textContent = 'AI é‹ç®—ä¸­...';

            try {
                if(category === 'é¤è²»') {
                    const res = await callAI(`åˆ†æé£Ÿç‰©ç‡Ÿé¤Š:${description}ã€‚è«‹åªå›å‚³JSONæ ¼å¼: {"kcal": æ•¸å­—, "protein": æ•¸å­—}ã€‚`, selectedImageBase64);
                    if(res.error) throw new Error(res.error);
                    window.pendingLog = { description, amount, category, card, type: 'finance_health' };
                    setupVerifyModal('food', res);
                } 
                else if (category === 'é‹å‹•') {
                    const res = await callAI(`åˆ†æé‹å‹•æ¶ˆè€—:${description}ã€‚ä½¿ç”¨è€…${userProfile.weight}å…¬æ–¤ã€‚è«‹åªå›å‚³JSONæ ¼å¼: {"burned": æ•¸å­—}ã€‚`);
                    if(res.error) throw new Error(res.error);
                    window.pendingLog = { description, amount: 0, category, card: '', type: 'exercise' };
                    setupVerifyModal('exercise', res);
                } 
                else {
                    commitLog({ description, amount, category, card, type: 'finance' });
                    showToast('è¨˜å¸³æˆåŠŸ', 'success');
                    resetLogForm();
                }
            } catch(e) { 
                showToast(`AI éŒ¯èª¤: ${e.message||'æœªçŸ¥'}`, 'error');
                if(category === 'é¤è²»') { window.pendingLog = { description, amount, category, card, type: 'finance_health' }; setupVerifyModal('food', {kcal:0, protein:0}); }
                else if(category === 'é‹å‹•') { window.pendingLog = { description, amount: 0, category, card: '', type: 'exercise' }; setupVerifyModal('exercise', {burned:0}); }
            } 
            finally { btn.disabled=false; btn.textContent = category==='é‹å‹•' ? 'ğŸ”¥ è¨˜éŒ„' : 'ğŸ’° è¨˜éŒ„'; }
        };

        const setupVerifyModal = (mode, data) => {
            const modalTitle = document.getElementById('verify-title');
            const container = document.getElementById('verify-inputs');
            
            if (mode === 'food') {
                modalTitle.textContent = 'ç¢ºèªç‡Ÿé¤Šæ”å–';
                container.innerHTML = `
                    <div class="flex gap-2 mb-2">
                        <div class="flex-1"><label class="text-xs text-red-500 font-bold">ç†±é‡ (Kcal)</label><input id="verify-kcal" type="number" value="${data.kcal||0}" class="w-full border-2 border-red-100 p-2 rounded text-xl font-black text-center text-red-600"></div>
                        <div class="flex-1"><label class="text-xs text-green-500 font-bold">è›‹ç™½è³ª (g)</label><input id="verify-protein" type="number" value="${data.protein||0}" class="w-full border-2 border-green-100 p-2 rounded text-xl font-black text-center text-green-600"></div>
                    </div>`;
            } else {
                modalTitle.textContent = 'ç¢ºèªé‹å‹•æ¶ˆè€—';
                container.innerHTML = `<div class="mb-2"><label class="text-xs text-orange-500 font-bold">æ¶ˆè€—ç†±é‡ (Kcal)</label><input id="verify-burned" type="number" value="${data.burned||0}" class="w-full border-2 border-orange-100 p-2 rounded text-xl font-black text-center text-orange-600"></div>`;
            }
            document.getElementById('verify-modal').classList.remove('hidden');
        };

        window.confirmVerifyLog = () => {
            const mode = window.pendingLog.type;
            let extraData = {};
            if (mode === 'finance_health') {
                extraData.kcal = parseInt(document.getElementById('verify-kcal').value) || 0;
                extraData.protein = parseInt(document.getElementById('verify-protein').value) || 0;
            } else if (mode === 'exercise') {
                extraData.burned = parseInt(document.getElementById('verify-burned').value) || 0;
            }
            commitLog({ ...window.pendingLog, ...extraData });
            closeModal('verify');
            showToast('ç´€éŒ„å®Œæˆ', 'success');
            resetLogForm();
        };

        const commitLog = (d) => {
            const logData = { 
                id: Date.now().toString(),
                timestamp: new Date().toISOString(), 
                dateStr: currentDate, 
                description: d.description, amount: d.amount, category: d.category, card: d.card, type: d.type,
                kcal: d.kcal || 0, protein: d.protein || 0, burned: d.burned || 0
            };
            dailyLogs.unshift(logData); // Add to local array

            if(d.amount > 0 && d.card) {
                const idx = accounts.findIndex(a=>a.name===d.card);
                if(idx!==-1) accounts[idx].balance -= d.amount;
            }
            saveData();
        };

        const resetLogForm = () => {
            document.getElementById('log-description').value = '';
            document.getElementById('log-amount').value = '';
            setHTML('image-preview', '');
            selectedImageBase64 = null;
        };

        window.handleImageUpload = (e) => {
            const f = e.target.files[0];
            if(f) { const r = new FileReader(); r.onload=(ev)=>{ selectedImageBase64=ev.target.result.split(',')[1]; document.getElementById('image-preview').innerHTML=`<img src="${ev.target.result}" class="h-16 rounded object-cover shadow-sm">`; }; r.readAsDataURL(f); }
        };

        window.sendAIChat = async (contextType) => {
            if(!USER_API_KEY) return showToast("è«‹å…ˆè‡³è¨­å®šé é¢è¼¸å…¥ API Key", "error");
            const inputId = `${contextType}-chat-input`; const containerId = `${contextType}-chat-box`;
            const input = document.getElementById(inputId); const msg = input.value.trim(); if(!msg) return;
            const chatBox = document.getElementById(containerId);
            chatBox.innerHTML += `<div class="flex justify-end mb-2"><div class="bg-blue-600 text-white py-2 px-3 rounded-2xl rounded-tr-none text-sm max-w-[80%]">${msg}</div></div>`;
            input.value = ''; chatBox.scrollTop = chatBox.scrollHeight;
            const loadingId = Date.now();
            chatBox.innerHTML += `<div id="${loadingId}" class="flex justify-start mb-2"><div class="bg-white border border-gray-200 text-gray-500 py-2 px-3 rounded-2xl rounded-tl-none text-xs">AI æ€è€ƒä¸­...</div></div>`;

            // Smart History Context
            const monthStart = currentDate.substring(0, 7);
            const todayLogs = dailyLogs.filter(l=>l.dateStr===currentDate);
            
            let context = "";
            if(contextType === 'health') {
                const d = new Date(); d.setDate(d.getDate() - 7);
                const weekStr = d.toISOString().split('T')[0];
                const healthHistory = dailyLogs.filter(l => l.kcal > 0 && l.dateStr >= weekStr).map(l => `${l.dateStr}: ${l.description} (${l.kcal}kcal)`).join("\n");
                const kcalIn = todayLogs.reduce((a,b)=>a+(b.kcal||0),0);
                const burned = todayLogs.reduce((a,b)=>a+(b.burned||0),0);
                context = `è§’è‰²:ç‡Ÿé¤Šæ•™ç·´ã€‚æ•¸æ“š: ${userProfile.height}cm/${userProfile.weight}kg, ç›®æ¨™${userProfile.targetKcal}kcalã€‚ä»Šæ—¥:æ”${kcalIn}, è€—${burned}ã€‚æ­·å²:${healthHistory}ã€‚å›ç­”ç”¨æˆ¶ã€‚`;
            } else if (contextType === 'finance') {
                const inc = Object.values(monthlyIncome).reduce((a,b)=>a+b,0);
                const fix = fixedExpenses.reduce((a,b)=>a+b.amount,0);
                const disp = inc - fix;
                const entB = Math.floor(disp * (userProfile.entRatio/100));
                const invB = Math.floor(disp * ((100-userProfile.entRatio)/100));
                
                const monthLogs = dailyLogs.filter(l=>l.dateStr.startsWith(monthStart));
                const entSpent = monthLogs.filter(l => l.category === 'å¨›æ¨‚').reduce((a,b) => a + (b.amount||0), 0);
                const invSpent = monthLogs.filter(l => l.category === 'æŠ•è³‡').reduce((a,b) => a + (b.amount||0), 0);
                const asset = accounts.reduce((a,b)=>a+b.balance,0);
                const inv = investments.map(i => `${i.symbol}: ${i.note}`).join(", ");
                const history = monthLogs.map(l => `${l.dateStr}: ${l.description} $${l.amount}`).join("\n");
                
                context = `è§’è‰²:ç†è²¡é¡§å•ã€‚æœˆæ•¸æ“š:å…¥$${inc}, å›ºæ”¯$${fix}, å¯ç”¨$${disp}ã€‚é ç®—:æ¨‚${entB}(å‰©${entB-entS}), æŠ•${invB}(å‰©${invB-invS})ã€‚è³‡ç”¢$${asset}, æŠ•è³‡:[${inv}]ã€‚æµæ°´å¸³:${history}ã€‚å›ç­”ç”¨æˆ¶ã€‚`;
            }

            try {
                const res = await callAI(context + " ç”¨æˆ¶å•:" + msg);
                document.getElementById(loadingId).remove();
                const displayNum = typeof res === 'object' ? "AI æ ¼å¼éŒ¯èª¤" : res;
                chatBox.innerHTML += `<div class="flex justify-start mb-4"><div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-2 text-lg flex-shrink-0">ğŸ¤–</div><div class="bg-white text-gray-800 py-3 px-4 rounded-2xl rounded-tl-none text-sm shadow-sm border border-gray-100 max-w-[85%] leading-relaxed">${parseMarkdown(displayNum)}</div></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch(e) { document.getElementById(loadingId).remove(); }
        };

        window.addInvestment = async () => {
            const symbol = document.getElementById('inv-symbol').value;
            const note = document.getElementById('inv-note').value;
            if(!symbol || !note) return showToast('è«‹è¼¸å…¥å…§å®¹', 'error');
            const btn = document.getElementById('inv-add-btn'); btn.textContent = 'AI åˆ†æä¸­...'; btn.disabled = true;
            try {
                const prompt = `åˆ†ææŠ•è³‡: ${symbol}ã€‚è§€é»: "${note}"ã€‚é¢¨éšªè©•ä¼°ã€‚`;
                const aiFeedback = await callAI(prompt); 
                const feedbackText = typeof aiFeedback === 'object' ? `éŒ¯èª¤: ${aiFeedback.error}` : aiFeedback;
                investments.push({ id: Date.now().toString(), symbol, note, feedback: feedbackText, date: new Date().toLocaleDateString() }); 
                saveData();
                document.getElementById('inv-symbol').value = ''; document.getElementById('inv-note').value = '';
                showToast('ç­†è¨˜å·²æ–°å¢', 'success');
            } catch(e) {
                investments.push({ id: Date.now().toString(), symbol, note, feedback: "API Key éŒ¯èª¤", date: new Date().toLocaleDateString() });
                saveData();
            } finally { btn.textContent = 'ï¼‹ æ–°å¢ä¸¦ AI åˆ†æ'; btn.disabled = false; }
        };

        window.removeInvestment = (idStr) => {
            if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
            investments = investments.filter(i => String(i.id) !== String(idStr));
            saveData();
        };

        // --- DOM Helpers ---
        window.openInputModal = (type, id=null) => {
            window.inputType = type; window.inputId = id;
            setValue('input-value', ''); setValue('input-note', '');
            document.getElementById('input-modal').classList.remove('hidden');
            const title = document.getElementById('input-modal-title');
            const noteContainer = document.getElementById('input-note-container');
            const note = document.getElementById('input-note');

            if(type === 'income') { title.textContent = 'ä¿®æ”¹æ”¶å…¥'; setValue('input-value', monthlyIncome[id]); noteContainer.classList.add('hidden'); } 
            else if(type === 'fixed_add') { title.textContent = 'æ–°å¢å›ºå®šæ”¯å‡º'; noteContainer.classList.remove('hidden'); note.placeholder = 'åç¨±'; } 
            else if (type === 'fixed_edit') { title.textContent = 'ä¿®æ”¹å›ºå®šæ”¯å‡º'; setValue('input-value', fixedExpenses.find(f=>f.id===id).amount); noteContainer.classList.add('hidden'); } 
            else if(type === 'balance') { title.textContent = 'è³‡ç”¢æ ¡æ­£'; if(id===-1) { noteContainer.classList.remove('hidden'); note.placeholder = 'å¸³æˆ¶åç¨±'; } else { setValue('input-value', accounts[id].balance); noteContainer.classList.add('hidden'); } }
        };

        window.submitInputModal = () => {
            const v = parseInt(document.getElementById('input-value').value)||0;
            const n = document.getElementById('input-note').value;
            if(window.inputType === 'income') { monthlyIncome[window.inputId] = v; }
            if(window.inputType === 'fixed_add') { if(!n) return; fixedExpenses.push({id:Date.now(), name:n, amount:v, note:'é ç®—'}); }
            if(window.inputType === 'fixed_edit') { const idx = fixedExpenses.findIndex(f=>f.id===window.inputId); if(idx!==-1) fixedExpenses[idx].amount = v; }
            if(window.inputType === 'balance') { if(window.inputId === -1) { if(!n) return; accounts.push({name:n, balance:v}); } else { accounts[window.inputId].balance = v; } }
            saveData();
            closeModal('input');
        };

        window.openModal = (id) => document.getElementById(`${id}-modal`).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(`${id}-modal`).classList.add('hidden');

        // --- Calendar ---
        window.toggleCalendar = () => {
            const cal = document.getElementById('calendar-wrapper');
            if(cal.classList.contains('hidden')) { cal.classList.remove('hidden'); renderCalendar(); }
            else cal.classList.add('hidden');
        };

        const renderCalendar = () => {
            const calContainer = document.getElementById('calendar-grid');
            if(!calContainer) return;
            const monthLabel = document.getElementById('current-month-label');
            const y = currentViewMonth.getFullYear();
            const m = currentViewMonth.getMonth();
            monthLabel.textContent = `${y}å¹´ ${m+1}æœˆ`;

            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            
            let html = '';
            for(let i=0; i<firstDay; i++) html += `<div></div>`;
            
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasLog = dailyLogs.some(l => l.dateStr === dateStr);
                const isSelected = dateStr === currentDate;
                html += `<div onclick="selectDate('${dateStr}')" class="h-8 flex flex-col items-center justify-center rounded-full cursor-pointer relative ${isSelected ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}"><span class="text-xs font-bold">${d}</span>${hasLog ? `<span class="w-1 h-1 rounded-full ${isSelected ? 'bg-white' : 'bg-green-500'} absolute bottom-1"></span>` : ''}</div>`;
            }
            calContainer.innerHTML = html;
        };

        window.prevMonth = () => { currentViewMonth.setMonth(currentViewMonth.getMonth()-1); renderCalendar(); };
        window.nextMonth = () => { currentViewMonth.setMonth(currentViewMonth.getMonth()+1); renderCalendar(); };
        window.selectDate = (d) => { currentDate = d; refreshUI(); window.toggleCalendar(); };

        // --- Render ---
        const refreshUI = () => {
            const todayLogs = dailyLogs.filter(l=>l.dateStr===currentDate);
            const monthLogs = dailyLogs.filter(l=>l.dateStr.startsWith(currentDate.substring(0,7)));

            // Dashboard Stats
            const kcalIn = todayLogs.reduce((a,b)=>a+(b.kcal||0),0);
            const kcalBurn = todayLogs.reduce((a,b)=>a+(b.burned||0),0);
            const todayTotalSpend = todayLogs.filter(l=>l.type.includes('finance')).reduce((a,b)=>a+(b.amount||0),0);
            
            setText('today-record-sum', `(ç¸½æ”¯å‡º: $${todayTotalSpend})`);
            setText('dash-food', `$${todayTotalSpend}`);
            setText('dash-in', kcalIn);
            setText('dash-burn', kcalBurn);
            setText('dash-remain', userProfile.targetKcal + kcalBurn - kcalIn);
            setText('current-date-display', currentDate);

            const logListHtml = todayLogs.length ? todayLogs.map(l=>`
                <div class="flex justify-between p-3 border-b border-gray-100 text-sm">
                    <div><span class="font-bold text-gray-700">${l.description}</span> <span class="text-xs text-gray-400">${l.category}</span></div>
                    <div class="text-right">
                        ${l.amount > 0 ? `<div class="font-bold">-$${l.amount}</div>` : ''}
                        ${l.kcal ? `<div class="text-[10px] text-green-500">æ” ${l.kcal}</div>` : ''}
                    </div>
                </div>`).join('') : '<div class="text-center text-gray-400 py-4">ç„¡ç´€éŒ„</div>';
            setHTML('log-list', logListHtml);

            const sel = document.getElementById('log-card');
            if(sel) {
                const curr = sel.value;
                sel.innerHTML = accounts.map(a=>`<option value="${a.name}">${a.name} ($${a.balance})</option>`).join('') + '<option value="custom">â• è‡ªè¨‚...</option>';
                if(curr && accounts.find(a=>a.name===curr)) sel.value = curr;
            }

            setHTML('dash-fixed-list', fixedExpenses.map(f => {
                const spentThisMonth = monthLogs.filter(l => l.category === f.name).reduce((a,b) => a + (b.amount||0), 0);
                const remaining = f.amount - spentThisMonth;
                return `<div class="flex justify-between p-2 text-sm border-b items-center"><div><div class="font-medium">${f.name}</div><div class="text-xs text-gray-400">${f.note}</div></div><div class="flex items-center"><div class="text-right mr-3"><div class="text-xs text-gray-400">å‰©é¤˜</div><span class="font-bold cursor-pointer hover:bg-gray-100 px-1 rounded ${remaining < 0 ? 'text-red-500' : 'text-green-600'}" onclick="openInputModal('fixed_edit', ${f.id})">$${remaining}</span></div><button onclick="removeFixed(${f.id})" class="text-red-400 ml-2">Ã—</button></div></div>`;
            }).join(''));

            // Report
            const incomeTotal = Object.values(monthlyIncome).reduce((a,b)=>a+b,0);
            const fixedTotal = fixedExpenses.reduce((a,b)=>a+b.amount,0);
            
            // Logic Fix: Disposable = Income - Fixed Budget
            const disposableIncome = incomeTotal - fixedTotal;
            
            // Logic Fix: Spending outside of fixed budget
            const discretionarySpending = monthLogs.filter(l => l.type.includes('finance') && !fixedExpenses.some(f => f.name === l.category)).reduce((a,b)=>a+(b.amount||0),0);

            const entRatio = userProfile.entRatio || 20;
            const invRatio = 100 - entRatio;
            
            const entBudget = Math.floor(disposableIncome * (entRatio / 100));
            const invBudget = Math.floor(disposableIncome * (invRatio / 100));
            const entSpent = monthLogs.filter(l => l.category === 'å¨›æ¨‚').reduce((a,b) => a + (b.amount||0), 0);
            const invSpent = monthLogs.filter(l => l.category === 'æŠ•è³‡').reduce((a,b) => a + (b.amount||0), 0);

            ['salary','bonus','overtime','oncall'].forEach(k => { const el=document.getElementById(`inc-${k}`); if(el) el.value=monthlyIncome[k]; });
            
            setText('rep-total-inc', `$${incomeTotal.toLocaleString()}`);
            setText('rep-disposable', `$${disposableIncome.toLocaleString()}`);
            setText('rep-final', `$${(disposableIncome - discretionarySpending).toLocaleString()}`);
            
            setText('rep-ent-val', `$${(entBudget - entSpent).toLocaleString()}`);
            setText('rep-ent-label', `å¨›æ¨‚ ${entRatio}% (é ç®—$${entBudget})`);
            
            setText('rep-inv-val', `$${(invBudget - invSpent).toLocaleString()}`);
            setText('rep-inv-label', `æŠ•è³‡ ${invRatio}% (é ç®—$${invBudget})`);

            setText('rep-total-fix', `-$${fixedTotal.toLocaleString()}`);
            
            setHTML('rep-acc-list', accounts.map((a,i)=>`<div class="flex justify-between p-2 text-sm border-b"><span>${a.name}</span><div><span class="font-bold ${a.balance<0?'text-red-500':'text-blue-600'}">$${a.balance}</span> <button onclick="openInputModal('balance',${i})" class="text-gray-400 ml-2">âœ</button></div></div>`).join(''));
            
            setHTML('inv-list', investments.map(i=>`
                <div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-100">
                    <div class="flex justify-between items-start mb-2"><div><span class="bg-blue-100 text-blue-700 font-bold px-2 py-1 rounded text-xs">${i.symbol}</span><span class="text-xs text-gray-400 ml-2">${i.date}</span></div>
                    <button onclick="removeInvestment('${i.id}')" class="text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-gray-200">ğŸ—‘ï¸</button></div>
                    <div class="text-sm font-medium text-gray-800 mb-2">"${i.note}"</div>
                    <div class="text-xs bg-white p-2 rounded border border-indigo-100 text-gray-600 leading-relaxed"><strong class="text-indigo-600 block mb-1">ğŸ¤– AI åˆ†æï¼š</strong>${parseMarkdown(i.feedback)}</div>
                </div>`).join(''));

            setValue('prof-height', userProfile.height);
            setValue('prof-weight', userProfile.weight);
            setValue('ratio-ent', userProfile.entRatio || 20);
            setText('ratio-inv-display', `${100 - (userProfile.entRatio||20)}%`);
            renderCalendar();
        };

        window.removeFixed = (id) => { fixedExpenses = fixedExpenses.filter(f=>f.id!==id); saveData(); };
        window.switchTab = (t) => { document.querySelectorAll('.tab-view').forEach(e=>e.classList.add('hidden')); document.getElementById(`${t}-view`).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('text-blue-600')); document.getElementById(`nav-${t}`).classList.add('text-blue-600'); refreshUI(); };
        window.changeDate = (e) => { currentDate = e.target.value; refreshUI(); };
        window.showToast = (m,t) => { const el=document.getElementById('toast'); el.textContent=m; el.className=`fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full text-white ${t==='error'?'bg-red-500':'bg-black'} z-50`; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),2000); };
        window.changeLogCategory = (v) => { const cardSel = document.getElementById('log-card'); const amtInput = document.getElementById('log-amount'); const btn = document.getElementById('unified-log-btn'); if (v === 'é‹å‹•') { cardSel.disabled = true; amtInput.placeholder = 'ç„¡'; amtInput.value = 0; amtInput.disabled = true; btn.textContent = 'ğŸ”¥ è¨˜éŒ„'; } else { cardSel.disabled = false; amtInput.placeholder = '$'; amtInput.disabled = false; btn.textContent = 'ğŸ’° è¨˜éŒ„'; } };
    </script>
</head>
<body class="bg-gray-50 pb-20 select-none text-gray-800">
    <div id="toast" class="hidden"></div>

    <!-- Modals -->
    <div id="verify-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-xl"><h3 id="verify-title" class="font-bold mb-4 text-lg">ç¢ºèª</h3><div id="verify-inputs"></div><div class="flex gap-2 mt-4"><button onclick="closeModal('verify')" class="flex-1 bg-gray-100 py-2 rounded font-bold text-gray-500">å–æ¶ˆ</button><button onclick="confirmVerifyLog()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold shadow-lg">ç¢ºèªå­˜æª”</button></div></div></div>
    <div id="input-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-xl"><h3 id="input-modal-title" class="font-bold mb-4 text-lg">è¼¸å…¥</h3><div class="mb-3"><div id="input-note-container"><input id="input-note" type="text" class="w-full border p-2 rounded mb-2" placeholder="åç¨±"></div><label id="input-label" class="text-xs text-gray-500">æ•¸å€¼</label><input id="input-value" type="number" class="w-full border p-2 rounded font-bold text-lg"></div><div class="flex gap-2"><button onclick="closeModal('input')" class="flex-1 bg-gray-100 py-2 rounded">å–æ¶ˆ</button><button onclick="submitInputModal()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">ç¢ºå®š</button></div></div></div>

    <!-- Header -->
    <div class="bg-white p-3 shadow-sm sticky top-0 z-20"><div class="flex justify-between items-center"><div class="font-black text-lg">Pocket Coach <span class="text-xs bg-red-100 text-red-600 px-1 rounded">V13.1</span></div><div class="flex items-center gap-2"><span id="current-date-display" class="font-bold text-lg text-gray-700"></span><button onclick="toggleCalendar()" class="bg-gray-100 p-2 rounded-lg text-xs font-bold text-gray-600 flex items-center gap-1">ğŸ“… æœˆæ›†</button></div></div><div id="calendar-wrapper" class="hidden mt-3 border-t pt-2"><div class="flex justify-between items-center mb-2 px-2"><button onclick="prevMonth()" class="text-gray-400 hover:text-black font-bold">â—€</button><span id="current-month-label" class="text-sm font-bold w-20 text-center">...</span><button onclick="nextMonth()" class="text-gray-400 hover:text-black font-bold">â–¶</button></div><div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-400 mb-1"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div><div id="calendar-grid" class="grid grid-cols-7 gap-1"></div></div></div>

    <main class="max-w-md mx-auto p-3">
        <!-- Tab 1: Dashboard -->
        <div id="dashboard-view" class="tab-view">
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="bg-white p-2 rounded-xl border border-blue-100 text-center"><div class="text-[10px] text-gray-400">ä»Šæ—¥æ”¯å‡º</div><div id="dash-food" class="text-xl font-black text-blue-600">$0</div></div>
                <div class="bg-white p-2 rounded-xl border border-green-100 text-center"><div class="text-[10px] text-gray-400">æ”å–</div><div id="dash-in" class="text-xl font-black text-green-600">0</div></div>
                <div class="bg-gray-800 p-2 rounded-xl text-center text-white"><div class="text-[10px] opacity-70">å‰©é¤˜ç†±é‡</div><div id="dash-remain" class="text-xl font-black">1600</div></div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md mb-4 border border-gray-200">
                <div class="flex gap-2 mb-2">
                    <select id="log-category" onchange="changeLogCategory(this.value)" class="bg-gray-50 border p-2 rounded text-sm w-1/3"><option value="é¤è²»">ğŸ± é¤è²»</option><option value="é‹å‹•">ğŸ”¥ é‹å‹•</option><option value="ç”Ÿæ´»">ğŸ§» ç”Ÿæ´»</option><option value="äº¤é€š">ğŸ›µ äº¤é€š</option><option value="å¨›æ¨‚">ğŸ¬ å¨›æ¨‚</option><option value="æŠ•è³‡">ğŸ“ˆ æŠ•è³‡</option><option value="å…¶ä»–">ğŸ“ å…¶ä»–</option></select>
                    <select id="log-card" onchange="if(this.value==='custom') document.getElementById('finance-card-custom').classList.remove('hidden'); else document.getElementById('finance-card-custom').classList.add('hidden')" class="bg-gray-50 border p-2 rounded text-sm w-2/3"></select>
                </div>
                <input id="finance-card-custom" type="text" placeholder="è¼¸å…¥å¸³æˆ¶åç¨±" class="w-full border p-2 rounded text-sm mb-2 hidden">
                <div class="flex items-center gap-2 mb-2">
                     <label class="bg-gray-50 border border-gray-200 rounded-lg p-2 cursor-pointer flex items-center justify-center w-12 hover:bg-gray-100"><input type="file" accept="image/*" capture="camera" onchange="handleImageUpload(event)" class="hidden"><span class="text-xl">ğŸ“·</span></label>
                    <input id="log-description" placeholder="æè¿° (å¦‚: é›è…¿ä¾¿ç•¶)" class="flex-grow border border-gray-200 p-2 rounded text-sm h-10">
                    <input id="log-amount" type="number" placeholder="$" class="w-16 border border-gray-200 p-2 rounded text-center font-bold text-sm h-10">
                </div>
                <div id="image-preview" class="mb-2 flex justify-start"></div>
                <button id="unified-log-btn" onclick="handleUnifiedLog()" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold shadow-lg">ğŸ’° è¨˜éŒ„</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-green-200 p-4 mb-4">
                <h3 class="font-bold text-green-700 text-sm mb-3 flex items-center border-b border-green-100 pb-2"><span class="text-lg mr-2">ğŸ¥—</span> AI ç‡Ÿé¤Šæ•™ç·´</h3>
                <div id="health-chat-box" class="h-40 overflow-y-auto mb-3 text-sm space-y-2 pr-1"><div class="text-center text-gray-300 text-xs py-2">æœ‰ä»€éº¼é£²é£Ÿå•é¡Œæƒ³å•æˆ‘å—ï¼Ÿ</div></div>
                <div class="flex gap-2"><input id="health-chat-input" type="text" placeholder="å•æ•™ç·´..." class="flex-grow bg-gray-50 border rounded-lg px-3 py-2 text-sm outline-none"><button onclick="sendAIChat('health')" class="bg-green-600 text-white px-4 rounded-lg font-bold text-sm shadow-sm active:scale-95">ç™¼é€</button></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-3 mb-4">
                <div class="flex justify-between items-center mb-2"><h3 class="text-xs font-bold text-gray-400">ä»Šæ—¥ç´€éŒ„</h3><span id="today-record-sum" class="text-xs font-bold text-blue-600"></span></div>
                <div id="log-list"></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 border border-red-100">
                <div class="flex justify-between items-center mb-2 border-b pb-2"><h3 class="font-bold text-red-800 text-sm">ğŸ”’ æ¯æœˆå›ºå®šæ”¯å‡º</h3><button onclick="openInputModal('fixed_add')" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">ï¼‹ æ–°å¢</button></div>
                <div id="dash-fixed-list"></div>
            </div>
        </div>

        <!-- Tab 2: Finance -->
        <div id="finance-view" class="tab-view hidden">
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-4 mb-4 text-center">
                <div class="text-sm text-gray-500">å¯æ”¯é…æ‰€å¾— (æ”¶å…¥-å›ºå®š)</div>
                <div id="rep-disposable" class="text-2xl font-black text-blue-600 mb-2">$0</div>
                <div class="flex gap-2 text-xs mb-3">
                    <div class="flex-1 bg-yellow-50 p-1 rounded text-yellow-700"><span id="rep-ent-label">å¨›æ¨‚å‰©é¤˜</span> <span id="rep-ent-val" class="font-bold block text-lg">$0</span></div>
                    <div class="flex-1 bg-green-50 p-1 rounded text-green-700"><span id="rep-inv-label">æŠ•è³‡å‰©é¤˜</span> <span id="rep-inv-val" class="font-bold block text-lg">$0</span></div>
                </div>
                <div class="bg-gray-900 text-white p-3 rounded-lg"><div class="text-xs opacity-70">æœ€çµ‚é¤˜é¡ (å¯æ”¯é… - é¡å¤–æ”¯å‡º)</div><div class="text-lg font-bold"> <span id="rep-final" class="text-xl">$0</span></div></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                <h3 class="font-bold border-b pb-2 mb-2">æ”¶å…¥</h3>
                <div class="grid grid-cols-2 gap-4 text-sm mb-2">
                    <div><span class="text-xs text-gray-400">è–ªæ°´</span> <input id="inc-salary" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','salary')" readonly></div>
                    <div><span class="text-xs text-gray-400">çé‡‘</span> <input id="inc-bonus" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','bonus')" readonly></div>
                    <div><span class="text-xs text-gray-400">åŠ ç­</span> <input id="inc-overtime" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','overtime')" readonly></div>
                    <div><span class="text-xs text-gray-400">OnCall</span> <input id="inc-oncall" type="number" class="w-full border-b font-bold" onclick="openInputModal('income','oncall')" readonly></div>
                </div>
                <div class="flex justify-between font-bold text-green-600 bg-green-50 p-2 rounded"><span>ç¸½è¨ˆ</span><span id="rep-total-inc">$0</span></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-blue-100">
                <div class="flex justify-between border-b pb-2 mb-2"><h3 class="font-bold text-blue-800 text-sm">ğŸ¦ è³‡ç”¢åº«å­˜</h3><button onclick="openInputModal('balance', -1)" class="text-xs text-blue-600">ï¼‹ å¸³æˆ¶</button></div>
                <div id="rep-acc-list"></div>
            </div>
        </div>

        <!-- Tab 3: Investment -->
        <div id="investment-view" class="tab-view hidden">
            <div class="bg-white rounded-xl shadow-sm border border-indigo-200 p-4 mb-4">
                <h3 class="font-bold text-indigo-700 text-sm mb-3 flex items-center border-b border-indigo-100 pb-2"><span class="text-lg mr-2">ğŸ“ˆ</span> æŠ•è³‡é¡§å•</h3>
                <div id="finance-chat-box" class="h-64 overflow-y-auto mb-3 text-sm space-y-2 pr-1"><div class="text-center text-gray-300 text-xs py-2">æˆ‘å¯ä»¥åˆ†ææ‚¨çš„æŒè‚¡ç‹€æ³...</div></div>
                <div class="flex gap-2"><input id="finance-chat-input" type="text" placeholder="å•é¡§å•..." class="flex-grow bg-gray-50 border rounded-lg px-3 py-2 text-sm outline-none"><button onclick="sendAIChat('finance')" class="bg-indigo-600 text-white px-4 rounded-lg font-bold text-sm shadow-sm active:scale-95">ç™¼é€</button></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">æˆ‘çš„æŠ•è³‡ç­†è¨˜</h3>
                <div class="bg-gray-50 p-3 rounded-xl mb-3">
                    <div class="flex gap-2 mb-2"><input id="inv-symbol" type="text" placeholder="ä»£è™Ÿ" class="w-1/3 p-2 rounded border border-gray-200 text-sm"><input id="inv-note" type="text" placeholder="è§€é»" class="w-2/3 p-2 rounded border border-gray-200 text-sm"></div>
                    <button id="inv-add-btn" onclick="addInvestment()" class="w-full bg-gray-800 text-white py-2 rounded-lg text-sm font-bold shadow hover:bg-gray-700">ï¼‹ æ–°å¢</button>
                </div>
                <div id="inv-list"></div>
            </div>
        </div>

        <!-- Tab 4: Settings -->
        <div id="settings-view" class="tab-view hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">è¨­å®š</h3>
                <div class="mb-3">
                    <label class="text-xs text-gray-500">Gemini Model</label>
                    <div class="flex gap-2 mb-2">
                        <select id="setting-model" onchange="handleModelChange(this.value)" class="flex-grow border p-2 rounded bg-white text-sm">
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                            <option value="custom">è‡ªè¨‚ Model ID</option>
                        </select>
                        <button onclick="fetchGoogleModels()" class="bg-gray-100 px-3 rounded border border-gray-300 text-lg hover:bg-gray-200">ğŸ”„</button>
                    </div>
                    <input id="setting-model-custom" type="text" placeholder="Model ID" class="w-full border p-2 rounded bg-gray-50 text-sm mb-2 hidden">
                    <label class="text-xs text-gray-500">API Key</label>
                    <input id="setting-api-key" type="password" class="w-full border p-2 rounded bg-gray-50 text-sm">
                </div>
                <button onclick="saveSystemConfig()" class="w-full bg-gray-800 text-white py-2 rounded-lg font-bold text-sm">å„²å­˜è¨­å®š</button>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <h3 class="font-bold text-gray-800 mb-3 border-b pb-2">ğŸ‘¤ é«”æ…‹ & æ¯”ä¾‹</h3>
                <div class="mb-3 flex gap-2">
                    <input id="prof-height" type="number" placeholder="èº«é«˜" class="w-1/2 border p-2 rounded">
                    <input id="prof-weight" type="number" placeholder="é«”é‡" class="w-1/2 border p-2 rounded">
                </div>
                <div class="mb-3">
                    <label class="text-xs text-yellow-600">å¨›æ¨‚ä½”æ¯” (%)</label>
                    <input id="ratio-ent" type="number" oninput="updateRatioDisplay(this.value)" class="w-full border p-2 rounded text-center text-yellow-700">
                </div>
                <button onclick="updateSettings()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold text-sm">æ›´æ–°è³‡æ–™</button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                <button onclick="exportData()" class="w-full bg-gray-100 text-gray-600 py-2 rounded-lg font-bold text-sm hover:bg-gray-200">åŒ¯å‡ºå‚™ä»½ (JSON)</button>
            </div>
            <div class="text-center mt-8 text-xs text-gray-300">V13.1 Offline Mode</div>
        </div>
    </main>

    <div class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 z-30 pb-6 safe-area-pb">
        <button id="nav-dashboard" onclick="switchTab('dashboard')" class="nav-btn text-blue-600 font-bold text-xs flex flex-col items-center w-1/4"><span class="text-xl">ğŸ </span>é§•é§›è‰™</button>
        <button id="nav-finance" onclick="switchTab('finance')" class="nav-btn text-gray-400 font-bold text-xs flex flex-col items-center w-1/4"><span class="text-xl">ğŸ“Š</span>å ±è¡¨</button>
        <button id="nav-investment" onclick="switchTab('investment')" class="nav-btn text-gray-400 font-bold text-xs flex flex-col items-center w-1/4"><span class="text-xl">ğŸ“ˆ</span>æŠ•è³‡</button>
        <button id="nav-settings" onclick="switchTab('settings')" class="nav-btn text-gray-400 font-bold text-xs flex flex-col items-center w-1/4"><span class="text-xl">âš™ï¸</span>è¨­å®š</button>
    </div>
</body>
</html>
